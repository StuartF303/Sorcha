name: PR Validation - Dependency-Aware Testing

on:
  pull_request:
    branches: [ main, master ]

env:
  DOTNET_VERSION_9: '9.0.x'
  DOTNET_VERSION_10: '10.0.x'

jobs:
  detect-changes:
    name: Detect Changed Components
    runs-on: ubuntu-latest
    outputs:
      cryptography: ${{ steps.filter.outputs.cryptography }}
      transaction-handler: ${{ steps.filter.outputs.transaction-handler }}
      blueprint-models: ${{ steps.filter.outputs.blueprint-models }}
      service-defaults: ${{ steps.filter.outputs.service-defaults }}
      blueprint-fluent: ${{ steps.filter.outputs.blueprint-fluent }}
      blueprint-schemas: ${{ steps.filter.outputs.blueprint-schemas }}
      blueprint-engine: ${{ steps.filter.outputs.blueprint-engine }}
      services: ${{ steps.filter.outputs.services }}
      apps: ${{ steps.filter.outputs.apps }}
      all-changed-files: ${{ steps.filter.outputs.all-changed-files }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect changed files
      id: filter
      run: |
        # Get changed files between base and head
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
        echo "all-changed-files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        # Check each component
        echo "cryptography=$(echo "$CHANGED_FILES" | grep -q "src/Common/Sorcha.Cryptography" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "transaction-handler=$(echo "$CHANGED_FILES" | grep -q "src/Common/Sorcha.TransactionHandler" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "blueprint-models=$(echo "$CHANGED_FILES" | grep -q "src/Common/Sorcha.Blueprint.Models" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "service-defaults=$(echo "$CHANGED_FILES" | grep -q "src/Common/Sorcha.ServiceDefaults" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "blueprint-fluent=$(echo "$CHANGED_FILES" | grep -q "src/Core/Sorcha.Blueprint.Fluent" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "blueprint-schemas=$(echo "$CHANGED_FILES" | grep -q "src/Core/Sorcha.Blueprint.Schemas" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "blueprint-engine=$(echo "$CHANGED_FILES" | grep -q "src/Core/Sorcha.Blueprint.Engine" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "services=$(echo "$CHANGED_FILES" | grep -q "src/Services" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "apps=$(echo "$CHANGED_FILES" | grep -q "src/Apps" && echo "true" || echo "false")" >> $GITHUB_OUTPUT

  # Test Common Components
  test-cryptography:
    name: Test Cryptography + Dependents
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.cryptography == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          ${{ env.DOTNET_VERSION_9 }}
          ${{ env.DOTNET_VERSION_10 }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build Cryptography
      run: dotnet build src/Common/Sorcha.Cryptography --configuration Release --no-restore

    - name: Test Cryptography
      run: dotnet test tests/Sorcha.Cryptography.Tests --configuration Release --no-restore --logger "trx" --collect:"XPlat Code Coverage"

    # Test dependent components (anything that might use Cryptography)
    - name: Test dependent services
      run: |
        dotnet test tests/Sorcha.Peer.Service.Tests --configuration Release --no-restore --logger "trx" || true
        dotnet test tests/Sorcha.Integration.Tests --configuration Release --no-restore --logger "trx" || true

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cryptography-test-results
        path: '**/*.trx'

  test-transaction-handler:
    name: Test TransactionHandler + Dependents
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.transaction-handler == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          ${{ env.DOTNET_VERSION_9 }}
          ${{ env.DOTNET_VERSION_10 }}

    - name: Restore and Build
      run: |
        dotnet restore
        dotnet build src/Common/Sorcha.TransactionHandler --configuration Release --no-restore

    - name: Test TransactionHandler
      run: dotnet test tests/Sorcha.TransactionHandler.Tests --configuration Release --no-restore --logger "trx" --collect:"XPlat Code Coverage"

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: transaction-handler-test-results
        path: '**/*.trx'

  test-blueprint-models:
    name: Test Blueprint.Models + Dependents
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.blueprint-models == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          ${{ env.DOTNET_VERSION_9 }}
          ${{ env.DOTNET_VERSION_10 }}

    - name: Restore and Build
      run: |
        dotnet restore
        dotnet build src/Common/Sorcha.Blueprint.Models --configuration Release --no-restore

    - name: Test Blueprint.Models
      run: dotnet test tests/Sorcha.Blueprint.Models.Tests --configuration Release --no-restore --logger "trx" --collect:"XPlat Code Coverage"

    # Test dependent Core components
    - name: Test Blueprint.Fluent (depends on Models)
      run: dotnet test tests/Sorcha.Blueprint.Fluent.Tests --configuration Release --no-restore --logger "trx" || true

    # Test dependent Services
    - name: Test Blueprint Service (depends on Models)
      run: dotnet test tests/Sorcha.Blueprint.Service.Tests --configuration Release --no-restore --logger "trx" || true

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: blueprint-models-test-results
        path: '**/*.trx'

  test-core-components:
    name: Test Core Components
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.blueprint-fluent == 'true' ||
      needs.detect-changes.outputs.blueprint-schemas == 'true' ||
      needs.detect-changes.outputs.blueprint-engine == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          ${{ env.DOTNET_VERSION_9 }}
          ${{ env.DOTNET_VERSION_10 }}

    - name: Restore and Build
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore

    - name: Test Blueprint.Fluent
      if: needs.detect-changes.outputs.blueprint-fluent == 'true'
      run: dotnet test tests/Sorcha.Blueprint.Fluent.Tests --configuration Release --no-restore --logger "trx" --collect:"XPlat Code Coverage"

    - name: Test Blueprint.Schemas
      if: needs.detect-changes.outputs.blueprint-schemas == 'true'
      run: dotnet test tests/Sorcha.Blueprint.Schemas.Tests --configuration Release --no-restore --logger "trx" --collect:"XPlat Code Coverage"

    - name: Test Blueprint.Engine
      if: needs.detect-changes.outputs.blueprint-engine == 'true'
      run: dotnet test tests/Sorcha.Blueprint.Engine.Tests --configuration Release --no-restore --logger "trx" --collect:"XPlat Code Coverage"

    # Test UI that depends on Core components
    - name: Test UI components
      if: needs.detect-changes.outputs.blueprint-fluent == 'true' || needs.detect-changes.outputs.blueprint-schemas == 'true'
      run: |
        if [ -d "tests/Sorcha.UI.E2E.Tests" ]; then
          dotnet test tests/Sorcha.UI.E2E.Tests --configuration Release --no-restore --logger "trx" || true
        fi

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: core-components-test-results
        path: '**/*.trx'

  test-services:
    name: Test Services
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.services == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION_10 }}

    - name: Restore and Build
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore

    - name: Test Peer Service
      run: dotnet test tests/Sorcha.Peer.Service.Tests --configuration Release --no-restore --logger "trx" --collect:"XPlat Code Coverage" || true

    - name: Test Gateway Integration
      run: dotnet test tests/Sorcha.Gateway.Integration.Tests --configuration Release --no-restore --logger "trx" --collect:"XPlat Code Coverage" || true

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: services-test-results
        path: '**/*.trx'

  test-apps:
    name: Test Applications
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.apps == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION_10 }}

    - name: Restore and Build
      run: |
        dotnet restore
        dotnet build src/Apps --configuration Release --no-restore

    - name: Build AppHost
      run: dotnet build src/Apps/Sorcha.AppHost --configuration Release --no-restore

    - name: Build Blazor Client
      run: dotnet build src/Apps/UI/Sorcha.Blueprint.Designer.Client --configuration Release --no-restore

    - name: Test Integration
      run: dotnet test tests/Sorcha.Integration.Tests --configuration Release --no-restore --logger "trx" --collect:"XPlat Code Coverage" || true

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: apps-test-results
        path: '**/*.trx'

  # Summary job that all tests depend on
  pr-validation-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, test-cryptography, test-transaction-handler, test-blueprint-models, test-core-components, test-services, test-apps]
    if: always()

    steps:
    - name: Check test results
      run: |
        echo "## PR Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Changed Components" >> $GITHUB_STEP_SUMMARY
        echo "- Cryptography: ${{ needs.detect-changes.outputs.cryptography }}" >> $GITHUB_STEP_SUMMARY
        echo "- TransactionHandler: ${{ needs.detect-changes.outputs.transaction-handler }}" >> $GITHUB_STEP_SUMMARY
        echo "- Blueprint.Models: ${{ needs.detect-changes.outputs.blueprint-models }}" >> $GITHUB_STEP_SUMMARY
        echo "- Core Components: ${{ needs.detect-changes.outputs.blueprint-fluent }} / ${{ needs.detect-changes.outputs.blueprint-schemas }} / ${{ needs.detect-changes.outputs.blueprint-engine }}" >> $GITHUB_STEP_SUMMARY
        echo "- Services: ${{ needs.detect-changes.outputs.services }}" >> $GITHUB_STEP_SUMMARY
        echo "- Apps: ${{ needs.detect-changes.outputs.apps }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- Cryptography Tests: ${{ needs.test-cryptography.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- TransactionHandler Tests: ${{ needs.test-transaction-handler.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Blueprint.Models Tests: ${{ needs.test-blueprint-models.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Core Components Tests: ${{ needs.test-core-components.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Services Tests: ${{ needs.test-services.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Apps Tests: ${{ needs.test-apps.result }}" >> $GITHUB_STEP_SUMMARY

    - name: Fail if any required test failed
      if: |
        (needs.test-cryptography.result == 'failure') ||
        (needs.test-transaction-handler.result == 'failure') ||
        (needs.test-blueprint-models.result == 'failure') ||
        (needs.test-core-components.result == 'failure')
      run: |
        echo "::error::One or more required tests failed"
        exit 1
