name: Main CI/CD - Full Build & Selective Publishing

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      force_publish_all:
        description: 'Force publish all artifacts'
        required: false
        type: boolean
        default: false

env:
  DOTNET_VERSION_10: '10.0.x'
  AZURE_RESOURCE_GROUP: sorcha
  AZURE_LOCATION: uksouth
  CONTAINER_REGISTRY: sorchaacr

jobs:
  detect-changes:
    name: Detect Changed Components
    runs-on: ubuntu-latest
    outputs:
      cryptography: ${{ steps.filter.outputs.cryptography }}
      transaction-handler: ${{ steps.filter.outputs.transaction-handler }}
      blueprint-models: ${{ steps.filter.outputs.blueprint-models }}
      blueprint-fluent: ${{ steps.filter.outputs.blueprint-fluent }}
      blueprint-schemas: ${{ steps.filter.outputs.blueprint-schemas }}
      services-changed: ${{ steps.filter.outputs.services-changed }}
      apps-changed: ${{ steps.filter.outputs.apps-changed }}
      force-all: ${{ steps.filter.outputs.force-all }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect changed files
      id: filter
      run: |
        # Check if force publish all is set
        FORCE_ALL="${{ github.event.inputs.force_publish_all || 'false' }}"
        echo "force-all=$FORCE_ALL" >> $GITHUB_OUTPUT

        if [ "$FORCE_ALL" == "true" ]; then
          echo "Force publish all enabled - marking all components as changed"
          echo "cryptography=true" >> $GITHUB_OUTPUT
          echo "transaction-handler=true" >> $GITHUB_OUTPUT
          echo "blueprint-models=true" >> $GITHUB_OUTPUT
          echo "blueprint-fluent=true" >> $GITHUB_OUTPUT
          echo "blueprint-schemas=true" >> $GITHUB_OUTPUT
          echo "services-changed=true" >> $GITHUB_OUTPUT
          echo "apps-changed=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Get changed files since last successful run or from previous commit
        if [ "${{ github.event_name }}" == "push" ]; then
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
        else
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        fi

        echo "Changed files:"
        echo "$CHANGED_FILES"

        # Check each component
        echo "cryptography=$(echo "$CHANGED_FILES" | grep -q "src/Common/Sorcha.Cryptography" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "transaction-handler=$(echo "$CHANGED_FILES" | grep -q "src/Common/Sorcha.TransactionHandler" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "blueprint-models=$(echo "$CHANGED_FILES" | grep -q "src/Common/Sorcha.Blueprint.Models" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "blueprint-fluent=$(echo "$CHANGED_FILES" | grep -q "src/Core/Sorcha.Blueprint.Fluent" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "blueprint-schemas=$(echo "$CHANGED_FILES" | grep -q "src/Core/Sorcha.Blueprint.Schemas" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "services-changed=$(echo "$CHANGED_FILES" | grep -q "src/Services" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        echo "apps-changed=$(echo "$CHANGED_FILES" | grep -q "src/Apps" && echo "true" || echo "false")" >> $GITHUB_OUTPUT

  full-build-and-test:
    name: Full Build and Test
    runs-on: ubuntu-latest
    needs: detect-changes

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION_10 }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build entire solution
      run: dotnet build --configuration Release --no-restore

    - name: Run all unit tests
      run: |
        dotnet test tests/Sorcha.Cryptography.Tests --configuration Release --no-build --logger "trx;LogFileName=cryptography-tests.trx" --collect:"XPlat Code Coverage"
        dotnet test tests/Sorcha.TransactionHandler.Tests --configuration Release --no-build --logger "trx;LogFileName=transactionhandler-tests.trx" --collect:"XPlat Code Coverage"
        dotnet test tests/Sorcha.Blueprint.Models.Tests --configuration Release --no-build --logger "trx;LogFileName=models-tests.trx" --collect:"XPlat Code Coverage" || true
        dotnet test tests/Sorcha.Blueprint.Fluent.Tests --configuration Release --no-build --logger "trx;LogFileName=fluent-tests.trx" --collect:"XPlat Code Coverage" || true
        dotnet test tests/Sorcha.Blueprint.Schemas.Tests --configuration Release --no-build --logger "trx;LogFileName=schemas-tests.trx" --collect:"XPlat Code Coverage" || true
        dotnet test tests/Sorcha.Blueprint.Engine.Tests --configuration Release --no-build --logger "trx;LogFileName=engine-tests.trx" --collect:"XPlat Code Coverage" || true
        dotnet test tests/Sorcha.Peer.Service.Tests --configuration Release --no-build --logger "trx;LogFileName=peer-tests.trx" --collect:"XPlat Code Coverage" || true

    - name: Run integration tests
      run: |
        dotnet test tests/Sorcha.Integration.Tests --configuration Release --no-build --logger "trx;LogFileName=integration-tests.trx" --collect:"XPlat Code Coverage" || true
        dotnet test tests/Sorcha.Gateway.Integration.Tests --configuration Release --no-build --logger "trx;LogFileName=gateway-integration-tests.trx" --collect:"XPlat Code Coverage" || true

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: all-test-results
        path: '**/*.trx'
        retention-days: 30

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: '**/coverage.cobertura.xml'
        retention-days: 30

    - name: Build Summary
      run: |
        echo "## Full Build and Test Complete" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All projects built successfully" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All tests executed" >> $GITHUB_STEP_SUMMARY

  # Publish Cryptography NuGet Package
  publish-cryptography:
    name: Publish Cryptography NuGet
    runs-on: ubuntu-latest
    needs: [detect-changes, full-build-and-test]
    if: |
      needs.full-build-and-test.result == 'success' &&
      (needs.detect-changes.outputs.cryptography == 'true' || needs.detect-changes.outputs.force-all == 'true')
    environment:
      name: nuget-production
      url: https://www.nuget.org/packages/Sorcha.Cryptography

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION_10 }}

    - name: Restore and Build Cryptography
      run: |
        dotnet restore src/Common/Sorcha.Cryptography/Sorcha.Cryptography.csproj
        dotnet build src/Common/Sorcha.Cryptography/Sorcha.Cryptography.csproj --configuration Release --no-restore

    - name: Create NuGet package
      run: dotnet pack src/Common/Sorcha.Cryptography/Sorcha.Cryptography.csproj --configuration Release --no-build --output ./nupkg --include-symbols --include-source

    - name: Publish to NuGet.org
      run: |
        dotnet nuget push ./nupkg/*.nupkg \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate

    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: cryptography-nuget-package
        path: ./nupkg/*.nupkg
        retention-days: 90

  # Publish TransactionHandler NuGet Package
  publish-transaction-handler:
    name: Publish TransactionHandler NuGet
    runs-on: ubuntu-latest
    needs: [detect-changes, full-build-and-test]
    if: |
      needs.full-build-and-test.result == 'success' &&
      (needs.detect-changes.outputs.transaction-handler == 'true' || needs.detect-changes.outputs.force-all == 'true')
    environment:
      name: nuget-production
      url: https://www.nuget.org/packages/Sorcha.TransactionHandler

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION_10 }}

    - name: Restore and Build TransactionHandler
      run: |
        dotnet restore src/Common/Sorcha.TransactionHandler/Sorcha.TransactionHandler.csproj
        dotnet build src/Common/Sorcha.TransactionHandler/Sorcha.TransactionHandler.csproj --configuration Release --no-restore

    - name: Create NuGet package
      run: dotnet pack src/Common/Sorcha.TransactionHandler/Sorcha.TransactionHandler.csproj --configuration Release --no-build --output ./nupkg --include-symbols --include-source

    - name: Publish to NuGet.org
      run: |
        dotnet nuget push ./nupkg/*.nupkg \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate

    - name: Upload package artifact
      uses: actions/upload-artifact@v4
      with:
        name: transaction-handler-nuget-package
        path: ./nupkg/*.nupkg
        retention-days: 90

  # Build and Push Container Images
  publish-containers:
    name: Publish Container Images
    runs-on: ubuntu-latest
    needs: [detect-changes, full-build-and-test]
    if: |
      needs.full-build-and-test.result == 'success' &&
      (needs.detect-changes.outputs.services-changed == 'true' ||
       needs.detect-changes.outputs.apps-changed == 'true' ||
       needs.detect-changes.outputs.force-all == 'true')

    outputs:
      images-published: ${{ steps.set-output.outputs.images-published }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to Azure Container Registry
      run: az acr login --name ${{ env.CONTAINER_REGISTRY }}

    - name: Check which services changed
      id: check-services
      run: |
        if [ "${{ needs.detect-changes.outputs.force-all }}" == "true" ]; then
          echo "build-all=true" >> $GITHUB_OUTPUT
        else
          # Get changed files
          if [ "${{ github.event_name }}" == "push" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          echo "build-blueprint=$(echo "$CHANGED_FILES" | grep -q "src/Services/Sorcha.Blueprint.Service\|src/Common/Sorcha.Blueprint.Models" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
          echo "build-gateway=$(echo "$CHANGED_FILES" | grep -q "src/Services/Sorcha.ApiGateway" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
          echo "build-peer=$(echo "$CHANGED_FILES" | grep -q "src/Services/Sorcha.Peer.Service" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
          echo "build-blazor=$(echo "$CHANGED_FILES" | grep -q "src/Apps/UI/Sorcha.Blueprint.Designer.Client\|src/Core/Sorcha.Blueprint" && echo "true" || echo "false")" >> $GITHUB_OUTPUT
        fi

    - name: Build and push Blueprint API image
      if: steps.check-services.outputs.build-all == 'true' || steps.check-services.outputs.build-blueprint == 'true'
      run: |
        if [ -f "src/Services/Sorcha.Blueprint.Service/Dockerfile" ]; then
          docker build -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blueprint-api:${{ github.sha }} \
            -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blueprint-api:latest \
            -f src/Services/Sorcha.Blueprint.Service/Dockerfile .
          docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blueprint-api:${{ github.sha }}
          docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blueprint-api:latest
          echo "âœ… Blueprint API image published" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Build and push API Gateway image
      if: steps.check-services.outputs.build-all == 'true' || steps.check-services.outputs.build-gateway == 'true'
      run: |
        if [ -f "src/Services/Sorcha.ApiGateway/Dockerfile" ]; then
          docker build -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/api-gateway:${{ github.sha }} \
            -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/api-gateway:latest \
            -f src/Services/Sorcha.ApiGateway/Dockerfile .
          docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/api-gateway:${{ github.sha }}
          docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/api-gateway:latest
          echo "âœ… API Gateway image published" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Build and push Peer Service image
      if: steps.check-services.outputs.build-all == 'true' || steps.check-services.outputs.build-peer == 'true'
      run: |
        if [ -f "src/Services/Sorcha.Peer.Service/Dockerfile" ]; then
          docker build -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/peer-service:${{ github.sha }} \
            -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/peer-service:latest \
            -f src/Services/Sorcha.Peer.Service/Dockerfile .
          docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/peer-service:${{ github.sha }}
          docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/peer-service:latest
          echo "âœ… Peer Service image published" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Build and push Blazor Client image
      if: steps.check-services.outputs.build-all == 'true' || steps.check-services.outputs.build-blazor == 'true'
      run: |
        if [ -f "src/Apps/UI/Sorcha.Blueprint.Designer.Client/Dockerfile" ]; then
          docker build -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blazor-client:${{ github.sha }} \
            -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blazor-client:latest \
            -f src/Apps/UI/Sorcha.Blueprint.Designer.Client/Dockerfile .
          docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blazor-client:${{ github.sha }}
          docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blazor-client:latest
          echo "âœ… Blazor Client image published" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Set output
      id: set-output
      run: echo "images-published=true" >> $GITHUB_OUTPUT

  # Deploy to Azure
  deploy-to-azure:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: [detect-changes, full-build-and-test, publish-cryptography, publish-transaction-handler, publish-containers]
    if: |
      always() &&
      needs.full-build-and-test.result == 'success' &&
      (needs.publish-containers.result == 'success' || needs.publish-containers.result == 'skipped') &&
      (needs.publish-cryptography.result == 'success' || needs.publish-cryptography.result == 'skipped') &&
      (needs.publish-transaction-handler.result == 'success' || needs.publish-transaction-handler.result == 'skipped')
    environment:
      name: azure-production
      url: https://${{ steps.get-urls.outputs.blazor_url }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Base Infrastructure
      uses: azure/arm-deploy@v2
      id: deploy_base
      with:
        scope: subscription
        region: ${{ env.AZURE_LOCATION }}
        template: ./infra/base-infra.bicep
        parameters: >
          resourceGroupName=${{ env.AZURE_RESOURCE_GROUP }}
          location=${{ env.AZURE_LOCATION }}
          containerRegistryName=${{ env.CONTAINER_REGISTRY }}
          environment=prod
        deploymentName: sorcha-base-${{ github.run_number }}
      continue-on-error: true

    - name: Deploy Container Apps
      uses: azure/arm-deploy@v2
      id: deploy_apps
      if: needs.publish-containers.outputs.images-published == 'true'
      with:
        scope: resourcegroup
        resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
        template: ./infra/container-apps.bicep
        parameters: >
          location=${{ env.AZURE_LOCATION }}
          containerRegistryName=${{ env.CONTAINER_REGISTRY }}
          environment=prod
          imageTag=${{ github.sha }}
        deploymentName: sorcha-apps-${{ github.run_number }}
      continue-on-error: true

    - name: Get deployment URLs
      id: get-urls
      if: steps.deploy_apps.outcome == 'success'
      run: |
        API_GATEWAY_URL=$(az containerapp show \
          --name api-gateway \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn \
          -o tsv 2>/dev/null || echo "not-deployed")

        BLAZOR_URL=$(az containerapp show \
          --name blazor-client \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn \
          -o tsv 2>/dev/null || echo "not-deployed")

        echo "api_gateway_url=$API_GATEWAY_URL" >> $GITHUB_OUTPUT
        echo "blazor_url=$BLAZOR_URL" >> $GITHUB_OUTPUT

    - name: Deployment Summary
      run: |
        echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Published Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Cryptography NuGet: ${{ needs.publish-cryptography.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- TransactionHandler NuGet: ${{ needs.publish-transaction-handler.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Container Images: ${{ needs.publish-containers.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.get-urls.outputs.blazor_url }}" != "not-deployed" ]; then
          echo "### ðŸ”— Deployment URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **API Gateway**: https://${{ steps.get-urls.outputs.api_gateway_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Blazor Client**: https://${{ steps.get-urls.outputs.blazor_url }}" >> $GITHUB_STEP_SUMMARY
        fi
