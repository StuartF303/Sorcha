name: Azure Deployment

on:
  workflow_run:
    workflows: ["Build and Test"]
    types:
      - completed
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip test verification (use with caution)'
        required: false
        type: boolean
        default: false

env:
  DOTNET_VERSION: '10.0.x'
  AZURE_RESOURCE_GROUP: sorcha
  AZURE_LOCATION: uksouth
  CONTAINER_REGISTRY: sorchaacr

jobs:
  # Verify the build-test workflow succeeded before deploying
  check-build-success:
    name: Verify Build Success
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && !inputs.skip_tests

    steps:
    - name: Check build workflow result
      if: github.event.workflow_run.conclusion != 'success'
      run: |
        echo "::error::Build and Test workflow failed or was cancelled. Deployment aborted."
        echo "Build Status: ${{ github.event.workflow_run.conclusion }}"
        exit 1

    - name: Build succeeded
      run: |
        echo "âœ… Build and Test workflow succeeded"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref }}"

  # Deploy infrastructure and applications to Azure
  deploy-azure:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: check-build-success
    if: |
      always() &&
      (needs.check-build-success.result == 'success' ||
       needs.check-build-success.result == 'skipped') &&
      (github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    # STEP 1: Deploy base infrastructure (Resource Group, ACR, Redis, Environment)
    # This creates ACR so we can push images to it
    - name: Deploy Base Infrastructure
      uses: azure/arm-deploy@v2
      id: deploy_base
      with:
        scope: subscription
        region: ${{ env.AZURE_LOCATION }}
        template: ./infra/base-infra.bicep
        parameters: >
          resourceGroupName=${{ env.AZURE_RESOURCE_GROUP }}
          location=${{ env.AZURE_LOCATION }}
          containerRegistryName=${{ env.CONTAINER_REGISTRY }}
          environment=prod
        deploymentName: sorcha-base-${{ github.run_number }}

    # STEP 2: Build and push Docker images to ACR (now that ACR exists)
    - name: Login to Azure Container Registry
      run: |
        az acr login --name ${{ env.CONTAINER_REGISTRY }}

    - name: Build and push Blueprint API image
      run: |
        docker build -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blueprint-api:${{ github.sha }} \
          -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blueprint-api:latest \
          -f src/Services/Sorcha.Blueprint.Service/Dockerfile .
        docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blueprint-api:${{ github.sha }}
        docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blueprint-api:latest

    - name: Build and push API Gateway image
      run: |
        docker build -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/api-gateway:${{ github.sha }} \
          -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/api-gateway:latest \
          -f src/Services/Sorcha.ApiGateway/Dockerfile .
        docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/api-gateway:${{ github.sha }}
        docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/api-gateway:latest

    - name: Build and push Peer Service image
      run: |
        docker build -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/peer-service:${{ github.sha }} \
          -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/peer-service:latest \
          -f src/Services/Sorcha.Peer.Service/Dockerfile .
        docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/peer-service:${{ github.sha }}
        docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/peer-service:latest

    - name: Build and push Blazor Client image
      run: |
        docker build -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blazor-client:${{ github.sha }} \
          -t ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blazor-client:latest \
          -f src/Apps/UI/Sorcha.Blueprint.Designer.Client/Dockerfile .
        docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blazor-client:${{ github.sha }}
        docker push ${{ env.CONTAINER_REGISTRY }}.azurecr.io/blazor-client:latest

    # STEP 3: Deploy Container Apps (now that images exist in ACR)
    - name: Deploy Container Apps
      uses: azure/arm-deploy@v2
      id: deploy_apps
      with:
        scope: resourcegroup
        resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
        template: ./infra/container-apps.bicep
        parameters: >
          location=${{ env.AZURE_LOCATION }}
          containerRegistryName=${{ env.CONTAINER_REGISTRY }}
          environment=prod
          imageTag=${{ github.sha }}
        deploymentName: sorcha-apps-${{ github.run_number }}

    - name: Get deployment URLs
      id: get_urls
      run: |
        API_GATEWAY_URL=$(az containerapp show \
          --name api-gateway \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn \
          -o tsv)

        BLAZOR_URL=$(az containerapp show \
          --name blazor-client \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn \
          -o tsv)

        echo "API Gateway: https://$API_GATEWAY_URL"
        echo "Blazor Client: https://$BLAZOR_URL"

        echo "api_gateway_url=https://$API_GATEWAY_URL" >> $GITHUB_OUTPUT
        echo "blazor_url=https://$BLAZOR_URL" >> $GITHUB_OUTPUT

    - name: Deployment Summary
      run: |
        echo "## ðŸš€ Azure Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Deployment URLs" >> $GITHUB_STEP_SUMMARY
        echo "- **API Gateway**: ${{ steps.get_urls.outputs.api_gateway_url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Blazor Client**: ${{ steps.get_urls.outputs.blazor_url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Deployed Images" >> $GITHUB_STEP_SUMMARY
        echo "- blueprint-api: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- api-gateway: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- peer-service: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- blazor-client: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
