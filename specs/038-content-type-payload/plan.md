# Implementation Plan: Content-Type Aware Payload Encoding

**Branch**: `038-content-type-payload` | **Date**: 2026-02-21 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/038-content-type-payload/spec.md`

## Summary

Add `ContentType` (MIME string) and `ContentEncoding` (encoding scheme) metadata fields to transaction payloads. Migrate all binary-to-text encoding from standard Base64 to Base64url (RFC 4648 Section 5) across 24 source files (124 call sites). Optimize MongoDB storage with BSON Binary for binary payload fields (~33% reduction). Support native JSON embedding for unencrypted JSON payloads and Brotli/Gzip compression for payloads over 4KB. Full backward compatibility with legacy Base64-encoded transactions. Extensive cryptographic conformance testing to verify encoding changes preserve all cryptographic guarantees.

## Technical Context

**Language/Version**: C# 13 / .NET 10.0
**Primary Dependencies**: System.Buffers.Text.Base64Url (built-in), System.IO.Compression (BrotliStream, GZipStream), MongoDB.Driver (existing), Sorcha.Cryptography (existing)
**Storage**: MongoDB (Register), PostgreSQL (Wallet/Tenant — not affected), Redis (cache — not affected)
**Testing**: xUnit 3.2.2, FluentAssertions 8.8.0, Moq 4.20.72
**Target Platform**: Linux containers / Windows (Docker + Aspire)
**Project Type**: Distributed microservices (existing codebase modification)
**Performance Goals**: Zero regression on transaction throughput. ~33% MongoDB storage reduction for binary fields. 70-80% compression on JSON payloads >4KB.
**Constraints**: Full backward compatibility with existing Base64-encoded transactions. No data migration scripts. Rolling deployment safe.
**Scale/Scope**: 24 source files modified, 124 Base64 call sites migrated, 3-4 new internal types, 1 new service interface, extensive test coverage.

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Microservices-First | PASS | BSON Binary optimization is internal to MongoRegisterRepository. IRegisterRepository interface unchanged. No new cross-service dependencies. |
| II. Security First | PASS | Cryptographic operations unchanged — hashes computed on canonical bytes, not encodings. Extensive conformance testing (FR-020–024). Base64url eliminates `+` character hash fragility. |
| III. API Documentation | PASS | New `ContentType`/`ContentEncoding` fields documented in PayloadModel. No new endpoints — extends existing models. |
| IV. Testing Requirements | PASS | Conformance test suite covers all encoding × crypto combinations (≥20 scenarios). Known test vectors for determinism. Legacy + new interop tests. Target >85% coverage on new code. |
| V. Code Quality | PASS | Uses .NET 10 built-in `Base64Url` class. Async patterns maintained. Nullable reference types on new fields. |
| VI. Blueprint Creation Standards | N/A | No blueprint changes. |
| VII. Domain-Driven Design | PASS | `PayloadType` (Sorcha semantic) retained alongside `ContentType` (data format) — clear separation of concerns. |
| VIII. Observability by Default | PASS | No new services. Existing logging/telemetry applies. |

**Gate result**: ALL PASS — no violations requiring justification.

## Project Structure

### Documentation (this feature)

```text
specs/038-content-type-payload/
├── plan.md              # This file
├── research.md          # Phase 0 output — Base64 call sites, API availability, design decisions
├── data-model.md        # Phase 1 output — entity changes, state transitions, relationships
├── quickstart.md        # Phase 1 output — implementation order, key decisions, file risk map
├── contracts/           # Phase 1 output
│   ├── encoding-helper.md   # IPayloadEncodingService contract
│   ├── payload-model.md     # PayloadModel extensions + JSON examples
│   └── mongo-storage.md     # MongoPayloadDocument + conversion contract
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── Common/
│   ├── Sorcha.Register.Models/
│   │   ├── PayloadModel.cs              # Add ContentType, ContentEncoding properties
│   │   └── Challenge.cs                 # No structural changes (encoding in serializer)
│   ├── Sorcha.TransactionHandler/
│   │   ├── Models/PayloadInfo.cs        # Add ContentType, ContentEncoding properties
│   │   ├── Payload/PayloadManager.cs    # Content-type awareness, compression
│   │   ├── Serialization/
│   │   │   └── JsonTransactionSerializer.cs  # Base64url migration (core)
│   │   └── Services/
│   │       ├── IPayloadEncodingService.cs    # NEW: centralized encoding contract
│   │       └── PayloadEncodingService.cs     # NEW: implementation
│   └── Sorcha.Cryptography/            # Base64url for key material encoding
├── Core/
│   └── Sorcha.Register.Storage.MongoDB/
│       ├── Models/
│       │   ├── MongoPayloadDocument.cs      # NEW: BSON Binary payload model
│       │   ├── MongoChallengeDocument.cs    # NEW: BSON Binary challenge model
│       │   └── MongoTransactionDocument.cs  # NEW: BSON Binary transaction model
│       ├── Mappers/
│       │   └── MongoDocumentMapper.cs       # NEW: PayloadModel <-> MongoPayloadDocument
│       └── MongoRegisterRepository.cs       # BSON Binary read/write + legacy detection
├── Services/
│   ├── Sorcha.Blueprint.Service/
│   │   ├── Services/Interfaces/
│   │   │   └── ITransactionBuilderService.cs  # Base64url for signatures, payloads
│   │   └── Program.cs                        # Base64url for genesis TX
│   ├── Sorcha.Register.Service/
│   │   └── Services/RegisterCreationOrchestrator.cs  # Base64url for genesis TX
│   └── Sorcha.Validator.Service/
│       └── Services/
│           ├── ValidationEngine.cs            # Base64url decode + decompress for schema
│           ├── DocketBuildTriggerService.cs    # Base64url for register model
│           └── DocketSerializer.cs            # Base64url for docket serialization

tests/
├── Sorcha.TransactionHandler.Tests/
│   ├── PayloadEncodingServiceTests.cs     # NEW: encode/decode/compress/legacy tests
│   └── JsonTransactionSerializerTests.cs  # Extended: Base64url + ContentType
├── Sorcha.Register.Storage.MongoDB.Tests/
│   ├── MongoDocumentMapperTests.cs        # NEW: conversion + legacy detection
│   └── MongoRegisterRepositoryTests.cs    # Extended: BSON Binary storage
├── Sorcha.Cryptography.Tests/
│   └── EncodingConformanceTests.cs        # NEW: cross-encoding crypto conformance
├── Sorcha.Blueprint.Service.Tests/
│   └── TransactionBuilderServiceTests.cs  # Extended: Base64url signatures
└── Sorcha.Validator.Service.Tests/
    └── ValidationEngineTests.cs           # Extended: decompress + schema validation
```

**Structure Decision**: Existing microservices architecture — no new projects. New types are internal to existing projects. `IPayloadEncodingService` lives in `Sorcha.TransactionHandler` (shared library consumed by Blueprint, Validator, and Register services). MongoDB internal types live in `Sorcha.Register.Storage.MongoDB`.

## Complexity Tracking

> No constitution violations to justify. All changes fit within existing architecture.

| Aspect | Assessment |
|--------|-----------|
| New types | 4 internal (MongoPayloadDocument, MongoChallengeDocument, MongoTransactionDocument, MongoDocumentMapper) + 1 shared service (IPayloadEncodingService). All within existing projects. |
| Cross-cutting migration | 124 call sites across 24 files. Mitigated by centralized `IPayloadEncodingService` and incremental file-by-file migration with per-file tests. |
| Backward compatibility | Legacy detection in MongoRegisterRepository (BsonString vs BsonBinaryData) and encoding fallback (null ContentEncoding → Base64). No migration scripts. |
| Risk areas | JsonTransactionSerializer and PayloadManager are the highest-risk files — core serialization paths. Extensive conformance tests gate these changes. |
