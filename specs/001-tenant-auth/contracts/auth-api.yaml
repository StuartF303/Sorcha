openapi: 3.1.0
info:
  title: Sorcha Tenant Service - Authentication API
  version: 1.0.0
  description: |
    OAuth2/OIDC authentication endpoints for user and PassKey authentication.
    Supports external IDP integration (Azure Entra, AWS Cognito, generic OIDC) and FIDO2/WebAuthn PassKey authentication.
  contact:
    name: Sorcha API Support
    url: https://sorcha.io/support

servers:
  - url: https://tenant.sorcha.io/api/auth
    description: Production
  - url: https://localhost:7080/api/auth
    description: Local Development

tags:
  - name: OAuth2
    description: OAuth2/OIDC authentication flows
  - name: PassKey
    description: FIDO2/WebAuthn PassKey authentication
  - name: Tokens
    description: Token management (refresh, revocation, validation)

paths:
  /login:
    get:
      summary: Initiate OAuth2 login flow
      description: |
        Redirects user to their organization's external IDP for authentication.
        Organization is determined by subdomain (org.sorcha.io) or query parameter.
      tags: [OAuth2]
      parameters:
        - name: org
          in: query
          description: Organization identifier (subdomain or UUID)
          required: false
          schema:
            type: string
            example: acme
        - name: return_url
          in: query
          description: URL to redirect after successful authentication
          required: false
          schema:
            type: string
            format: uri
            example: https://app.sorcha.io/dashboard
      responses:
        '302':
          description: Redirect to external IDP authorization endpoint
          headers:
            Location:
              schema:
                type: string
                format: uri
              description: External IDP authorization URL
        '400':
          description: Invalid organization identifier
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Organization not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /callback:
    get:
      summary: OAuth2 callback endpoint
      description: |
        Handles callback from external IDP after user authentication.
        Exchanges authorization code for tokens and issues Sorcha JWT.
      tags: [OAuth2]
      parameters:
        - name: code
          in: query
          description: Authorization code from IDP
          required: true
          schema:
            type: string
        - name: state
          in: query
          description: State parameter for CSRF protection
          required: true
          schema:
            type: string
        - name: session_state
          in: query
          description: Session state from IDP (optional)
          required: false
          schema:
            type: string
      responses:
        '302':
          description: Redirect to application with JWT token
          headers:
            Location:
              schema:
                type: string
                format: uri
              description: Return URL with token in query or fragment
            Set-Cookie:
              schema:
                type: string
              description: HTTP-only cookie with refresh token
        '400':
          description: Invalid authorization code or state mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: External IDP error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /logout:
    post:
      summary: Logout and revoke tokens
      description: |
        Invalidates user's access and refresh tokens, redirects to IDP logout if supported.
      tags: [OAuth2]
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                return_url:
                  type: string
                  format: uri
                  description: URL to redirect after logout
                  example: https://sorcha.io
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logout successful
                  idp_logout_url:
                    type: string
                    format: uri
                    description: External IDP logout URL (optional)
                    example: https://login.microsoftonline.com/logout
        '401':
          description: Unauthorized (invalid or expired token)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /passkey/register-options:
    post:
      summary: Get PassKey registration options
      description: |
        Generates FIDO2 registration challenge and options for new PassKey registration.
      tags: [PassKey]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  description: User-friendly identifier (email or username)
                  example: user@example.com
                displayName:
                  type: string
                  description: User display name
                  example: John Doe
              required:
                - username
                - displayName
      responses:
        '200':
          description: Registration options generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PassKeyRegistrationOptions'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /passkey/register:
    post:
      summary: Complete PassKey registration
      description: |
        Verifies PassKey registration attestation and stores credential.
      tags: [PassKey]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PassKeyRegistrationResponse'
      responses:
        '200':
          description: PassKey registered successfully, JWT token issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: Invalid attestation or challenge mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /passkey/authentication-options:
    post:
      summary: Get PassKey authentication options
      description: |
        Generates FIDO2 assertion challenge for PassKey authentication.
      tags: [PassKey]
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  description: User identifier (optional, for autofill)
                  example: user@example.com
      responses:
        '200':
          description: Authentication options generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PassKeyAuthenticationOptions'

  /passkey/authenticate:
    post:
      summary: Complete PassKey authentication
      description: |
        Verifies PassKey assertion signature and issues JWT token.
      tags: [PassKey]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PassKeyAuthenticationResponse'
      responses:
        '200':
          description: Authentication successful, JWT token issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: Invalid signature or challenge mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /token/refresh:
    post:
      summary: Refresh access token
      description: |
        Exchanges refresh token for a new access token without re-authentication.
      tags: [Tokens]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token:
                  type: string
                  description: Refresh token from initial authentication
                  example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
              required:
                - refresh_token
      responses:
        '200':
          description: New access token issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /token/validate:
    post:
      summary: Validate JWT token
      description: |
        Validates token signature, expiration, and revocation status.
        Used by other services to verify tokens.
      tags: [Tokens]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
                  description: JWT access token
                  example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
              required:
                - token
      responses:
        '200':
          description: Token is valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: true
                  claims:
                    $ref: '#/components/schemas/TokenClaims'
        '400':
          description: Token is invalid, expired, or revoked
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: Token has expired

  /token/service:
    post:
      summary: Issue service token (client credentials)
      description: |
        Issues JWT token for service-to-service authentication.
        Requires service client credentials.
      tags: [Tokens]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                grant_type:
                  type: string
                  enum: [client_credentials]
                  example: client_credentials
                client_id:
                  type: string
                  description: Service client ID
                  example: service-blueprint
                client_secret:
                  type: string
                  description: Service client secret
                  example: secret-value-here
                scope:
                  type: string
                  description: Requested scopes (space-separated)
                  example: wallet:sign register:commit
              required:
                - grant_type
                - client_id
                - client_secret
      responses:
        '200':
          description: Service token issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Invalid client credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /.well-known/jwks.json:
    get:
      summary: JSON Web Key Set (JWKS)
      description: |
        Public keys for validating JWT signatures.
        Other services use this endpoint to fetch public keys.
      tags: [Tokens]
      responses:
        '200':
          description: JWKS public key set
          content:
            application/json:
              schema:
                type: object
                properties:
                  keys:
                    type: array
                    items:
                      type: object
                      properties:
                        kty:
                          type: string
                          example: RSA
                        use:
                          type: string
                          example: sig
                        kid:
                          type: string
                          example: key-id-2024-11
                        alg:
                          type: string
                          example: RS256
                        n:
                          type: string
                          description: RSA modulus
                        e:
                          type: string
                          description: RSA exponent

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from /login, /passkey/authenticate, or /token/refresh

  schemas:
    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
          description: JWT access token (1-hour lifetime)
          example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
        refresh_token:
          type: string
          description: Refresh token (24-hour lifetime, optional)
          example: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
          description: Access token lifetime in seconds
          example: 3600
        scope:
          type: string
          description: Granted scopes (space-separated)
          example: openid profile email

    TokenClaims:
      type: object
      properties:
        sub:
          type: string
          description: Subject (user or service ID)
          example: user-uuid-here
        iss:
          type: string
          description: Issuer (Tenant Service URL)
          example: https://tenant.sorcha.io
        aud:
          type: array
          items:
            type: string
          description: Audience (allowed services)
          example: [https://blueprint.sorcha.io, https://wallet.sorcha.io]
        exp:
          type: integer
          description: Expiration timestamp (Unix epoch)
          example: 1700000000
        iat:
          type: integer
          description: Issued at timestamp (Unix epoch)
          example: 1699996400
        jti:
          type: string
          description: Token ID (for revocation)
          example: token-uuid-here
        org_id:
          type: string
          description: Organization UUID (null for public users)
          example: org-uuid-here
        org_name:
          type: string
          description: Organization name
          example: Acme Corp
        roles:
          type: array
          items:
            type: string
          description: User roles
          example: [member]
        permitted_blockchains:
          type: array
          items:
            type: string
          description: Accessible blockchain IDs
          example: [blockchain-id-1, blockchain-id-2]
        can_create_blockchain:
          type: boolean
          example: false
        can_publish_blueprint:
          type: boolean
          example: true
        token_type:
          type: string
          enum: [user, service, delegated]
          example: user

    PassKeyRegistrationOptions:
      type: object
      properties:
        challenge:
          type: string
          description: Base64url-encoded challenge
          example: dGVzdC1jaGFsbGVuZ2U
        rp:
          type: object
          properties:
            name:
              type: string
              example: Sorcha
            id:
              type: string
              example: sorcha.io
        user:
          type: object
          properties:
            id:
              type: string
              description: Base64url-encoded user ID
              example: dXNlci11dWlk
            name:
              type: string
              example: user@example.com
            displayName:
              type: string
              example: John Doe
        pubKeyCredParams:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                example: public-key
              alg:
                type: integer
                example: -7
        timeout:
          type: integer
          description: Timeout in milliseconds
          example: 60000
        attestation:
          type: string
          enum: [none, indirect, direct]
          example: none
        authenticatorSelection:
          type: object
          properties:
            authenticatorAttachment:
              type: string
              enum: [platform, cross-platform]
              example: platform
            userVerification:
              type: string
              enum: [required, preferred, discouraged]
              example: preferred
            residentKey:
              type: string
              enum: [required, preferred, discouraged]
              example: preferred

    PassKeyRegistrationResponse:
      type: object
      properties:
        id:
          type: string
          description: Base64url-encoded credential ID
        rawId:
          type: string
          description: Base64url-encoded raw credential ID
        response:
          type: object
          properties:
            attestationObject:
              type: string
              description: Base64url-encoded attestation object
            clientDataJSON:
              type: string
              description: Base64url-encoded client data JSON
        type:
          type: string
          example: public-key

    PassKeyAuthenticationOptions:
      type: object
      properties:
        challenge:
          type: string
          description: Base64url-encoded challenge
          example: dGVzdC1jaGFsbGVuZ2U
        timeout:
          type: integer
          description: Timeout in milliseconds
          example: 60000
        rpId:
          type: string
          example: sorcha.io
        allowCredentials:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                example: public-key
              id:
                type: string
                description: Base64url-encoded credential ID
        userVerification:
          type: string
          enum: [required, preferred, discouraged]
          example: preferred

    PassKeyAuthenticationResponse:
      type: object
      properties:
        id:
          type: string
          description: Base64url-encoded credential ID
        rawId:
          type: string
          description: Base64url-encoded raw credential ID
        response:
          type: object
          properties:
            authenticatorData:
              type: string
              description: Base64url-encoded authenticator data
            clientDataJSON:
              type: string
              description: Base64url-encoded client data JSON
            signature:
              type: string
              description: Base64url-encoded signature
            userHandle:
              type: string
              description: Base64url-encoded user handle (optional)
        type:
          type: string
          example: public-key

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error code
          example: invalid_request
        error_description:
          type: string
          description: Human-readable error message
          example: The 'code' parameter is required
        error_uri:
          type: string
          description: URI with error details (optional)
          example: https://docs.sorcha.io/errors/invalid_request
