# Implementation Plan: Blueprint Template Library & Ping-Pong Blueprint

**Branch**: `027-blueprint-template-library` | **Date**: 2026-02-08 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/027-blueprint-template-library/spec.md`

## Summary

Establish a local blueprint template store with automatic startup seeding, create a Ping-Pong blueprint template demonstrating two-participant cyclic workflows, modify the publish-time cycle detection to warn instead of reject, build a template library UI page, and verify the full action execution pipeline end-to-end with a walkthrough script.

## Technical Context

**Language/Version**: C# 13 / .NET 10
**Primary Dependencies**: Sorcha.Blueprint.Models, Sorcha.Blueprint.Engine, Sorcha.Blueprint.Service, Sorcha.UI.Core, MudBlazor
**Storage**: In-memory (BlueprintTemplateService), embedded JSON template files
**Testing**: xUnit + FluentAssertions + Moq (unit), PowerShell walkthrough scripts (E2E)
**Target Platform**: Linux Docker containers (services), Browser WASM (UI)
**Project Type**: Distributed web application (microservices + Blazor WASM)
**Performance Goals**: Template seeding < 5s, UI page load < 2s
**Constraints**: No new database dependencies, no new NuGet packages
**Scale/Scope**: 4 built-in templates, 1 new UI page, ~8 modified files, ~4 new files

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Microservices-First | PASS | Changes are within Blueprint Service boundary; UI is separate |
| II. Security First | PASS | No sensitive data; template payloads are unencrypted demo data |
| III. API Documentation | PASS | Existing endpoints have OpenAPI docs; new seed endpoint will follow pattern |
| IV. Testing Requirements | PASS | Unit tests for seeding + cycle warning; E2E walkthrough for pipeline |
| V. Code Quality | PASS | Async/await, DI, nullable enabled, no warnings |
| VI. Blueprint Creation Standards | PASS | Ping-Pong is a JSON file (primary format per constitution); not Fluent API |
| VII. Domain-Driven Design | PASS | Uses canonical terms: Blueprint, Action, Participant, Disclosure |
| VIII. Observability | PASS | Structured logging for seeding and cycle warnings |

**Post-design re-check**: All gates still pass. Cycle detection change is a behavior modification within existing service, not a new architectural pattern.

## Project Structure

### Documentation (this feature)

```text
specs/027-blueprint-template-library/
├── spec.md
├── plan.md              # This file
├── research.md          # Phase 0: cycle detection, routing, seeding research
├── data-model.md        # Phase 1: Ping-Pong blueprint JSON, entity model
├── quickstart.md        # Phase 1: quick test guide
├── contracts/
│   └── api-contracts.md # Phase 1: endpoint contracts and flow
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
# New files
examples/templates/ping-pong-template.json                          # Ping-Pong blueprint JSON
src/Services/Sorcha.Blueprint.Service/Templates/TemplateSeedingService.cs  # IHostedService for startup seeding
src/Apps/Sorcha.UI/Sorcha.UI.Web.Client/Pages/Templates.razor      # Template library page
walkthroughs/PingPong/test-ping-pong-workflow.ps1                   # E2E walkthrough script

# Modified files
src/Services/Sorcha.Blueprint.Service/Program.cs                   # Cycle detection → warning, seed endpoint, DI registration
src/Services/Sorcha.Blueprint.Service/Templates/BlueprintTemplateService.cs  # Seed method support
src/Apps/Sorcha.UI/Sorcha.UI.Web.Client/Layout/NavMenu.razor       # Add Templates nav link
tests/Sorcha.Blueprint.Service.Tests/                              # Template seeding tests, cycle warning tests
```

**Structure Decision**: This feature modifies existing services and UI — no new projects needed. The Ping-Pong template is a JSON file in `examples/templates/` alongside the existing three example templates. The seeding service lives in the Blueprint Service's `Templates/` folder. The UI page goes in the existing Web Client pages folder.

## Complexity Tracking

No constitution violations to justify. All changes are within existing project boundaries.

## Design Decisions

### D1: Cycle Detection → Warning (not rejection)

**Change**: `PublishService.ValidateBlueprint()` in Program.cs separates cycle errors from other validation errors. Cycles produce warnings returned in the publish response but do not block publication. The blueprint's `Metadata` dictionary gets `hasCycles = "true"` added automatically.

**Impact**: 1 file modified (Program.cs), ~15 lines changed. Existing tests for other validation rules remain unchanged; new test for cycle warning behavior.

### D2: Template Seeding via IHostedService

**Pattern**: `TemplateSeedingService : IHostedService` reads JSON template files from embedded resources at startup. Calls `IBlueprintTemplateService.SaveTemplateAsync()` for each template not already present. Idempotent — checks by template ID before saving.

**Templates seeded**: 4 total (ping-pong + 3 existing examples: approval, loan, supply-chain).

### D3: Ping-Pong as Direct Blueprint (not JSON-e template)

The Ping-Pong blueprint has no parameters — it's a fixed structure with two participants and two actions. It's stored as a `BlueprintTemplate` wrapper with `Template` containing the raw blueprint JSON and `ParameterSchema = null`. The evaluate endpoint returns the blueprint as-is (no JSON-e substitution needed).

### D4: UI Template Library Page

Composes existing `TemplateList` and `TemplateEvaluator` components into a routable page at `/templates`. Adds a template detail panel showing participants, actions, and data schema. "Use Template" button navigates to instance creation.

## Implementation Phases

### Phase 1: Core Blueprint & Cycle Fix (P1 — prerequisite for everything)

1. Create `examples/templates/ping-pong-template.json` with the Ping-Pong blueprint
2. Modify `PublishService.ValidateBlueprint()` — cycle detection returns warnings, not errors
3. Add `PublishResult.Warnings` property to carry warnings through the publish response
4. Update publish endpoint to return warnings in response body
5. Unit tests: cycle warning behavior, publish succeeds with cyclic blueprint

### Phase 2: Template Seeding (P3 — enables template availability)

6. Create `TemplateSeedingService` hosted service
7. Embed template JSON files as resources (or read from well-known path)
8. Register service in DI (`Program.cs`)
9. Add optional `POST /api/templates/seed` admin endpoint
10. Unit tests: seeding idempotency, template loading

### Phase 3: UI Template Library (P2 — browsing and selection)

11. Create `Templates.razor` page in Sorcha.UI.Web.Client
12. Add template detail panel with participant/action preview
13. Add "Use Template" → instance creation flow
14. Add nav menu link
15. Verify templates appear from seeded data

### Phase 4: End-to-End Verification (P1 — validates everything)

16. Create `walkthroughs/PingPong/test-ping-pong-workflow.ps1` script
17. Test full flow: auth → template browse → create blueprint → publish → create instance → execute Ping → execute Pong → repeat 5 times
18. Verify payload integrity through the pipeline
19. Docker rebuild and walkthrough execution
20. Update MASTER-TASKS.md

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Cycle detection change breaks existing tests | Low | Medium | Run full Blueprint Service test suite before/after change |
| Template seeding fails on Docker startup | Low | Medium | Graceful error handling in hosted service; templates still loadable via API |
| Action execution pipeline has bugs with cyclic routes | Medium | High | Walkthrough script validates 5+ round-trips; engine already handles cycles at runtime |
| UI components don't compose well for template library | Low | Low | Existing TemplateList/TemplateEvaluator already work; page is composition only |
