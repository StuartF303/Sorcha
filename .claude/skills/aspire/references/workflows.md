# Aspire Workflows Reference

## Contents
- Adding a New Service
- Debugging with Aspire
- Running Without Aspire
- Deployment Preparation
- Troubleshooting

---

## Adding a New Service

### Workflow Checklist

Copy this checklist and track progress:
- [ ] Create service project with Aspire reference
- [ ] Add `AddServiceDefaults()` in Program.cs
- [ ] Add `MapDefaultEndpoints()` after build
- [ ] Register in AppHost with dependencies
- [ ] Configure JWT if service needs auth
- [ ] Test health endpoints respond

### Step 1: Create Service Project

```bash
dotnet new webapi -n Sorcha.MyService -o src/Services/Sorcha.MyService
dotnet add src/Services/Sorcha.MyService reference src/Common/Sorcha.ServiceDefaults
```

### Step 2: Configure Program.cs

```csharp
// src/Services/Sorcha.MyService/Program.cs
var builder = WebApplication.CreateBuilder(args);

// CRITICAL: Add service defaults first
builder.AddServiceDefaults();

// Add any Aspire resources by name (must match AppHost)
builder.AddRedisDistributedCache("redis");

// Add services, authentication, etc.
builder.Services.AddOpenApi();

var app = builder.Build();

// CRITICAL: Map health endpoints
app.MapDefaultEndpoints();

app.MapOpenApi();
app.Run();
```

### Step 3: Register in AppHost

```csharp
// src/Apps/Sorcha.AppHost/AppHost.cs
var myService = builder.AddProject<Projects.Sorcha_MyService>("my-service")
    .WithReference(redis)
    .WithEnvironment("JwtSettings__SigningKey", jwtSigningKey);
```

### Step 4: Verify Health

```bash
# Start Aspire
dotnet run --project src/Apps/Sorcha.AppHost

# Check service health
curl http://localhost:7xxx/health
curl http://localhost:7xxx/alive
```

---

## Debugging with Aspire

### Starting the Dashboard

```bash
# Start all services with Aspire orchestration
dotnet run --project src/Apps/Sorcha.AppHost

# Dashboard available at:
# http://localhost:18888
```

### Viewing Traces

1. Open Aspire Dashboard at `http://localhost:18888`
2. Click "Traces" in sidebar
3. Filter by service name or trace ID
4. Expand spans to see timing

### Attaching Debugger

1. Start AppHost: `dotnet run --project src/Apps/Sorcha.AppHost`
2. In VS Code/Visual Studio: Debug → Attach to Process
3. Select the service process (e.g., `Sorcha.Blueprint.Service`)
4. Set breakpoints and trigger requests

### Viewing Service Logs

```bash
# In Aspire dashboard: Click service → Logs tab
# Or via CLI during development:
dotnet run --project src/Services/Sorcha.Blueprint.Service
```

---

## Running Without Aspire

### Docker Compose Mode

```bash
# Start infrastructure and services
docker-compose up -d

# Access points:
# - API Gateway:      http://localhost:80
# - Admin UI:         http://localhost/admin
# - Aspire Dashboard: Not available in Docker mode
```

### Configuration Differences

| Setting | Aspire Mode | Docker Mode |
|---------|-------------|-------------|
| Redis | `builder.AddRedisDistributedCache("redis")` | `appsettings.json` connection string |
| Service URLs | Auto-discovered | Hardcoded in `appsettings.json` |
| JWT Key | Generated by AppHost | Must provide `JWTSETTINGS__SIGNINGKEY` env var |
| Ports | 7000-7290 | 5000-5290 (or as configured) |

### Standalone Service Testing

```bash
# Run single service without Aspire
cd src/Services/Sorcha.Blueprint.Service
dotnet run

# Requires local Redis and configuration
# ConnectionStrings__redis=localhost:6379
```

---

## Deployment Preparation

### Production Configuration

```csharp
// Remove development UIs in production AppHost
#if DEBUG
var postgres = builder.AddPostgres("postgres").WithPgAdmin();
var redis = builder.AddRedis("redis").WithRedisCommander();
#else
var postgres = builder.AddPostgres("postgres");
var redis = builder.AddRedis("redis");
#endif
```

### Kubernetes Deployment

Aspire generates Kubernetes manifests:

```bash
# Generate manifests
dotnet aspire publish -o ./k8s-manifests

# Apply to cluster
kubectl apply -f ./k8s-manifests/
```

### Health Check Requirements

```csharp
// Production health checks should verify dependencies
builder.Services.AddHealthChecks()
    .AddCheck("self", () => HealthCheckResult.Healthy(), ["live"])
    .AddRedis(connectionString)
    .AddNpgSql(connectionString)
    .AddMongoDb(connectionString);
```

---

## Troubleshooting

### Service Shows Unhealthy

**Symptoms:** Aspire dashboard shows red status

**Diagnose:**
```bash
# Check health endpoint directly
curl http://localhost:7000/health

# Check logs
dotnet run --project src/Services/Sorcha.Blueprint.Service 2>&1
```

**Common Causes:**
1. Missing `app.MapDefaultEndpoints()` in Program.cs
2. Database connection failing
3. Redis not available

### Connection String Not Found

**Symptoms:** `InvalidOperationException: No connection string named 'redis'`

**Diagnose:**
1. Verify AppHost has `.WithReference(redis)` for the service
2. Check resource name matches: `AddRedis("redis")` → `AddRedisDistributedCache("redis")`

**Fix:**
```csharp
// AppHost - ensure reference exists
var myService = builder.AddProject<Projects.MyService>("my-service")
    .WithReference(redis);  // This injects ConnectionStrings__redis
```

### Service Can't Find Another Service

**Symptoms:** `HttpRequestException` when calling other services

**Diagnose:**
```csharp
// Check if service discovery is configured
builder.Services.ConfigureHttpClientDefaults(http =>
{
    http.AddServiceDiscovery();  // Required!
});
```

**Fix:**
1. Ensure `AddServiceDefaults()` is called
2. Add `.WithReference(targetService)` in AppHost
3. Use service name as hostname: `http://wallet-service/api/wallets`

### Port Already in Use

**Symptoms:** `System.IO.IOException: Failed to bind to address`

**Fix:**
```bash
# Find process using port
netstat -ano | findstr :7000

# Kill process or change port in launchSettings.json
```

### JWT Authentication Failing Between Services

**Symptoms:** 401 Unauthorized on service-to-service calls

**Diagnose:**
1. Check all services have same `JwtSettings__SigningKey`
2. Verify `JwtSettings__Issuer` matches token issuer
3. Check `JwtSettings__Audience` includes calling service

**Fix:**
```csharp
// AppHost - ensure consistent JWT config
.WithEnvironment("JwtSettings__SigningKey", jwtSigningKey)  // Same key everywhere
.WithEnvironment("JwtSettings__Issuer", "https://localhost:7110")
.WithEnvironment("JwtSettings__Audience", "https://sorcha.local")
```

---

## Iterate-Until-Pass Pattern

For service registration validation:

1. Add service to AppHost
2. Run: `dotnet run --project src/Apps/Sorcha.AppHost`
3. Check dashboard at `http://localhost:18888`
4. If service shows unhealthy:
   - Check logs in dashboard
   - Fix configuration
   - Restart AppHost (Ctrl+C, re-run)
5. Repeat until all services show healthy