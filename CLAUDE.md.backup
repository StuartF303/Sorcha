# Sorcha

A distributed ledger platform for secure, multi-participant data flow orchestration built on .NET 10 and .NET Aspire.

Sorcha reimagines data governance through the **DAD** (Disclosure, Alteration, Destruction) security model - creating cryptographically secured registers where disclosure is managed through defined schemas, alteration is recorded on immutable ledgers, and destruction risk is eliminated through peer network replication.

**Current Status:** 98% MVD Complete | Production Readiness: 30%

---

## Tech Stack

| Layer | Technology | Version | Purpose |
|-------|------------|---------|---------|
| Runtime | .NET | 10.0 | LTS runtime with latest C# features |
| Orchestration | .NET Aspire | 13.0+ | Service discovery, health checks, telemetry |
| API | Minimal APIs | - | Modern, lightweight REST endpoints |
| Real-time | SignalR | - | WebSocket notifications with Redis backplane |
| Databases | PostgreSQL/MongoDB/Redis | 17/8/8 | Relational, document, and cache storage |
| Auth | JWT Bearer | - | Service-to-service and user authentication |
| Crypto | NBitcoin | - | HD wallets (BIP32/39/44), multi-algorithm signing |
| Testing | xUnit + FluentAssertions | - | Unit and integration testing |
| Docs | Scalar.AspNetCore | 2.12+ | Interactive OpenAPI documentation |

---

## Quick Start

```bash
# Prerequisites: .NET 10 SDK, Docker Desktop

# Clone and start all services
git clone https://github.com/StuartF303/Sorcha.git
cd Sorcha
docker-compose up -d

# Access points:
# - API Gateway:       http://localhost:80
# - Register Service:  http://localhost:5290
# - Aspire Dashboard:  http://localhost:18888

# Run walkthrough tests
pwsh walkthroughs/RegisterCreationFlow/test-register-creation-docker.ps1

# After code changes, rebuild a service:
docker-compose build register-service && docker-compose up -d --force-recreate register-service
```

**Alternative: Run with .NET Aspire** (for debugging with breakpoints):
```bash
dotnet run --project src/Apps/Sorcha.AppHost
# Aspire Dashboard: http://localhost:18888
# Services available on HTTPS ports (7000-7290)
```

**Build and Test:**
```bash
dotnet restore && dotnet build
dotnet test
dotnet format  # Before committing
```

---

## Project Structure

```
Sorcha/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Apps/
â”‚   â”‚   â”œâ”€â”€ Sorcha.AppHost/           # .NET Aspire orchestrator
â”‚   â”‚   â”œâ”€â”€ Sorcha.Cli/               # Administrative CLI tool
â”‚   â”‚   â”œâ”€â”€ Sorcha.Admin/             # Blazor WASM admin UI
â”‚   â”‚   â””â”€â”€ Sorcha.UI/                # Main UI application
â”‚   â”œâ”€â”€ Common/
â”‚   â”‚   â”œâ”€â”€ Sorcha.Blueprint.Models/  # Domain models with JSON-LD
â”‚   â”‚   â”œâ”€â”€ Sorcha.Cryptography/      # Multi-algorithm crypto (ED25519, P-256, RSA)
â”‚   â”‚   â”œâ”€â”€ Sorcha.ServiceClients/    # Consolidated HTTP/gRPC clients
â”‚   â”‚   â”œâ”€â”€ Sorcha.ServiceDefaults/   # Aspire shared configuration
â”‚   â”‚   â””â”€â”€ Sorcha.TransactionHandler/ # Transaction building/serialization
â”‚   â”œâ”€â”€ Core/
â”‚   â”‚   â”œâ”€â”€ Sorcha.Blueprint.Engine/  # Portable execution engine (WASM-compatible)
â”‚   â”‚   â”œâ”€â”€ Sorcha.Blueprint.Fluent/  # Fluent API for blueprints
â”‚   â”‚   â””â”€â”€ Sorcha.Register.Core/     # Ledger business logic
â”‚   â””â”€â”€ Services/
â”‚       â”œâ”€â”€ Sorcha.ApiGateway/        # YARP reverse proxy
â”‚       â”œâ”€â”€ Sorcha.Blueprint.Service/ # Workflow management (100%)
â”‚       â”œâ”€â”€ Sorcha.Register.Service/  # Distributed ledger (100%)
â”‚       â”œâ”€â”€ Sorcha.Wallet.Service/    # Crypto wallet management (95%)
â”‚       â”œâ”€â”€ Sorcha.Tenant.Service/    # Multi-tenant auth (85%)
â”‚       â”œâ”€â”€ Sorcha.Peer.Service/      # P2P network (70%)
â”‚       â””â”€â”€ Sorcha.Validator.Service/ # Blockchain consensus (95%)
â”œâ”€â”€ tests/                            # Test projects (30 projects, ~1,100+ tests)
â”œâ”€â”€ docs/                             # Technical documentation (80+ files)
â”œâ”€â”€ .specify/                         # Spec-Kit specifications (150+ files)
â”œâ”€â”€ walkthroughs/                     # Runnable demo scripts
â””â”€â”€ .claude/                          # Claude Code configuration
    â”œâ”€â”€ commands/                     # Spec-Kit skills (9 commands)
    â””â”€â”€ settings.local.json           # Permission config
```

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin UI   â”‚â”€â”€â”€â”€â–¶â”‚   API Gateway   â”‚â”€â”€â”€â”€â–¶â”‚  Blueprint Svc   â”‚
â”‚  (Blazor)   â”‚     â”‚    (YARP)       â”‚     â”‚  (Workflows)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚        â”‚                â”‚
              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”
              â”‚  Wallet   â”‚   â”‚ Register  â”‚â—€â”€â”˜  â”‚  Validator  â”‚
              â”‚  Service  â”‚   â”‚  Service  â”‚     â”‚   Service   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚               â”‚                  â”‚
              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
              â”‚PostgreSQL â”‚   â”‚  MongoDB  â”‚     â”‚   Redis   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Flows:**
- **Blueprint Execution:** Submit action â†’ Validate schema â†’ Apply JSON Logic â†’ Route to next participant â†’ Sign with wallet â†’ Store on register
- **Service Communication:** HTTP via ServiceClients (gRPC planned, Peer Service uses gRPC)
- **Real-time Updates:** SignalR hubs on Blueprint (`/actionshub`) and Register (`/hubs/register`) services with Redis backplane

---

## Development Guidelines

### Code Style

**File Naming:** PascalCase for C# files (e.g., `WalletManager.cs`, `IActionStore.cs`)

**Code Naming:**
- Classes/Interfaces: `PascalCase` (interfaces prefixed with `I`)
- Methods/Properties: `PascalCase`
- Parameters/Variables: `camelCase`
- Private fields: `_camelCase`
- Constants: `PascalCase`
- Async methods: Suffix with `Async` (e.g., `CreateWalletAsync`)

**Folder Structure for Services:**
```
Services/
â”œâ”€â”€ Interfaces/           # IWalletService.cs, IKeyManagementService.cs
â””â”€â”€ Implementation/       # WalletManager.cs, KeyManagementService.cs
```

**Test Naming Convention:**
```csharp
// Pattern: MethodName_Scenario_ExpectedBehavior
[Fact]
public async Task ValidateAsync_ValidData_ReturnsValid() { }

[Fact]
public void Build_WithoutTitle_ThrowsInvalidOperationException() { }
```

**Import Order:**
```csharp
using System.Text.Json;           // 1. System
using Microsoft.Extensions.DI;    // 2. Microsoft
using FluentAssertions;           // 3. Third-party
using Sorcha.Blueprint.Models;    // 4. Project
```

**License Header (Required):**
```csharp
// SPDX-License-Identifier: MIT
// Copyright (c) 2025 Sorcha Contributors
```

**XML Documentation (Required for public APIs):**
```csharp
/// <summary>
/// Creates a new wallet with a randomly generated mnemonic.
/// </summary>
/// <param name="name">Wallet name</param>
/// <returns>Created wallet and mnemonic (MUST be saved by caller)</returns>
public async Task<(Wallet, Mnemonic)> CreateWalletAsync(string name) { }
```

### Critical Patterns

**1. Use .NET 10 OpenAPI with Scalar (NOT Swagger):**
```csharp
app.MapPost("/api/wallets", async (CreateWalletRequest request) => { })
    .WithName("CreateWallet")
    .WithSummary("Create a new wallet");
```

**2. Use Consolidated Service Clients:**
```csharp
// Always use Sorcha.ServiceClients - NEVER create duplicate clients
builder.Services.AddServiceClients(builder.Configuration);
```

**3. Create Blueprints as JSON/YAML (NOT Fluent API):**
```json
{
  "title": "Purchase Order",
  "participants": [{ "id": "buyer", "name": "Buyer Organization" }],
  "actions": [{ "id": 0, "title": "Submit Order", "sender": "buyer" }]
}
```

**4. JsonSchema.Net Validation:**
```csharp
// CRITICAL: Evaluate() expects JsonElement, not JsonNode
JsonElement element = JsonSerializer.Deserialize<JsonElement>(json);
var result = schema.Evaluate(element);
```

**5. Dependency Injection Pattern:**
```csharp
// Constructor injection with null checks
public WalletManager(
    IKeyManagementService keyManagement,
    IWalletRepository repository,
    ILogger<WalletManager> logger)
{
    _keyManagement = keyManagement ?? throw new ArgumentNullException(nameof(keyManagement));
    _repository = repository ?? throw new ArgumentNullException(nameof(repository));
    _logger = logger ?? throw new ArgumentNullException(nameof(logger));
}
```

**6. Service Registration Pattern:**
```csharp
// In Program.cs - register interfaces with implementations
builder.Services.AddScoped<IWalletService, WalletManager>();
builder.Services.AddSingleton<IWalletRepository, InMemoryWalletRepository>();
```

---

## Available Commands

| Command | Description |
|---------|-------------|
| `docker-compose up -d` | Start all services (recommended) |
| `docker-compose logs -f <service>` | View service logs |
| `dotnet run --project src/Apps/Sorcha.AppHost` | Start with Aspire (debugging) |
| `dotnet test` | Run all tests |
| `dotnet test --filter "FullyQualifiedName~Blueprint"` | Run filtered tests |
| `dotnet format` | Format code |
| `pwsh scripts/rebuild-service.ps1 <name>` | Rebuild Docker service |

---

## Port Configuration

| Service | Docker | Aspire (HTTPS) |
|---------|--------|----------------|
| Blueprint | 5000 | 7000 |
| Wallet | (internal) | 7001 |
| Register | 5290 | 7290 |
| Tenant | 5110 | 7110 |
| API Gateway | 80/443 | 7082 |
| Peer (gRPC) | 5002 | 7002 |
| Aspire Dashboard | 18888 | 18888 |

**Infrastructure (Docker):**
| Service | Port |
|---------|------|
| PostgreSQL | 5432 |
| MongoDB | 27017 |
| Redis | 6379 |

See @docs/PORT-CONFIGURATION.md for complete reference.

---

## Testing

```bash
dotnet test                                           # All tests
dotnet test --collect:"XPlat Code Coverage"          # With coverage
dotnet test tests/Sorcha.Blueprint.Service.Tests     # Specific project
```

**Coverage Requirements:** Core libraries >85%, Services >80%

**Test Frameworks:**
- xUnit (primary), FluentAssertions (assertions), Moq (mocking)
- Testcontainers (integration), NBomber (performance), Playwright (E2E)

---

## Key Documentation

| Document | Purpose |
|----------|---------|
| @.specify/constitution.md | Architectural principles and non-negotiable standards |
| @.specify/MASTER-PLAN.md | Implementation phases and priorities |
| @.specify/AI-CODE-DOCUMENTATION-POLICY.md | **MANDATORY** documentation requirements |
| @docs/development-status.md | Current completion status (98% MVD) |
| @docs/PORT-CONFIGURATION.md | Service port assignments |
| @docs/AUTHENTICATION-SETUP.md | JWT configuration guide |
| @docs/architecture.md | System architecture diagrams |

---

## AI Assistant Requirements

### MANDATORY Documentation Updates

When generating ANY code, update these documents:

1. **.specify/MASTER-TASKS.md** - Update task status (ğŸ“‹ â†’ ğŸš§ â†’ âœ…)
2. **README files** - Update if features/APIs changed
3. **docs/ files** - Update architecture/status if changed
4. **OpenAPI/XML docs** - Ensure all endpoints documented

**PRs without documentation updates will NOT be approved.**

### DO

- Read @.specify/constitution.md before coding
- Check @.specify/MASTER-TASKS.md for task priorities
- Follow established patterns in existing code
- Write tests alongside code (>85% coverage)
- Use .NET 10 OpenAPI (NOT Swagger/Swashbuckle)
- Reference task IDs in commits

### DON'T

- Generate code without updating documentation
- Skip writing tests
- Create duplicate service clients (use Sorcha.ServiceClients)
- Commit secrets or sensitive data
- Use Swagger/Swashbuckle
- Ignore the constitution's principles
- Use `JsonNode` with JsonSchema.Net (use `JsonElement`)

---

### Walkthroughs

When creating demos or test scripts:
```
walkthroughs/
â””â”€â”€ YourWalkthroughName/
    â”œâ”€â”€ README.md              # Overview and instructions
    â”œâ”€â”€ test-*.ps1             # Test scripts
    â””â”€â”€ *-RESULTS.md           # Results and findings
```

See @walkthroughs/README.md for guidelines.

---

## Claude Code Skills

Spec-Kit skills available via `.claude/commands/`:

| Command | Purpose |
|---------|---------|
| `/speckit.specify` | Create/update feature specification |
| `/speckit.plan` | Generate implementation plan |
| `/speckit.tasks` | Generate task list |
| `/speckit.implement` | Execute implementation |
| `/speckit.clarify` | Ask clarification questions |
| `/speckit.analyze` | Cross-artifact analysis |

---

## Current Status

| Service | Status | Tests | Notes |
|---------|--------|-------|-------|
| Blueprint Service | 100% | 123 | Full orchestration, SignalR, JWT auth |
| Register Service | 100% | 112 | 20 REST endpoints, OData, SignalR |
| Wallet Service | 95% | 111 | EF Core, JWT auth, all crypto ops |
| Validator Service | 95% | 80%+ | Consensus, memory pool, gRPC |
| Tenant Service | 85% | 67 | Auth flows, 91% test pass rate |
| Peer Service | 70% | - | Hub connection, replication, heartbeat |

**Pending for Production:**
- Database migrations for production deployment
- Azure Key Vault integration
- API Gateway JWT validation
- Security hardening (rate limiting)

---

## Security Guidelines

**DO:**
- Use `Sorcha.Cryptography` for all crypto operations (ED25519, P-256, RSA-4096)
- Use environment variables for secrets
- Encrypt sensitive data at rest (AES-256-GCM)
- Use TLS for all communication

**DON'T:**
- Commit secrets, keys, or credentials
- Store mnemonics (user responsibility to backup)
- Log sensitive data (keys, passwords)

---

## Commit Format

```
feat: [TASK-ID] - Brief description

- Implementation details
- Documentation updated: README.md, MASTER-TASKS.md

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

---

**Version:** 2.2 | **Updated:** 2026-01-17 | Built with .NET 10 and .NET Aspire

---

*This document serves as the primary context for AI assistants. Rules (coding conventions) and Skills (workflow guides) are derived from patterns documented here.*
