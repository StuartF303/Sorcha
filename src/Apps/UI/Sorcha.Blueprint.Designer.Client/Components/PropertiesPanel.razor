@using Sorcha.Blueprint.Designer.Client.Models
@using Sorcha.Blueprint.Models
@using System.Text.Json.Nodes
@using BlueprintAction = Sorcha.Blueprint.Models.Action

<div class="properties-panel">
    <div class="properties-panel-header">
        <div class="d-flex align-center justify-space-between" style="width: 100%;">
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@(SelectedNode != null ? Icons.Material.Filled.PlayArrow : Icons.Material.Filled.Description)" Size="Size.Small" Class="mr-2" />
                @(SelectedNode != null && SelectedNode is ActionNodeModel actionModel ? $"Action {actionModel.Action.Id} Properties" : "Blueprint Properties")
            </MudText>
            <div>
                <MudIconButton Icon="@Icons.Material.Filled.Save"
                               Color="Color.Success"
                               Size="Size.Small"
                               OnClick="SaveChanges"
                               Title="Save changes" />
                <MudIconButton Icon="@Icons.Material.Filled.Close"
                               Color="Color.Default"
                               Size="Size.Small"
                               OnClick="DiscardChanges"
                               Title="@(SelectedNode != null ? "Close and return to Blueprint" : "Discard changes")" />
            </div>
        </div>
    </div>

    <div class="properties-panel-content">
        @if (SelectedNode != null && SelectedNode is ActionNodeModel actionNode)
        {
            <!-- Basic Information -->
            <MudText Typo="Typo.subtitle1" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
                Basic Information
            </MudText>

            <MudTextField @bind-Value="editedAction.Title"
                         Label="Title"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Class="mb-3" />

            <MudTextField @bind-Value="editedAction.Description"
                         Label="Description"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Lines="3"
                         Class="mb-3" />

            <MudTextField @bind-Value="editedAction.Sender"
                         Label="Sender Address"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Class="mb-3"
                         HelperText="Address of the sender (participant)" />

            <MudDivider Class="my-4" />

            <!-- Expandable Sections -->
            <MudExpansionPanels MultiExpansion="true" Class="mb-3">
                <!-- Participants Section -->
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" Size="Size.Small" />
                            <MudText>Participants</MudText>
                            @if (editedAction.Participants != null)
                            {
                                <MudChip T="string" Size="Size.Small" Class="ml-2">@editedAction.Participants.Count()</MudChip>
                            }
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                            Reference participants from the blueprint's global participant list
                        </MudText>

                        @if (Blueprint != null && Blueprint.Participants.Any())
                        {
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Available Participants</MudText>
                            @foreach (var participant in Blueprint.Participants)
                            {
                                <MudChip T="string"
                                         Size="Size.Small"
                                         Color="Color.Info"
                                         Class="mb-1 mr-1">
                                    @participant.Name
                                </MudChip>
                            }

                            <MudDivider Class="my-3" />

                            <MudText Typo="Typo.subtitle2" Class="mb-2">Action Participants (Conditions)</MudText>
                            @if (editedAction.Participants != null && editedAction.Participants.Any())
                            {
                                @foreach (var participant in editedAction.Participants.Select((p, i) => new { Participant = p, Index = i }))
                                {
                                    <MudPaper Class="pa-3 mb-2" Outlined="true">
                                        <MudTextField @bind-Value="@participant.Participant.Principal"
                                                      Label="Principal (Participant ID/Name)"
                                                      Variant="Variant.Outlined"
                                                      Class="mb-2"
                                                      Margin="Margin.Dense"
                                                      HelperText="Reference a participant from the list above" />
                                        <MudText Typo="Typo.caption" Class="mb-1">Criteria (JSON Logic)</MudText>
                                        @foreach (var criteria in participant.Participant.Criteria.Select((c, ci) => new { Criteria = c, Index = ci }))
                                        {
                                            <MudTextField Value="@criteria.Criteria"
                                                          Variant="Variant.Outlined"
                                                          Class="mb-1"
                                                          Margin="Margin.Dense"
                                                          ReadOnly="true" />
                                        }
                                    </MudPaper>
                                }
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Dense="true">No participant conditions defined for this action</MudAlert>
                            }
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Warning" Dense="true">
                                No participants defined in blueprint. Go to Blueprint Properties → Participants tab to add participants.
                            </MudAlert>
                        }
                    </ChildContent>
                </MudExpansionPanel>

                <!-- Routing Condition Section -->
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.AccountTree" Class="mr-2" Size="Size.Small" />
                            <MudText>Routing Condition</MudText>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                            JSON Logic condition that determines the next action in the workflow
                        </MudText>
                        <MudTextField Value="@editedAction.Condition?.ToJsonString()"
                                      Label="Condition (JSON Logic)"
                                      Variant="Variant.Outlined"
                                      Lines="5"
                                      ReadOnly="true"
                                      HelperText="Advanced: Edit via code or condition builder (coming soon)" />
                    </ChildContent>
                </MudExpansionPanel>

                <!-- Calculations Section -->
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Calculate" Class="mr-2" Size="Size.Small" />
                            <MudText>Calculations</MudText>
                            @if (editedAction.Calculations != null)
                            {
                                <MudChip T="string" Size="Size.Small" Class="ml-2">@editedAction.Calculations.Count</MudChip>
                            }
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                            User-defined calculations performed on submitted data using JSON Logic
                        </MudText>
                        @if (editedAction.Calculations != null && editedAction.Calculations.Any())
                        {
                            @foreach (var calc in editedAction.Calculations)
                            {
                                <MudPaper Class="pa-3 mb-2" Outlined="true">
                                    <MudText Typo="Typo.subtitle2">@calc.Key</MudText>
                                    <MudTextField Value="@calc.Value.ToJsonString()"
                                                  Variant="Variant.Outlined"
                                                  Lines="3"
                                                  Margin="Margin.Dense"
                                                  ReadOnly="true"
                                                  Class="mt-1" />
                                </MudPaper>
                            }
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Dense="true">No calculations defined</MudAlert>
                        }
                    </ChildContent>
                </MudExpansionPanel>

                <!-- Data Schemas Section -->
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Schema" Class="mr-2" Size="Size.Small" />
                            <MudText>Data Schemas</MudText>
                            @if (editedAction.DataSchemas != null)
                            {
                                <MudChip T="string" Size="Size.Small" Class="ml-2">@editedAction.DataSchemas.Count()</MudChip>
                            }
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                            Reference data schemas from the blueprint's global schema list
                        </MudText>

                        @if (Blueprint != null && Blueprint.DataSchemas != null && Blueprint.DataSchemas.Any())
                        {
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Available Schemas (@Blueprint.DataSchemas.Count)</MudText>
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                                @Blueprint.DataSchemas.Count schema(s) defined in blueprint. Configure in Blueprint Properties → Data Schemas tab.
                            </MudAlert>

                            <MudDivider Class="my-3" />

                            <MudText Typo="Typo.subtitle2" Class="mb-2">Action Data Schemas</MudText>
                            @if (editedAction.DataSchemas != null && editedAction.DataSchemas.Any())
                            {
                                <MudAlert Severity="Severity.Success" Dense="true">
                                    This action uses @editedAction.DataSchemas.Count() schema(s)
                                </MudAlert>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Dense="true">
                                    No data schemas assigned to this action
                                </MudAlert>
                            }
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Warning" Dense="true">
                                No data schemas defined in blueprint. Go to Blueprint Properties → Data Schemas tab to add schemas.
                            </MudAlert>
                        }
                    </ChildContent>
                </MudExpansionPanel>

                <!-- Disclosures Section -->
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Visibility" Class="mr-2" Size="Size.Small" />
                            <MudText>Disclosures</MudText>
                            @if (editedAction.Disclosures != null)
                            {
                                <MudChip T="string" Size="Size.Small" Class="ml-2">@editedAction.Disclosures.Count()</MudChip>
                            }
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                            Define which data fields are disclosed to which participants
                        </MudText>
                        @if (editedAction.Disclosures != null && editedAction.Disclosures.Any())
                        {
                            @foreach (var disclosure in editedAction.Disclosures.Select((d, i) => new { Disclosure = d, Index = i }))
                            {
                                <MudPaper Class="pa-3 mb-2" Outlined="true">
                                    <MudTextField @bind-Value="@disclosure.Disclosure.ParticipantAddress"
                                                  Label="Participant Address"
                                                  Variant="Variant.Outlined"
                                                  Class="mb-2"
                                                  Margin="Margin.Dense" />
                                    <MudText Typo="Typo.caption" Class="mb-1">Data Pointers</MudText>
                                    @foreach (var pointer in disclosure.Disclosure.DataPointers)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="mb-1 mr-1">
                                            @pointer
                                        </MudChip>
                                    }
                                </MudPaper>
                            }
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Dense="true">No disclosures defined</MudAlert>
                        }
                    </ChildContent>
                </MudExpansionPanel>

                <!-- Advanced Settings -->
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" Size="Size.Small" />
                            <MudText>Advanced Settings</MudText>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudTextField @bind-Value="editedAction.BlueprintId"
                                      Label="Blueprint ID"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      ReadOnly="true"
                                      Class="mb-2" />

                        <MudDivider Class="my-2" />

                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Action ID: @editedAction.Id
                        </MudText>
                    </ChildContent>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }
        else
        {
            <!-- Blueprint Properties -->
            <MudTextField @bind-Value="editedBlueprint.Title"
                         Label="Title"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Class="mb-3" />

            <MudTextField @bind-Value="editedBlueprint.Description"
                         Label="Description"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Lines="3"
                         Class="mb-3" />

            <MudNumericField @bind-Value="editedBlueprint.Version"
                            Label="Version"
                            Variant="Variant.Outlined"
                            Margin="Margin.Dense"
                            Class="mb-3" />

            <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Metadata</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                ID: @editedBlueprint.Id
            </MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Created: @editedBlueprint.CreatedAt.ToString("yyyy-MM-dd HH:mm")
            </MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Updated: @editedBlueprint.UpdatedAt.ToString("yyyy-MM-dd HH:mm")
            </MudText>

            <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Statistics</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Participants: @editedBlueprint.Participants.Count
            </MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Actions: @editedBlueprint.Actions.Count
            </MudText>
        }
    </div>
</div>

<style>
    .properties-panel {
        width: 350px;
        height: 100%;
        background: white;
        border-left: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .properties-panel-header {
        padding: 16px;
        border-bottom: 1px solid #e0e0e0;
        background: #f5f5f5;
    }

    .properties-panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }
</style>

@code {
    [Parameter]
    public Blueprint Blueprint { get; set; } = new();

    [Parameter]
    public BlueprintNodeModel? SelectedNode { get; set; }

    [Parameter]
    public EventCallback<Blueprint> OnBlueprintSaved { get; set; }

    [Parameter]
    public EventCallback<BlueprintAction> OnActionSaved { get; set; }

    [Parameter]
    public EventCallback OnDiscardChanges { get; set; }

    private Blueprint editedBlueprint = new();
    private BlueprintAction editedAction = new();

    protected override void OnParametersSet()
    {
        // Create copies for editing
        if (SelectedNode != null && SelectedNode is ActionNodeModel actionNode)
        {
            // Deep copy the action
            editedAction = new BlueprintAction
            {
                Id = actionNode.Action.Id,
                Title = actionNode.Action.Title,
                Description = actionNode.Action.Description,
                Sender = actionNode.Action.Sender,
                Participants = actionNode.Action.Participants,
                DataSchemas = actionNode.Action.DataSchemas,
                Disclosures = actionNode.Action.Disclosures,
                Calculations = actionNode.Action.Calculations,
                Condition = actionNode.Action.Condition,
                RequiredActionData = actionNode.Action.RequiredActionData,
                BlueprintId = actionNode.Action.BlueprintId
            };
        }
        else
        {
            // Copy blueprint properties
            editedBlueprint = new Blueprint
            {
                Id = Blueprint.Id,
                Title = Blueprint.Title,
                Description = Blueprint.Description,
                Version = Blueprint.Version,
                CreatedAt = Blueprint.CreatedAt,
                UpdatedAt = Blueprint.UpdatedAt,
                Participants = Blueprint.Participants,
                Actions = Blueprint.Actions
            };
        }
    }

    private async Task SaveChanges()
    {
        if (SelectedNode != null && SelectedNode is ActionNodeModel)
        {
            await OnActionSaved.InvokeAsync(editedAction);
        }
        else
        {
            editedBlueprint.UpdatedAt = DateTimeOffset.UtcNow;
            await OnBlueprintSaved.InvokeAsync(editedBlueprint);
        }
    }

    private async Task DiscardChanges()
    {
        await OnDiscardChanges.InvokeAsync();
    }
}
