@using System.Net.Http.Json
@using Sorcha.Admin.Services
@using Sorcha.Admin.Services.Configuration
@inject HttpClient Http
@inject IConfigurationService ConfigService

<MudPaper Elevation="2" Class="pa-4">
    <MudStack Spacing="3">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Cloud" Color="Color.Primary" Size="Size.Large" />
                <div>
                    <MudText Typo="Typo.h6">System Status</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @GetEnvironmentName()
                    </MudText>
                </div>
            </MudStack>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           OnClick="RefreshStatus"
                           Size="Size.Small"
                           Color="Color.Primary"
                           Disabled="@isLoading" />
        </MudStack>

        <MudDivider />

        @if (isLoading && !hasLoadedOnce)
        {
            <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="py-4">
                <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                <MudText Typo="Typo.body2" Color="Color.Secondary">Checking system status...</MudText>
            </MudStack>
        }
        else if (systemStatus != null)
        {
            <!-- Overall Status -->
            <MudAlert Severity="@GetOverallSeverity()" Dense="true" Class="mb-2">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@GetOverallIcon()" />
                    <MudText Typo="Typo.body1"><strong>@GetOverallStatusText()</strong></MudText>
                </MudStack>
            </MudAlert>

            <!-- Service Status Grid -->
            <MudGrid Spacing="2">
                @foreach (var service in GetServiceStatuses())
                {
                    <MudItem xs="6" sm="4" md="3">
                        <MudChip T="string"
                                 Color="@(service.IsHealthy ? Color.Success : Color.Error)"
                                 Icon="@(service.IsHealthy ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)"
                                 Size="Size.Small"
                                 Label="true">
                            @service.Name
                        </MudChip>
                    </MudItem>
                }
            </MudGrid>

            <!-- System Information -->
            <MudSimpleTable Dense="true" Hover="false" Class="mt-2">
                <tbody>
                    <tr>
                        <td style="width: 40%;"><MudText Typo="Typo.body2" Color="Color.Secondary">API Endpoint</MudText></td>
                        <td><MudText Typo="Typo.body2">@GetApiEndpoint()</MudText></td>
                    </tr>
                    <tr>
                        <td><MudText Typo="Typo.body2" Color="Color.Secondary">Services Healthy</MudText></td>
                        <td><MudText Typo="Typo.body2">@systemStatus.HealthyCount / @systemStatus.TotalCount</MudText></td>
                    </tr>
                    <tr>
                        <td><MudText Typo="Typo.body2" Color="Color.Secondary">Last Checked</MudText></td>
                        <td><MudText Typo="Typo.body2">@lastCheckTime.ToString("HH:mm:ss")</MudText></td>
                    </tr>
                </tbody>
            </MudSimpleTable>
        }
        else if (errorMessage != null)
        {
            <MudAlert Severity="Severity.Warning" Dense="true">
                <MudText Typo="Typo.body2">@errorMessage</MudText>
            </MudAlert>
        }
    </MudStack>
</MudPaper>

@code {
    private SystemStatusDto? systemStatus;
    private string? errorMessage;
    private bool isLoading = false;
    private bool hasLoadedOnce = false;
    private DateTime lastCheckTime = DateTime.Now;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RefreshStatus();
        }
    }

    private async Task RefreshStatus()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var config = await ConfigService.GetConfigurationAsync();
            var activeProfile = config.GetActiveProfile();

            if (activeProfile == null)
            {
                errorMessage = "No active profile configured";
                return;
            }

            // Try to get aggregated health status
            // Use TenantServiceUrl as the base - it routes through the gateway
            var baseUrl = activeProfile.TenantServiceUrl.TrimEnd('/');
            var healthUrl = $"{baseUrl}/api/health";

            try
            {
                var response = await Http.GetAsync(healthUrl);

                if (response.IsSuccessStatusCode)
                {
                    systemStatus = await response.Content.ReadFromJsonAsync<SystemStatusDto>();
                    lastCheckTime = DateTime.Now;
                }
                else
                {
                    // If health endpoint doesn't exist, create basic status from profile
                    systemStatus = new SystemStatusDto
                    {
                        TotalCount = 5,
                        HealthyCount = 0, // Unknown
                        Services = new List<ServiceHealthDto>
                        {
                            new() { Name = "Gateway", IsHealthy = true },
                            new() { Name = "Blueprint", IsHealthy = false },
                            new() { Name = "Wallet", IsHealthy = false },
                            new() { Name = "Register", IsHealthy = false },
                            new() { Name = "Peer", IsHealthy = false }
                        }
                    };
                    errorMessage = "Health endpoint not available. Showing profile configuration.";
                }
            }
            catch (HttpRequestException)
            {
                systemStatus = new SystemStatusDto
                {
                    TotalCount = 1,
                    HealthyCount = 0,
                    Services = new List<ServiceHealthDto>
                    {
                        new() { Name = "System", IsHealthy = false }
                    }
                };
                errorMessage = $"Unable to connect to {healthUrl}";
            }

            hasLoadedOnce = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private string GetEnvironmentName()
    {
        try
        {
            // Safe for prerendering - will return "Unknown" if LocalStorage not available
            var configTask = ConfigService.GetConfigurationAsync();
            if (configTask.IsCompleted)
            {
                return configTask.Result?.ActiveProfile ?? "Unknown";
            }
            return "Loading...";
        }
        catch
        {
            return "Unknown";
        }
    }

    private string GetApiEndpoint()
    {
        try
        {
            // Safe for prerendering - will return default if LocalStorage not available
            var configTask = ConfigService.GetConfigurationAsync();
            if (configTask.IsCompleted)
            {
                var profile = configTask.Result?.GetActiveProfile();
                return profile?.TenantServiceUrl ?? "Not configured";
            }
            return "Loading...";
        }
        catch
        {
            return "Not configured";
        }
    }

    private List<ServiceHealthDto> GetServiceStatuses()
    {
        return systemStatus?.Services ?? new List<ServiceHealthDto>();
    }

    private Severity GetOverallSeverity()
    {
        if (systemStatus == null) return Severity.Warning;
        if (systemStatus.HealthyCount == systemStatus.TotalCount) return Severity.Success;
        if (systemStatus.HealthyCount == 0) return Severity.Error;
        return Severity.Warning;
    }

    private string GetOverallIcon()
    {
        if (systemStatus == null) return Icons.Material.Filled.Help;
        if (systemStatus.HealthyCount == systemStatus.TotalCount) return Icons.Material.Filled.CheckCircle;
        if (systemStatus.HealthyCount == 0) return Icons.Material.Filled.Error;
        return Icons.Material.Filled.Warning;
    }

    private string GetOverallStatusText()
    {
        if (systemStatus == null) return "Unknown Status";
        if (systemStatus.HealthyCount == systemStatus.TotalCount) return "All Systems Operational";
        if (systemStatus.HealthyCount == 0) return "System Offline";
        return $"Partial Outage ({systemStatus.HealthyCount}/{systemStatus.TotalCount} services healthy)";
    }

    // DTOs for health status
    private class SystemStatusDto
    {
        public int TotalCount { get; set; }
        public int HealthyCount { get; set; }
        public List<ServiceHealthDto> Services { get; set; } = new();
    }

    private class ServiceHealthDto
    {
        public string Name { get; set; } = "";
        public bool IsHealthy { get; set; }
    }
}
