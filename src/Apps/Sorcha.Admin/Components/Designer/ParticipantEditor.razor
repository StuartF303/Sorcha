@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2025 Sorcha Contributors *@

@using MudBlazor
@using Sorcha.Admin.Models
@using Sorcha.Blueprint.Models

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-2" />
            @(IsEditing ? "Edit Participant" : "Add Participant")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_isValid">
            <MudTextField @bind-Value="Model.DisplayName"
                          Label="Display Name"
                          Placeholder="Enter participant name"
                          Variant="Variant.Outlined"
                          Required="true"
                          RequiredError="Display name is required"
                          Immediate="true"
                          Class="mb-4" />

            <MudTextField @bind-Value="Model.Organisation"
                          Label="Organisation"
                          Placeholder="Enter organisation name"
                          Variant="Variant.Outlined"
                          HelperText="The organisation this participant belongs to"
                          Class="mb-4" />

            <MudSelect @bind-Value="Model.Role"
                       Label="Role"
                       Variant="Variant.Outlined"
                       HelperText="Select the participant's role in the workflow"
                       Class="mb-4">
                @foreach (ParticipantRole role in Enum.GetValues<ParticipantRole>())
                {
                    <MudSelectItem Value="@role">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@GetRoleIcon(role)" Size="Size.Small" Class="mr-2" />
                            @role.ToString()
                        </div>
                    </MudSelectItem>
                }
            </MudSelect>

            <div class="d-flex align-center gap-2 mb-4">
                <MudTextField @bind-Value="Model.WalletAddress"
                              Label="Wallet Address"
                              Placeholder="0x..."
                              Variant="Variant.Outlined"
                              Style="flex: 1;"
                              HelperText="@GetWalletValidationMessage()" />
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           OnClick="OpenWalletSelector"
                           StartIcon="@Icons.Material.Filled.Search"
                           Style="height: 56px; margin-top: -24px;">
                    Browse
                </MudButton>
            </div>

            <MudTextField @bind-Value="Model.Description"
                          Label="Description (Optional)"
                          Placeholder="Additional notes about this participant"
                          Variant="Variant.Outlined"
                          Lines="2"
                          Class="mb-4" />

            @if (!string.IsNullOrWhiteSpace(Model.WalletAddress) && !IsValidWalletAddress(Model.WalletAddress))
            {
                <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-2">
                    The wallet address format may be invalid. Please verify the address.
                </MudAlert>
            }

            @if (_duplicateNameWarning)
            {
                <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-2">
                    A participant with this name already exists in the blueprint.
                </MudAlert>
            }
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Default">Cancel</MudButton>
        <MudButton OnClick="Submit"
                   Color="Color.Primary"
                   Variant="Variant.Filled"
                   Disabled="@(!_isValid || string.IsNullOrWhiteSpace(Model.DisplayName))">
            @(IsEditing ? "Save Changes" : "Add Participant")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Inject]
    private IDialogService DialogService { get; set; } = null!;

    [Parameter]
    public ParticipantModel Model { get; set; } = new();

    [Parameter]
    public bool IsEditing { get; set; }

    [Parameter]
    public List<string> ExistingParticipantNames { get; set; } = [];

    [Parameter]
    public List<string> AvailableWalletAddresses { get; set; } = [];

    private MudForm _form = null!;
    private bool _isValid;
    private bool _duplicateNameWarning;

    protected override void OnParametersSet()
    {
        CheckDuplicateName();
    }

    private void CheckDuplicateName()
    {
        if (string.IsNullOrWhiteSpace(Model.DisplayName))
        {
            _duplicateNameWarning = false;
            return;
        }

        // Check if name exists (excluding current participant if editing)
        _duplicateNameWarning = ExistingParticipantNames
            .Any(n => n.Equals(Model.DisplayName, StringComparison.OrdinalIgnoreCase) &&
                     (IsEditing ? !n.Equals(Model.DisplayName, StringComparison.OrdinalIgnoreCase) : true));
    }

    private async Task OpenWalletSelector()
    {
        var parameters = new DialogParameters<WalletSelectorDialog>
        {
            { x => x.WalletAddress, Model.WalletAddress ?? string.Empty },
            { x => x.AvailableAddresses, AvailableWalletAddresses }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<WalletSelectorDialog>("Select Wallet", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is string selectedAddress)
        {
            Model.WalletAddress = selectedAddress;
        }
    }

    private void Submit()
    {
        if (_isValid && !string.IsNullOrWhiteSpace(Model.DisplayName))
        {
            MudDialog.Close(DialogResult.Ok(Model));
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private string GetRoleIcon(ParticipantRole role) => role switch
    {
        ParticipantRole.Initiator => Icons.Material.Filled.PlayArrow,
        ParticipantRole.Approver => Icons.Material.Filled.CheckCircle,
        ParticipantRole.Observer => Icons.Material.Filled.Visibility,
        ParticipantRole.Member => Icons.Material.Filled.Person,
        ParticipantRole.Administrator => Icons.Material.Filled.AdminPanelSettings,
        _ => Icons.Material.Filled.Person
    };

    private string GetWalletValidationMessage()
    {
        if (string.IsNullOrWhiteSpace(Model.WalletAddress))
            return "Optional: Enter or select a wallet address";

        return IsValidWalletAddress(Model.WalletAddress)
            ? "Valid wallet address format"
            : "Address format may be invalid";
    }

    private bool IsValidWalletAddress(string? address)
    {
        if (string.IsNullOrWhiteSpace(address)) return true; // Empty is allowed

        // Basic validation: starts with 0x and is hex
        if (address.StartsWith("0x", StringComparison.OrdinalIgnoreCase))
        {
            var hex = address[2..];
            return hex.Length > 0 && hex.All(c => char.IsAsciiHexDigit(c));
        }

        // Allow other formats for flexibility (e.g., ENS names, other chain formats)
        return address.Length >= 8;
    }
}
