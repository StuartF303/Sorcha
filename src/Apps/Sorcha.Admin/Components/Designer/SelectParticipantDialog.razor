@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2025 Sorcha Contributors *@

@using MudBlazor
@using Sorcha.Blueprint.Models

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Class="mr-2" />
            Add Participant to Action
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
            Select a participant to add to action "@ActionTitle".
        </MudText>

        @if (AvailableParticipants.Any())
        {
            <MudList T="Participant" Dense="true" Class="pa-0">
                @foreach (var participant in AvailableParticipants)
                {
                    <MudListItem T="Participant"
                                 Class="pa-0 mb-2"
                                 OnClick="@(() => SelectParticipant(participant))">
                        <MudPaper Class="pa-3"
                                  Outlined="true"
                                  Style="width: 100%; cursor: pointer;"
                                  Elevation="@(SelectedParticipant?.Id == participant.Id ? 2 : 0)">
                            <div class="d-flex align-center">
                                <MudCheckBox T="bool"
                                             Value="@(SelectedParticipant?.Id == participant.Id)"
                                             Color="Color.Primary"
                                             Class="mr-2"
                                             ReadOnly="true" />
                                <MudAvatar Color="Color.Primary" Size="Size.Small" Class="mr-3">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                                </MudAvatar>
                                <div style="flex: 1;">
                                    <MudText Typo="Typo.body1" Style="font-weight: 500;">
                                        @participant.Name
                                    </MudText>
                                    @if (!string.IsNullOrWhiteSpace(participant.Organisation))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @participant.Organisation
                                        </MudText>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(participant.WalletAddress))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Tertiary" Style="font-family: monospace;">
                                            @TruncateAddress(participant.WalletAddress)
                                        </MudText>
                                    }
                                </div>
                            </div>
                        </MudPaper>
                    </MudListItem>
                }
            </MudList>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Dense="true">
                No participants available to add.
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Default">Cancel</MudButton>
        <MudButton OnClick="Submit"
                   Color="Color.Primary"
                   Variant="Variant.Filled"
                   Disabled="@(SelectedParticipant == null)">
            Add to Action
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public List<Participant> AvailableParticipants { get; set; } = [];

    [Parameter]
    public string ActionTitle { get; set; } = string.Empty;

    private Participant? SelectedParticipant;

    private void SelectParticipant(Participant participant)
    {
        SelectedParticipant = participant;
    }

    private void Submit()
    {
        if (SelectedParticipant != null)
        {
            MudDialog.Close(DialogResult.Ok(SelectedParticipant));
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private string TruncateAddress(string address)
    {
        if (string.IsNullOrEmpty(address) || address.Length <= 16)
            return address;
        return $"{address[..8]}...{address[^6..]}";
    }
}
