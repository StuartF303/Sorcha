@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2025 Sorcha Contributors *@

@using MudBlazor
@using Sorcha.Admin.Models
@using Sorcha.Blueprint.Models

<div class="participant-list">
    <div class="d-flex align-center justify-space-between mb-3">
        <MudText Typo="Typo.subtitle1">
            <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" Class="mr-2" />
            Participants (@Participants.Count)
        </MudText>
        <MudButton StartIcon="@Icons.Material.Filled.PersonAdd"
                   Color="Color.Primary"
                   Size="Size.Small"
                   Variant="Variant.Filled"
                   OnClick="AddParticipant">
            Add
        </MudButton>
    </div>

    @if (Participants.Any())
    {
        <MudList T="Participant" Dense="true" Class="pa-0">
            @foreach (var participant in Participants)
            {
                <MudListItem T="Participant" Class="pa-0 mb-1">
                    <MudPaper Class="pa-3" Outlined="true" Style="width: 100%;">
                        <div class="d-flex align-center justify-space-between">
                            <div class="d-flex align-center" style="flex: 1; min-width: 0;">
                                <MudAvatar Color="@GetRoleColor(participant)" Size="Size.Small" Class="mr-3">
                                    <MudIcon Icon="@GetRoleIcon(participant)" Size="Size.Small" />
                                </MudAvatar>
                                <div style="flex: 1; min-width: 0;">
                                    <MudText Typo="Typo.body1" Style="font-weight: 500;">
                                        @participant.Name
                                    </MudText>
                                    @if (!string.IsNullOrWhiteSpace(participant.Organisation))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @participant.Organisation
                                        </MudText>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(participant.WalletAddress))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Tertiary" Style="font-family: monospace;">
                                            @TruncateAddress(participant.WalletAddress)
                                        </MudText>
                                    }
                                </div>
                            </div>
                            <div class="d-flex align-center gap-1">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                               Size="Size.Small"
                                               Color="Color.Default"
                                               OnClick="@(() => EditParticipant(participant))"
                                               Title="Edit participant" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               OnClick="@(() => DeleteParticipant(participant))"
                                               Title="Delete participant" />
                            </div>
                        </div>
                    </MudPaper>
                </MudListItem>
            }
        </MudList>
    }
    else
    {
        <MudAlert Severity="Severity.Info" Dense="true">
            No participants defined. Click "Add" to add participants to this blueprint.
        </MudAlert>
    }
</div>

@code {
    [Inject]
    private IDialogService DialogService { get; set; } = null!;

    [Inject]
    private ISnackbar Snackbar { get; set; } = null!;

    [Parameter]
    public List<Participant> Participants { get; set; } = [];

    [Parameter]
    public EventCallback<Participant> OnParticipantAdded { get; set; }

    [Parameter]
    public EventCallback<Participant> OnParticipantUpdated { get; set; }

    [Parameter]
    public EventCallback<Participant> OnParticipantDeleted { get; set; }

    [Parameter]
    public List<string> AvailableWalletAddresses { get; set; } = [];

    private async Task AddParticipant()
    {
        var model = new ParticipantModel();
        var existingNames = Participants.Select(p => p.Name).ToList();

        var parameters = new DialogParameters<ParticipantEditor>
        {
            { x => x.Model, model },
            { x => x.IsEditing, false },
            { x => x.ExistingParticipantNames, existingNames },
            { x => x.AvailableWalletAddresses, AvailableWalletAddresses }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ParticipantEditor>("Add Participant", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is ParticipantModel savedModel)
        {
            var participant = savedModel.ToParticipant();
            await OnParticipantAdded.InvokeAsync(participant);
            Snackbar.Add($"Participant '{participant.Name}' added", Severity.Success);
        }
    }

    private async Task EditParticipant(Participant participant)
    {
        var model = ParticipantModel.FromParticipant(participant);
        var existingNames = Participants
            .Where(p => p.Id != participant.Id)
            .Select(p => p.Name)
            .ToList();

        var parameters = new DialogParameters<ParticipantEditor>
        {
            { x => x.Model, model },
            { x => x.IsEditing, true },
            { x => x.ExistingParticipantNames, existingNames },
            { x => x.AvailableWalletAddresses, AvailableWalletAddresses }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ParticipantEditor>("Edit Participant", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is ParticipantModel savedModel)
        {
            var updatedParticipant = savedModel.ToParticipant();
            await OnParticipantUpdated.InvokeAsync(updatedParticipant);
            Snackbar.Add($"Participant '{updatedParticipant.Name}' updated", Severity.Success);
        }
    }

    private async Task DeleteParticipant(Participant participant)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Delete Participant",
            $"Are you sure you want to delete participant '{participant.Name}'? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirm == true)
        {
            await OnParticipantDeleted.InvokeAsync(participant);
            Snackbar.Add($"Participant '{participant.Name}' deleted", Severity.Warning);
        }
    }

    private string TruncateAddress(string address)
    {
        if (string.IsNullOrEmpty(address) || address.Length <= 16)
            return address;
        return $"{address[..8]}...{address[^6..]}";
    }

    private Color GetRoleColor(Participant participant)
    {
        var role = ParseRole(participant.Organisation);
        return role switch
        {
            ParticipantRole.Initiator => Color.Primary,
            ParticipantRole.Approver => Color.Success,
            ParticipantRole.Observer => Color.Info,
            ParticipantRole.Administrator => Color.Warning,
            _ => Color.Default
        };
    }

    private string GetRoleIcon(Participant participant)
    {
        var role = ParseRole(participant.Organisation);
        return role switch
        {
            ParticipantRole.Initiator => Icons.Material.Filled.PlayArrow,
            ParticipantRole.Approver => Icons.Material.Filled.CheckCircle,
            ParticipantRole.Observer => Icons.Material.Filled.Visibility,
            ParticipantRole.Administrator => Icons.Material.Filled.AdminPanelSettings,
            _ => Icons.Material.Filled.Person
        };
    }

    private ParticipantRole ParseRole(string? organisation)
    {
        if (string.IsNullOrEmpty(organisation)) return ParticipantRole.Member;
        return Enum.TryParse<ParticipantRole>(organisation, ignoreCase: true, out var r) ? r : ParticipantRole.Member;
    }
}

<style>
    .participant-list {
        width: 100%;
    }
</style>
