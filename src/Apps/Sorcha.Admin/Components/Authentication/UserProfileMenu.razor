@using Sorcha.Admin.Services.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@inject IAuthenticationService AuthService
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<AuthorizeView>
    <Authorized>
        <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
            <ActivatorContent>
                <MudBadge Color="Color.Success" Dot="true" Overlap="true" Class="mx-2">
                    <MudAvatar Color="Color.Primary" Size="Size.Small">
                        @GetUserInitials(context)
                    </MudAvatar>
                </MudBadge>
            </ActivatorContent>
            <ChildContent>
                <div class="px-4 py-3">
                    <div class="d-flex align-center mb-2">
                        <MudAvatar Color="Color.Primary" Size="Size.Medium" Class="mr-3">
                            @GetUserInitials(context)
                        </MudAvatar>
                        <div>
                            <MudText Typo="Typo.body1">
                                <strong>@GetUsername(context)</strong>
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @GetEmail(context)
                            </MudText>
                        </div>
                    </div>
                </div>

                <MudDivider Class="my-2" />

                <MudMenuItem Icon="@Icons.Material.Filled.Settings" Href="/settings">
                    Settings
                </MudMenuItem>

                <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="Logout">
                    Logout
                </MudMenuItem>
            </ChildContent>
        </MudMenu>
    </Authorized>
    <NotAuthorized>
        <MudIconButton Icon="@Icons.Material.Filled.Login"
                       Color="Color.Inherit"
                       Href="/login"
                       Title="Login" />
    </NotAuthorized>
</AuthorizeView>

@code {
    private async Task Logout()
    {
        try
        {
            // Logout from all profiles
            await AuthService.LogoutAllAsync();

            // Notify authentication state changed
            AuthStateProvider.NotifyAuthenticationStateChanged();

            Snackbar.Add("Logged out successfully", Severity.Info);

            // Navigate to login page with force reload
            Navigation.NavigateTo("/login", forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Logout error: {ex.Message}", Severity.Error);
        }
    }

    private string GetUsername(AuthenticationState state)
    {
        return state.User.Identity?.Name ?? "Unknown User";
    }

    private string GetEmail(AuthenticationState state)
    {
        var email = state.User.Claims.FirstOrDefault(c => c.Type == System.Security.Claims.ClaimTypes.Email)?.Value;
        return email ?? state.User.Identity?.Name ?? "";
    }

    private string GetUserInitials(AuthenticationState state)
    {
        var username = GetUsername(state);

        if (string.IsNullOrWhiteSpace(username) || username == "Unknown User")
            return "?";

        var parts = username.Split(new[] { ' ', '@', '.' }, StringSplitOptions.RemoveEmptyEntries);

        if (parts.Length >= 2)
        {
            // First and last name/part
            return $"{parts[0][0]}{parts[^1][0]}".ToUpper();
        }
        else if (parts.Length == 1 && parts[0].Length >= 2)
        {
            // Single name, use first two characters
            return parts[0].Substring(0, 2).ToUpper();
        }
        else if (parts.Length == 1 && parts[0].Length == 1)
        {
            // Single character
            return parts[0].ToUpper();
        }

        return "?";
    }
}
