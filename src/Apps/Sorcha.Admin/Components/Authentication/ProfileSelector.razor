@using Sorcha.Admin.Models.Configuration
@using Sorcha.Admin.Services.Configuration
@inject IConfigurationService ConfigService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudMenu Icon="@Icons.Material.Filled.Cloud" Color="Color.Inherit"
         AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight"
         Label="@(_currentProfile?.Name ?? "No Profile")"
         Variant="Variant.Text"
         Class="mx-2">
    <ChildContent>
        <MudText Typo="Typo.caption" Class="px-4 py-2" Color="Color.Secondary">
            Select Environment
        </MudText>
        <MudDivider Class="mb-2" />

        @foreach (var profile in _profiles.OrderBy(p => p.Key))
        {
            <MudMenuItem OnClick="@(() => SelectProfile(profile.Key))"
                         Icon="@(profile.Key == _activeProfileName ? Icons.Material.Filled.Check : null)">
                <div class="d-flex flex-column">
                    <MudText Typo="Typo.body2">
                        <strong>@profile.Value.Name</strong>
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @GetProfileDescription(profile.Value)
                    </MudText>
                </div>
            </MudMenuItem>
        }

        <MudDivider Class="my-2" />

        <MudMenuItem Icon="@Icons.Material.Filled.Settings" OnClick="OpenProfileManagement">
            Manage Profiles...
        </MudMenuItem>
    </ChildContent>
</MudMenu>

@code {
    private Dictionary<string, Profile> _profiles = new();
    private string? _activeProfileName;
    private Profile? _currentProfile;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadProfiles();
        }
    }

    private async Task LoadProfiles()
    {
        try
        {
            var config = await ConfigService.GetConfigurationAsync();
            _profiles = config.Profiles;
            _activeProfileName = config.ActiveProfile;
            _currentProfile = config.GetActiveProfile();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading profiles: {ex.Message}", Severity.Error);
        }
    }

    private async Task SelectProfile(string profileName)
    {
        if (profileName == _activeProfileName)
        {
            Snackbar.Add($"Already using profile: {profileName}", Severity.Info);
            return;
        }

        try
        {
            await ConfigService.SetActiveProfileAsync(profileName);
            await LoadProfiles();

            Snackbar.Add($"Switched to profile: {profileName}", Severity.Success);

            // Refresh the page to apply new profile settings
            Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error switching profile: {ex.Message}", Severity.Error);
        }
    }

    private string GetProfileDescription(Profile profile)
    {
        try
        {
            var uri = new Uri(profile.TenantServiceUrl);
            return $"{uri.Host}{(uri.Port != 80 && uri.Port != 443 ? $":{uri.Port}" : "")}";
        }
        catch
        {
            return profile.TenantServiceUrl;
        }
    }

    private void OpenProfileManagement()
    {
        // Navigate to Settings page, Configuration tab
        Navigation.NavigateTo("/settings#profiles");
    }
}
