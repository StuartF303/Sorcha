@page "/login"
@using Sorcha.Admin.Services.Authentication
@using Sorcha.Admin.Services.Configuration
@using Sorcha.Admin.Models.Configuration
@using Sorcha.Admin.Models.Authentication
@attribute [AllowAnonymous]
@inject IAuthenticationService AuthService
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject IConfigurationService ConfigService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>Login - Sorcha Platform</PageTitle>

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<AuthorizeView Context="authContext">
    <Authorized>
        @{
            // Already authenticated - redirect to home
            Navigation.NavigateTo("/", forceLoad: true);
        }
    </Authorized>
    <NotAuthorized>
        <div class="d-flex flex-column align-center justify-center" style="min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <MudPaper Elevation="8" Class="pa-8" Style="max-width: 500px; width: 100%; border-radius: 16px;">
                <div class="d-flex flex-column align-center mb-6">
                    <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings"
                             Size="Size.Large"
                             Color="Color.Primary"
                             Class="mb-4"
                             Style="font-size: 4rem;" />
                    <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-2">Sorcha Platform</MudText>
                    <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
                        Blueprint Designer & Administration Portal
                    </MudText>
                </div>

                <!-- INLINE LOGIN FORM -->
                <EditForm Model="@_loginModel" OnValidSubmit="HandleLogin">
                    <DataAnnotationsValidator />

                    <!-- Profile Selector -->
                    <MudSelect T="string"
                               @bind-Value="_selectedProfile"
                               Label="Profile"
                               Variant="Variant.Outlined"
                               Class="mb-4"
                               Disabled="_isLoading">
                        @foreach (var profile in _profiles)
                        {
                            <MudSelectItem T="string" Value="@profile.Key">
                                @profile.Key
                            </MudSelectItem>
                        }
                    </MudSelect>

                    <!-- Username -->
                    <MudTextField @bind-Value="_loginModel.Username"
                                  Label="Username or Email"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  Disabled="_isLoading"
                                  Class="mb-4"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Person" />

                    <!-- Password -->
                    <MudTextField @bind-Value="_loginModel.Password"
                                  Label="Password"
                                  Variant="Variant.Outlined"
                                  InputType="InputType.Password"
                                  Required="true"
                                  Disabled="_isLoading"
                                  Class="mb-4"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Lock" />

                    <!-- Error Message -->
                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <MudAlert Severity="Severity.Error" Class="mb-4" Dense="true">
                            @_errorMessage
                        </MudAlert>
                    }

                    <!-- Login Button -->
                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               Size="Size.Large"
                               StartIcon="@Icons.Material.Filled.Login"
                               Disabled="_isLoading"
                               Class="mb-4">
                        @if (_isLoading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Signing In...</span>
                        }
                        else
                        {
                            <span>Sign In</span>
                        }
                    </MudButton>
                </EditForm>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.caption" Align="Align.Center" Color="Color.Secondary">
                    Secure authentication powered by Sorcha Tenant Service
                </MudText>
            </MudPaper>

            <!-- Back to Home Link -->
            <MudButton Href="/"
                       Color="Color.Default"
                       Variant="Variant.Text"
                       StartIcon="@Icons.Material.Filled.Home"
                       Class="mt-4"
                       Style="color: white;">
                Back to Home
            </MudButton>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private LoginModel _loginModel = new();
    private Dictionary<string, Profile> _profiles = new();
    private string _selectedProfile = string.Empty;
    private string _errorMessage = string.Empty;
    private bool _isLoading = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadProfiles();
        }
    }

    private async Task LoadProfiles()
    {
        try
        {
            var config = await ConfigService.GetConfigurationAsync();
            _profiles = config.Profiles;
            _selectedProfile = config.ActiveProfile ?? ProfileDefaults.DefaultActiveProfile;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading profiles: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleLogin()
    {
        _isLoading = true;
        _errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            var loginRequest = new LoginRequest
            {
                Username = _loginModel.Username,
                Password = _loginModel.Password,
                ClientId = "sorcha-admin"
            };

            // Authenticate with Tenant Service
            await AuthService.LoginAsync(loginRequest, _selectedProfile);

            // Set active profile
            await ConfigService.SetActiveProfileAsync(_selectedProfile);

            Snackbar.Add($"Welcome, {_loginModel.Username}!", Severity.Success);

            // Notify authentication state changed - this triggers AuthorizeView updates
            AuthStateProvider.NotifyAuthenticationStateChanged();

            // Navigate to home page
            // With server-side session storage, tokens persist across circuit recreation
            Navigation.NavigateTo("/", forceLoad: true);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Login failed: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private class LoginModel
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}
