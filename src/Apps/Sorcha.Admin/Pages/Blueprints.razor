@page "/blueprints"
@attribute [Authorize(Roles = "Designer,Administrator")]
@using Blazored.LocalStorage
@inject ILocalStorageService LocalStorage
@inject NavigationManager Navigation

<PageTitle>Blueprint Library - Sorcha Platform</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-2">
        <MudIcon Icon="@Icons.Material.Filled.LibraryBooks" Class="mr-2" />
        Blueprint Library
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        Browse and manage your blueprint definitions
    </MudText>

    <MudGrid>
        <MudItem xs="12">
            <MudPaper Class="pa-4 mb-4" Elevation="2">
                <div class="d-flex justify-space-between align-center">
                    <MudTextField T="string" @bind-Value="searchText" Placeholder="Search blueprints..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Variant="Variant.Outlined" Class="flex-grow-1 mr-3" />
                    <MudButton Href="/designer" Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add">
                        Create Blueprint
                    </MudButton>
                </div>
            </MudPaper>
        </MudItem>

        @if (blueprints.Any())
        {
            @foreach (var blueprint in blueprints)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudCard Elevation="2">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@blueprint.Title</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Version @blueprint.Version
                                </MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" />
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText Typo="Typo.body2" Class="mb-2">@blueprint.Description</MudText>
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Size="Size.Small" /> @blueprint.Actions.Count actions
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                <MudIcon Icon="@Icons.Material.Filled.Update" Size="Size.Small" /> Updated @blueprint.UpdatedAt.ToString("MMM dd, yyyy")
                            </MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Color="Color.Primary" Variant="Variant.Text" Href="/designer">Open</MudButton>
                            <MudButton Color="Color.Default" Variant="Variant.Text">Execute</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        }
        else
        {
            <MudItem xs="12">
                <MudPaper Class="pa-8 text-center" Elevation="2">
                    <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Size="Size.Large" Color="Color.Secondary" Class="mb-3" />
                    <MudText Typo="Typo.h6" Class="mb-2">No Blueprints Found</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        Get started by creating your first blueprint
                    </MudText>
                    <MudButton Href="/designer" Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add">
                        Create Blueprint
                    </MudButton>
                </MudPaper>
            </MudItem>
        }

        <MudItem xs="12">
            <MudAlert Severity="Severity.Info">
                <MudText Typo="Typo.body2">
                    This page loads blueprints from browser LocalStorage. Server-side blueprint management will be implemented in future versions.
                </MudText>
            </MudAlert>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private string searchText = "";
    private List<Sorcha.Blueprint.Models.Blueprint> blueprints = new();

    protected override async Task OnInitializedAsync()
    {
        // Load blueprints from LocalStorage (same as designer page)
        try
        {
            var blueprintsJson = await LocalStorage.GetItemAsStringAsync("sorcha:blueprints");
            if (!string.IsNullOrEmpty(blueprintsJson))
            {
                blueprints = System.Text.Json.JsonSerializer.Deserialize<List<Sorcha.Blueprint.Models.Blueprint>>(blueprintsJson) ?? new();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading blueprints: {ex.Message}");
        }
    }
}
