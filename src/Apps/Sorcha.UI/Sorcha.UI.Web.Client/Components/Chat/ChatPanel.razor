@using Sorcha.UI.Core.Models.Chat

<div class="chat-panel-container">
    <!-- Messages Area -->
    <div class="messages-area" @ref="messagesContainer">
        @foreach (var message in Messages)
        {
            <ChatMessageItem Message="message" />
        }

        @if (IsProcessing)
        {
            <div class="message assistant-message processing">
                <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" />
                <span class="ml-2">AI is thinking...</span>
            </div>
        }
    </div>

    <!-- Input Area -->
    <div class="input-area">
        <MudPaper Elevation="2" Class="pa-2">
            <div class="d-flex align-center gap-2">
                <MudTextField @bind-Value="messageInput"
                              Placeholder="@(IsConnected ? "Describe your workflow..." : "Connecting...")"
                              Variant="Variant.Outlined"
                              Lines="2"
                              Immediate="true"
                              Disabled="@(!IsConnected || IsProcessing)"
                              OnKeyDown="@HandleKeyDown"
                              Class="flex-grow-1" />

                @if (IsProcessing)
                {
                    <MudButton Color="Color.Warning"
                               Variant="Variant.Filled"
                               OnClick="@(() => OnCancelGeneration.InvokeAsync())"
                               StartIcon="@Icons.Material.Filled.Stop">
                        Cancel
                    </MudButton>
                }
                else
                {
                    <MudButton Color="Color.Primary"
                               Variant="Variant.Filled"
                               OnClick="@SendMessage"
                               Disabled="@(string.IsNullOrWhiteSpace(messageInput) || !IsConnected)"
                               StartIcon="@Icons.Material.Filled.Send">
                        Send
                    </MudButton>
                }
            </div>
        </MudPaper>
    </div>
</div>

<style>
    .chat-panel-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }

    .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .input-area {
        padding: 8px;
        border-top: 1px solid var(--mud-palette-divider);
        background: var(--mud-palette-surface);
    }

    .message {
        padding: 12px 16px;
        border-radius: 8px;
        max-width: 85%;
    }

    .assistant-message {
        background: var(--mud-palette-background);
        align-self: flex-start;
        border: 1px solid var(--mud-palette-divider);
    }

    .assistant-message.processing {
        display: flex;
        align-items: center;
        opacity: 0.7;
    }
</style>

@code {
    [Parameter]
    public List<Sorcha.UI.Core.Models.Chat.ChatMessage> Messages { get; set; } = [];

    [Parameter]
    public bool IsProcessing { get; set; }

    [Parameter]
    public bool IsConnected { get; set; }

    [Parameter]
    public EventCallback<string> OnSendMessage { get; set; }

    [Parameter]
    public EventCallback OnCancelGeneration { get; set; }

    private ElementReference messagesContainer;
    private string messageInput = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Auto-scroll to bottom when new messages arrive
        await ScrollToBottom();
    }

    private async Task ScrollToBottom()
    {
        try
        {
            // Use JS interop to scroll to bottom if needed
            // For now, this is a placeholder
        }
        catch
        {
            // Ignore scroll errors
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey && !string.IsNullOrWhiteSpace(messageInput))
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(messageInput))
            return;

        var message = messageInput;
        messageInput = "";

        await OnSendMessage.InvokeAsync(message);
    }
}
