@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@using MudBlazor
@using System.Reflection
@implements IDisposable
@inject HttpClient Http
@inject NavigationManager Navigation

<MudAppBar Bottom="true" Fixed="true" Dense="true" Elevation="0" Style="height: 32px; min-height: 32px; background-color: var(--mud-palette-background-gray); border-top: 1px solid var(--mud-palette-lines-default);">
    <div class="d-flex align-center justify-space-between px-4" style="width: 100%; height: 100%;">
        <MudText Typo="Typo.caption" Class="mud-text-secondary">v@(_version)</MudText>
        <div class="d-flex align-center gap-4">
            <div class="d-flex align-center gap-1">
                <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small"
                         Color="@(_isConnected ? Color.Success : Color.Error)"
                         Style="font-size: 10px;" />
                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                    @(_isConnected ? "Connected" : "Offline")
                </MudText>
            </div>
            @if (_pendingActionCount > 0)
            {
                <MudLink Typo="Typo.caption" Href="my-actions" Color="Color.Primary">
                    @_pendingActionCount pending action@(_pendingActionCount != 1 ? "s" : "")
                </MudLink>
            }
        </div>
    </div>
</MudAppBar>

@code {
    private string _version = "0.0.0";
    private bool _isConnected = true;
    private int _pendingActionCount;
    private Timer? _healthTimer;

    protected override void OnInitialized()
    {
        _version = Assembly.GetExecutingAssembly()
            .GetCustomAttribute<AssemblyInformationalVersionAttribute>()
            ?.InformationalVersion?.Split('+')[0] ?? "0.0.0";

        _healthTimer = new Timer(async _ => await CheckHealthAsync(), null,
            TimeSpan.Zero, TimeSpan.FromSeconds(30));
    }

    private async Task CheckHealthAsync()
    {
        try
        {
            var response = await Http.GetAsync("/api/health");
            var wasConnected = _isConnected;
            _isConnected = response.IsSuccessStatusCode;
            if (wasConnected != _isConnected)
                await InvokeAsync(StateHasChanged);
        }
        catch
        {
            if (_isConnected)
            {
                _isConnected = false;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    public void Dispose()
    {
        _healthTimer?.Dispose();
    }
}
