@using MudBlazor
@using Sorcha.UI.Core.Models
@using Sorcha.UI.Core.Services
@inject IActivityLogService ActivityLogService

<MudDrawer @bind-Open="IsOpen" Anchor="Anchor.End" Elevation="4" Variant="DrawerVariant.Temporary" Width="400px">
    <MudDrawerHeader>
        <MudText Typo="Typo.h6" Class="flex-grow-1">Activity Log</MudText>
        <MudIconButton Icon="@Icons.Material.Filled.DoneAll" OnClick="MarkAllRead" Title="Mark All Read" Size="Size.Small" />
        <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@(() => IsOpen = false)" Size="Size.Small" />
    </MudDrawerHeader>
    <MudDivider />

    @if (_loading)
    {
        <div class="d-flex justify-center pa-8">
            <MudProgressCircular Indeterminate="true" Size="Size.Medium" />
        </div>
    }
    else if (_events.Count == 0)
    {
        <div class="d-flex flex-column align-center pa-8">
            <MudIcon Icon="@Icons.Material.Filled.NotificationsNone" Size="Size.Large" Class="mud-text-secondary mb-2" />
            <MudText Typo="Typo.body2" Class="mud-text-secondary">No activity events</MudText>
        </div>
    }
    else
    {
        <MudList T="ActivityEventDto" Dense="true" Class="pa-0">
            @foreach (var group in GroupByDate(_events))
            {
                <MudListSubheader Class="mud-text-secondary">
                    @group.Key
                </MudListSubheader>
                @foreach (var evt in group.Value)
                {
                    <MudListItem T="ActivityEventDto" Class="@(evt.IsRead ? "" : "mud-primary-text")">
                        <div class="d-flex align-center gap-2">
                            <MudIcon Icon="@GetSeverityIcon(evt.Severity)" Color="@GetSeverityColor(evt.Severity)" Size="Size.Small" />
                            <div class="flex-grow-1">
                                <MudText Typo="Typo.body2" Style="@(evt.IsRead ? "" : "font-weight: 600;")">@evt.Title</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@evt.Message</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@evt.CreatedAt.LocalDateTime.ToString("HH:mm")</MudText>
                            </div>
                        </div>
                    </MudListItem>
                }
            }
        </MudList>

        @if (_totalCount > _events.Count)
        {
            <div class="d-flex justify-center pa-2">
                <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="LoadMore">Load More</MudButton>
            </div>
        }
    }
</MudDrawer>

@code {
    private bool _isOpen;
    private bool _loading;
    private List<ActivityEventDto> _events = [];
    private int _totalCount;
    private int _page = 1;

    [Parameter]
    public bool IsOpen
    {
        get => _isOpen;
        set
        {
            if (_isOpen != value)
            {
                _isOpen = value;
                IsOpenChanged.InvokeAsync(value);
                if (value) _ = LoadEventsAsync();
            }
        }
    }

    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public EventCallback OnEventsRead { get; set; }

    private async Task LoadEventsAsync()
    {
        _loading = true;
        _page = 1;
        StateHasChanged();

        var result = await ActivityLogService.GetEventsAsync(_page, 50);
        _events = result.Items;
        _totalCount = result.TotalCount;
        _loading = false;
        StateHasChanged();
    }

    private async Task LoadMore()
    {
        _page++;
        var result = await ActivityLogService.GetEventsAsync(_page, 50);
        _events.AddRange(result.Items);
        StateHasChanged();
    }

    private async Task MarkAllRead()
    {
        await ActivityLogService.MarkReadAsync();
        foreach (var evt in _events) evt.IsRead = true;
        await OnEventsRead.InvokeAsync();
        StateHasChanged();
    }

    private static Dictionary<string, List<ActivityEventDto>> GroupByDate(List<ActivityEventDto> events)
    {
        var today = DateTimeOffset.Now.Date;
        var yesterday = today.AddDays(-1);

        return events
            .GroupBy(e =>
            {
                var date = e.CreatedAt.LocalDateTime.Date;
                if (date == today) return "Today";
                if (date == yesterday) return "Yesterday";
                return date.ToString("dd MMM yyyy");
            })
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private static string GetSeverityIcon(string severity) => severity switch
    {
        "Success" => Icons.Material.Filled.CheckCircle,
        "Warning" => Icons.Material.Filled.Warning,
        "Error" => Icons.Material.Filled.Error,
        _ => Icons.Material.Filled.Info
    };

    private static Color GetSeverityColor(string severity) => severity switch
    {
        "Success" => Color.Success,
        "Warning" => Color.Warning,
        "Error" => Color.Error,
        _ => Color.Info
    };
}
