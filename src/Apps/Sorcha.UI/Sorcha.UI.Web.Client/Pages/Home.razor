@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@page "/"
@page "/dashboard"
@layout MainLayout
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]
@using Microsoft.AspNetCore.Components.Authorization
@using Sorcha.UI.Core.Models.Dashboard
@using Sorcha.UI.Core.Services
@using Sorcha.UI.Web.Client.Components.Layout
@inject IDashboardService DashboardService
@inject NavigationManager Navigation

<PageTitle>Dashboard - Sorcha</PageTitle>

<CascadingAuthenticationState>
    <AuthorizeView>
        <Authorized>
            <MudText Typo="Typo.h4" Class="mb-4">Welcome back, @context.User.Identity?.Name!</MudText>

            @* Stats Cards *@
            <MudGrid Class="mb-6">
                <MudItem xs="12" sm="6" md="4" lg="2">
                    <MudCard Elevation="2">
                        <MudCardContent Class="d-flex flex-column align-center pa-4">
                            <MudIcon Icon="@Icons.Material.Filled.Description" Color="Color.Primary" Size="Size.Large" Class="mb-2" />
                            @if (_isLoading)
                            {
                                <MudSkeleton Width="40px" Height="32px" />
                            }
                            else if (!_stats.IsLoaded)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Unavailable</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.h5">@_stats.ActiveBlueprints</MudText>
                            }
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Blueprints</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" md="4" lg="2">
                    <MudCard Elevation="2">
                        <MudCardContent Class="d-flex flex-column align-center pa-4">
                            <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Color="Color.Secondary" Size="Size.Large" Class="mb-2" />
                            @if (_isLoading)
                            {
                                <MudSkeleton Width="40px" Height="32px" />
                            }
                            else if (!_stats.IsLoaded)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Unavailable</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.h5">@_stats.TotalWallets</MudText>
                            }
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Wallets</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" md="4" lg="2">
                    <MudCard Elevation="2">
                        <MudCardContent Class="d-flex flex-column align-center pa-4">
                            <MudIcon Icon="@Icons.Material.Filled.Receipt" Color="Color.Info" Size="Size.Large" Class="mb-2" />
                            @if (_isLoading)
                            {
                                <MudSkeleton Width="40px" Height="32px" />
                            }
                            else if (!_stats.IsLoaded)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Unavailable</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.h5">@_stats.RecentTransactions</MudText>
                            }
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Transactions</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" md="4" lg="2">
                    <MudCard Elevation="2">
                        <MudCardContent Class="d-flex flex-column align-center pa-4">
                            <MudIcon Icon="@Icons.Material.Filled.Hub" Color="Color.Success" Size="Size.Large" Class="mb-2" />
                            @if (_isLoading)
                            {
                                <MudSkeleton Width="40px" Height="32px" />
                            }
                            else if (!_stats.IsLoaded)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Unavailable</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.h5">@_stats.ConnectedPeers</MudText>
                            }
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Peers</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" md="4" lg="2">
                    <MudCard Elevation="2">
                        <MudCardContent Class="d-flex flex-column align-center pa-4">
                            <MudIcon Icon="@Icons.Material.Filled.Storage" Color="Color.Warning" Size="Size.Large" Class="mb-2" />
                            @if (_isLoading)
                            {
                                <MudSkeleton Width="40px" Height="32px" />
                            }
                            else if (!_stats.IsLoaded)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Unavailable</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.h5">@_stats.ActiveRegisters</MudText>
                            }
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Registers</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" md="4" lg="2">
                    <MudCard Elevation="2">
                        <MudCardContent Class="d-flex flex-column align-center pa-4">
                            <MudIcon Icon="@Icons.Material.Filled.Business" Color="Color.Dark" Size="Size.Large" Class="mb-2" />
                            @if (_isLoading)
                            {
                                <MudSkeleton Width="40px" Height="32px" />
                            }
                            else if (!_stats.IsLoaded)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Unavailable</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.h5">@_stats.TotalOrganizations</MudText>
                            }
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Organizations</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>

            @* Quick Actions *@
            <MudText Typo="Typo.h6" Class="mb-2">Quick Actions</MudText>
            <MudStack Row="true" Spacing="2" Class="mb-6">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="designer"
                           StartIcon="@Icons.Material.Filled.Add">
                    Create Blueprint
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="wallets"
                           StartIcon="@Icons.Material.Filled.AccountBalanceWallet">
                    Manage Wallets
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Href="registers"
                           StartIcon="@Icons.Material.Filled.Storage">
                    View Registers
                </MudButton>
            </MudStack>

            @* Recent Activity *@
            <MudText Typo="Typo.h6" Class="mb-2">Recent Activity</MudText>
            <MudPaper Elevation="1" Class="pa-4">
                <MudText Typo="Typo.body2" Color="Color.Secondary">No recent activity</MudText>
            </MudPaper>
        </Authorized>
        <NotAuthorized>
            <Sorcha.UI.Web.Client.Components.RedirectToLogin />
        </NotAuthorized>
    </AuthorizeView>
</CascadingAuthenticationState>

@code {
    private DashboardStatsViewModel _stats = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        _stats = await DashboardService.GetDashboardStatsAsync();
        _isLoading = false;

        if (_stats.IsLoaded && _stats.TotalWallets == 0)
        {
            Navigation.NavigateTo("wallets/create?first-login=true");
            return;
        }
    }
}
