@page "/login"
@layout AuthLayout
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@using Sorcha.UI.Core.Models.Authentication
@using Sorcha.UI.Core.Services.Authentication
@using Sorcha.UI.Core.Services.Configuration
@using Sorcha.UI.Web.Client.Components.Layout
@inject IAuthenticationService AuthService
@inject IConfigurationService ConfigService
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>Sign In - Sorcha</PageTitle>

<ErrorBoundary>
    <ChildContent>
        @if (!_profilesLoaded)
        {
            <div class="text-center" style="margin: 100px auto;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading profiles...</p>
            </div>
        }
        else
        {
            @if (_profileLoadError && !string.IsNullOrEmpty(_profileErrorMessage))
            {
                <div class="alert alert-info alert-dismissible fade show" style="max-width: 500px; margin: 20px auto;" role="alert">
                    <strong>Note:</strong> @_profileErrorMessage. Using default profiles.
                    <button type="button" class="btn-close" @onclick="@(() => _profileLoadError = false)"></button>
                </div>
            }

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger">@_errorMessage</div>
            }

            <div class="login-card">
                <div class="login-header">
                    <h2 class="login-title">Sign In</h2>
                    <p class="login-subtitle">Access your Sorcha account</p>
                </div>

                <div class="login-body">
                    <div class="mb-3">
                        <label class="form-label">Environment</label>
                        <select class="form-select" @bind="_selectedProfile">
                            @foreach (var profile in _profiles)
                            {
                                <option value="@profile.Name">@profile.Name</option>
                            }
                        </select>
                        @if (!string.IsNullOrEmpty(_selectedProfile))
                        {
                            var selectedProfileInfo = _profiles.FirstOrDefault(p => p.Name == _selectedProfile);
                            @if (selectedProfileInfo != null)
                            {
                                <small class="form-text text-muted">@selectedProfileInfo.Description</small>
                            }
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text"
                               class="form-control"
                               @bind="_username"
                               placeholder="Enter your username"
                               autocomplete="username" />
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Password</label>
                        <input type="password"
                               class="form-control"
                               @bind="_password"
                               placeholder="Enter your password"
                               autocomplete="current-password" />
                    </div>

                    <button class="btn btn-primary w-100 btn-lg" @onclick="HandleLogin" disabled="@_isLoading">
                        @if (_isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Signing in...</span>
                        }
                        else
                        {
                            <span>Sign In</span>
                        }
                    </button>
                </div>
            </div>

            <style>
                .login-card {
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                    overflow: hidden;
                }

                .login-header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 2rem;
                    text-align: center;
                }

                .login-title {
                    font-size: 2rem;
                    font-weight: 600;
                    margin: 0 0 0.5rem 0;
                }

                .login-subtitle {
                    margin: 0;
                    opacity: 0.9;
                    font-size: 1rem;
                }

                .login-body {
                    padding: 2rem;
                }

                .login-card .form-label {
                    font-weight: 500;
                    margin-bottom: 0.5rem;
                }

                .login-card .form-control,
                .login-card .form-select {
                    padding: 0.75rem 1rem;
                    font-size: 1rem;
                }

                .login-card .btn-primary {
                    padding: 0.75rem;
                    font-size: 1.1rem;
                    font-weight: 500;
                }
            </style>
        }
    </ChildContent>
    <ErrorContent Context="exception">
        <div class="alert alert-warning" style="max-width: 500px; margin: 50px auto;">
            <h5 class="alert-heading">Profile Loading Issue</h5>
            <p>Unable to load saved profiles. You can continue with the default development profile.</p>
            <hr>
            <button class="btn btn-primary" @onclick="UseDefaultProfilesAndContinue">
                Continue with Default Profile
            </button>
            <details class="mt-3">
                <summary>Error Details</summary>
                <pre class="mt-2 small">@exception.Message</pre>
            </details>
        </div>
    </ErrorContent>
</ErrorBoundary>

@code {
    private List<Profile> _profiles = new();
    private string _selectedProfile = "Development";
    private string _username = "";
    private string _password = "";
    private string _errorMessage = "";
    private bool _isLoading = false;
    private bool _profilesLoaded = true; // Start as loaded with hardcoded profiles
    private bool _profileLoadError = false;
    private string? _profileErrorMessage = null;

    protected override void OnInitialized()
    {
        // Use hardcoded profiles to avoid async initialization issues
        _profiles = new List<Profile>
        {
            new Profile
            {
                Name = "Development",
                ApiGatewayUrl = "https://localhost:7082",
                Description = "Local .NET Aspire development environment",
                IsSystemProfile = true
            },
            new Profile
            {
                Name = "Docker",
                ApiGatewayUrl = "http://localhost:8080",
                Description = "Docker Compose backend services",
                IsSystemProfile = true
            }
        };
        _selectedProfile = "Development";
        _profilesLoaded = true;
    }

    private void UseDefaultProfilesAndContinue()
    {
        // Create default profiles in memory
        _profiles = new List<Profile>
        {
            new Profile
            {
                Name = "Development",
                ApiGatewayUrl = "https://localhost:7082",
                Description = "Local development environment",
                IsSystemProfile = true
            },
            new Profile
            {
                Name = "Docker",
                ApiGatewayUrl = "http://localhost:8080",
                Description = "Docker Compose backend",
                IsSystemProfile = true
            }
        };
        _selectedProfile = "Development";
        _profilesLoaded = true;
        _errorMessage = "";

        // Force component to re-render and show the login form
        StateHasChanged();
    }

    private async Task HandleLogin()
    {
        _errorMessage = "";
        _isLoading = true;

        try
        {
            var request = new LoginRequest
            {
                Username = _username,
                Password = _password
            };

            if (!request.IsValid())
            {
                _errorMessage = "Please enter valid username and password";
                return;
            }

            // Set active profile
            await ConfigService.SetActiveProfileAsync(_selectedProfile);

            // Perform login
            var response = await AuthService.LoginAsync(request, _selectedProfile);

            // Notify authentication state changed
            AuthStateProvider.NotifyAuthenticationStateChanged();

            // Navigate to home
            Navigation.NavigateTo("/", forceLoad: true);
        }
        catch (HttpRequestException ex)
        {
            _errorMessage = $"Login failed: {ex.Message}";
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }
}
