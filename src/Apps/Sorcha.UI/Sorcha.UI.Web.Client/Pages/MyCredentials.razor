@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@page "/credentials"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using Sorcha.UI.Core.Components.Credentials
@using Sorcha.UI.Core.Components.Shared
@using Sorcha.UI.Core.Models.Credentials
@using Sorcha.UI.Core.Services.Credentials
@using Sorcha.UI.Core.Services.Wallet
@inject ICredentialApiService CredentialApi
@inject IWalletApiService WalletApi
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>My Credentials - Sorcha Platform</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudStack Spacing="0">
            <MudText Typo="Typo.h4">
                <MudIcon Icon="@Icons.Material.Filled.Badge" Class="mr-2" />
                My Credentials
            </MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Verifiable credentials issued through workflow actions
            </MudText>
        </MudStack>

        @if (_walletAddresses.Count > 1)
        {
            <MudSelect T="string" Value="_selectedWallet" ValueChanged="OnWalletChanged"
                       Label="Wallet" Variant="Variant.Outlined" Margin="Margin.Dense"
                       Style="max-width: 300px">
                @foreach (var wallet in _walletAddresses)
                {
                    <MudSelectItem T="string" Value="@wallet">
                        @(wallet.Length > 12 ? wallet[..6] + "..." + wallet[^6..] : wallet)
                    </MudSelectItem>
                }
            </MudSelect>
        }
    </MudStack>

    @if (_serviceError)
    {
        <ServiceUnavailable ServiceName="Wallet Service" OnRetry="LoadAllAsync" />
    }
    else if (_loading)
    {
        <MudGrid>
            @for (var i = 0; i < 4; i++)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Elevation="2" Style="border-radius: 12px">
                        <MudCardContent>
                            <MudSkeleton Width="60%" Height="24px" Class="mb-2" />
                            <MudSkeleton Width="100%" Height="16px" Class="mb-2" />
                            <MudSkeleton Width="40%" Height="16px" />
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else
    {
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" Class="mb-4">
            <MudTabPanel Text="Credentials" Icon="@Icons.Material.Filled.Badge">
                <CredentialCardList Credentials="_credentials"
                                    OnViewClick="OnViewCredential"
                                    OnPresentClick="OnPresentCredential" />
            </MudTabPanel>
            <MudTabPanel Icon="@Icons.Material.Filled.Inbox"
                         BadgeData="@(_pendingRequests.Count > 0 ? _pendingRequests.Count.ToString() : null)"
                         BadgeColor="Color.Error">
                <ChildContent>
                    @* Presentation Request Inbox *@
                    @if (_pendingRequests.Count > 0)
                    {
                        <MudList T="string">
                            @foreach (var request in _pendingRequests)
                            {
                                <MudListItem T="string" OnClick="@(() => OnOpenRequest(request))">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1">
                                                <strong>@request.VerifierIdentity</strong>
                                            </MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                Requesting: @request.CredentialType
                                            </MudText>
                                        </MudStack>
                                        <MudStack AlignItems="AlignItems.End" Spacing="0">
                                            <MudChip T="string" Color="Color.Warning" Size="MudBlazor.Size.Small" Variant="Variant.Outlined">
                                                @FormatTimeRemaining(request)
                                            </MudChip>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @request.MatchingCredentials.Count match(es)
                                            </MudText>
                                        </MudStack>
                                    </MudStack>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else
                    {
                        <MudPaper Elevation="0" Class="pa-8 d-flex flex-column align-center justify-center" Style="min-height: 200px">
                            <MudIcon Icon="@Icons.Material.Filled.Inbox" Size="MudBlazor.Size.Large" Color="Color.Default" Class="mb-4" />
                            <MudText Typo="Typo.h6" Color="Color.Secondary">No Pending Requests</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-1">
                                Presentation requests from verifiers will appear here.
                            </MudText>
                        </MudPaper>
                    }
                </ChildContent>
                <TabContent>
                    <MudText>Inbox</MudText>
                </TabContent>
            </MudTabPanel>
        </MudTabs>
    }
</MudContainer>

@code {
    private List<CredentialCardViewModel> _credentials = new();
    private List<PresentationRequestViewModel> _pendingRequests = new();
    private List<string> _walletAddresses = new();
    private string _selectedWallet = string.Empty;
    private bool _loading = true;
    private bool _serviceError;

    protected override async Task OnInitializedAsync()
    {
        await LoadWalletsAsync();
    }

    private async Task LoadWalletsAsync()
    {
        try
        {
            var wallets = await WalletApi.GetWalletsAsync();
            _walletAddresses = wallets.Select(w => w.Address).ToList();

            if (_walletAddresses.Count > 0)
            {
                _selectedWallet = _walletAddresses[0];
                await LoadAllAsync();
            }
            else
            {
                _loading = false;
            }
        }
        catch
        {
            _serviceError = true;
            _loading = false;
        }
    }

    private async Task LoadAllAsync()
    {
        _loading = true;
        _serviceError = false;
        StateHasChanged();

        try
        {
            var credentialTask = CredentialApi.GetCredentialsAsync(_selectedWallet);
            var requestsTask = CredentialApi.GetPresentationRequestsAsync(_selectedWallet);

            await Task.WhenAll(credentialTask, requestsTask);

            _credentials = credentialTask.Result;
            _pendingRequests = requestsTask.Result
                .Where(r => r.Status == "Pending" && !r.IsExpired)
                .OrderBy(r => r.ExpiresAt)
                .ToList();

            _loading = false;
        }
        catch
        {
            _serviceError = true;
            _loading = false;
        }
    }

    private async Task OnWalletChanged(string walletAddress)
    {
        _selectedWallet = walletAddress;
        await LoadAllAsync();
    }

    private async Task OnViewCredential(CredentialCardViewModel credential)
    {
        var detail = await CredentialApi.GetCredentialDetailAsync(
            _selectedWallet, credential.CredentialId);

        if (detail == null)
        {
            Snackbar.Add("Could not load credential details.", Severity.Error);
            return;
        }

        var parameters = new DialogParameters<CredentialDetailView>
        {
            { x => x.Credential, detail },
            { x => x.OnDelete, EventCallback.Factory.Create(this, async () =>
                {
                    var deleted = await CredentialApi.DeleteCredentialAsync(
                        _selectedWallet, credential.CredentialId);
                    if (deleted)
                    {
                        Snackbar.Add("Credential deleted.", Severity.Success);
                        await LoadAllAsync();
                    }
                    else
                    {
                        Snackbar.Add("Failed to delete credential.", Severity.Error);
                    }
                })
            }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        await DialogService.ShowAsync<CredentialDetailView>("Credential Details", parameters, options);
    }

    private Task OnPresentCredential(CredentialCardViewModel credential)
    {
        Snackbar.Add("Presentation flow coming soon.", Severity.Info);
        return Task.CompletedTask;
    }

    private async Task OnOpenRequest(PresentationRequestViewModel request)
    {
        var detail = await CredentialApi.GetPresentationRequestDetailAsync(request.RequestId);
        if (detail == null)
        {
            Snackbar.Add("Could not load request details.", Severity.Error);
            return;
        }

        var parameters = new DialogParameters<PresentationRequestDialog>
        {
            { x => x.Request, detail },
            { x => x.OnSubmitted, EventCallback.Factory.Create<PresentationSubmitResult>(this, async result =>
                {
                    Snackbar.Add($"Presentation {result.Status}.", Severity.Success);
                    await LoadAllAsync();
                })
            },
            { x => x.OnDenied, EventCallback.Factory.Create(this, async () =>
                {
                    Snackbar.Add("Request denied.", Severity.Info);
                    await LoadAllAsync();
                })
            }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        await DialogService.ShowAsync<PresentationRequestDialog>("Presentation Request", parameters, options);
    }

    private static string FormatTimeRemaining(PresentationRequestViewModel request)
    {
        var remaining = request.TimeRemaining;
        if (remaining.TotalHours >= 1) return $"{(int)remaining.TotalHours}h {remaining.Minutes}m left";
        if (remaining.TotalMinutes >= 1) return $"{(int)remaining.TotalMinutes}m left";
        return "expiring soon";
    }
}
