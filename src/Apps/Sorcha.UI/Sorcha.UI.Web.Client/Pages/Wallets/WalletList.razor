@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@page "/wallets"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]
@using Sorcha.UI.Core.Components.Shared
@inject IWalletApiService WalletService
@inject IWalletPreferenceService WalletPreferenceService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<PageTitle>Wallets - Sorcha Platform</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-2">
        <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Class="mr-2" />
        Wallet Management
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        Manage your HD wallets for cryptographic signing and address generation
    </MudText>

    <MudGrid>
        <MudItem xs="12">
            <MudPaper Class="pa-4 mb-4" Elevation="2">
                <div class="d-flex justify-space-between align-center flex-wrap gap-2">
                    <MudTextField T="string" @bind-Value="searchText" Placeholder="Search wallets..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Variant="Variant.Outlined" Class="flex-grow-1 mr-3" Style="max-width: 400px;" />
                    <div class="d-flex gap-2 align-center">
                        <MudToggleIconButton Toggled="@isTableView"
                                             ToggledChanged="@(v => isTableView = v)"
                                             Icon="@Icons.Material.Filled.GridView"
                                             ToggledIcon="@Icons.Material.Filled.TableRows"
                                             Title="Switch to table view"
                                             ToggledTitle="Switch to card view"
                                             Size="Size.Medium"
                                             Color="Color.Default"
                                             ToggledColor="Color.Primary" />
                        <MudButton Href="wallets/recover" Color="Color.Secondary" Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Restore">
                            Recover Wallet
                        </MudButton>
                        <MudButton Href="wallets/create" Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add">
                            Create Wallet
                        </MudButton>
                    </div>
                </div>
            </MudPaper>
        </MudItem>

        @if (isLoading)
        {
            <MudItem xs="12">
                <MudPaper Class="pa-8 text-center" Elevation="2">
                    <MudProgressCircular Indeterminate="true" Size="Size.Large" />
                    <MudText Typo="Typo.body1" Class="mt-4">Loading wallets...</MudText>
                </MudPaper>
            </MudItem>
        }
        else if (error != null)
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Error" Class="mb-4">
                    @error
                </MudAlert>
            </MudItem>
        }
        else if (filteredWallets.Any())
        {
            @if (isTableView)
            {
                <MudItem xs="12">
                    <MudTable Items="@filteredWallets" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="2" Dense="true">
                        <HeaderContent>
                            <MudTh>Name</MudTh>
                            <MudTh>Address</MudTh>
                            <MudTh>Algorithm</MudTh>
                            <MudTh>Status</MudTh>
                            <MudTh>Created</MudTh>
                            <MudTh Style="text-align: right;">Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Name">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    @if (context.Address == defaultWalletAddress)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" Title="Default Wallet" />
                                    }
                                    <MudLink Href="@($"wallets/{context.Address}")" Typo="Typo.body2">@context.Name</MudLink>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Address">
                                <TruncatedId Value="@context.Address" />
                            </MudTd>
                            <MudTd DataLabel="Algorithm">
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary">@context.Algorithm</MudChip>
                            </MudTd>
                            <MudTd DataLabel="Status">
                                <MudChip T="string" Color="GetStatusColor(context.Status)" Size="Size.Small">@context.Status</MudChip>
                            </MudTd>
                            <MudTd DataLabel="Created">@context.CreatedAt.ToString("MMM dd, yyyy")</MudTd>
                            <MudTd DataLabel="Actions" Style="text-align: right;">
                                <MudStack Row="true" Spacing="0" Justify="Justify.FlexEnd">
                                    @if (context.Address != defaultWalletAddress)
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.StarOutline" Size="Size.Small" Title="Set as Default" OnClick="() => SetDefaultWallet(context)" />
                                    }
                                    else
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" Title="Default Wallet" Disabled="true" />
                                    }
                                    <MudIconButton Icon="@Icons.Material.Filled.QrCode2" Size="Size.Small" Title="Show QR Code" OnClick="() => ShowQrCode(context)" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Share" Size="Size.Small" Title="Copy Address" OnClick="() => CopyAddress(context)" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" Title="Delete" OnClick="() => ConfirmDelete(context)" />
                                </MudStack>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudItem>
            }
            else
            {
                @foreach (var wallet in filteredWallets)
                {
                    <MudItem xs="12" md="6" lg="4">
                        <MudCard Elevation="2" Class="wallet-card" @onclick="() => ViewWallet(wallet.Address)" Style="cursor: pointer;">
                            <MudCardHeader>
                                <CardHeaderAvatar>
                                    <MudAvatar Color="GetAlgorithmColor(wallet.Algorithm)" Size="Size.Medium">
                                        <MudIcon Icon="@Icons.Material.Filled.Key" />
                                    </MudAvatar>
                                </CardHeaderAvatar>
                                <CardHeaderContent>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        @if (wallet.Address == defaultWalletAddress)
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" Title="Default Wallet" />
                                        }
                                        <MudText Typo="Typo.h6">@wallet.Name</MudText>
                                    </MudStack>
                                    <TruncatedId Value="@wallet.Address" />
                                </CardHeaderContent>
                                <CardHeaderActions>
                                    <MudChip T="string" Color="GetStatusColor(wallet.Status)" Size="Size.Small">
                                        @wallet.Status
                                    </MudChip>
                                </CardHeaderActions>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudStack Row="true" Spacing="2" Class="mb-2">
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary">
                                        @wallet.Algorithm
                                    </MudChip>
                                </MudStack>
                                <MudDivider Class="my-2" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Class="mr-1" />
                                    Created @wallet.CreatedAt.ToString("MMM dd, yyyy")
                                </MudText>
                            </MudCardContent>
                            <MudCardActions>
                                <span @onclick:stopPropagation="true">
                                    @if (wallet.Address != defaultWalletAddress)
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.StarOutline" Size="Size.Small" Title="Set as Default" OnClick="() => SetDefaultWallet(wallet)" />
                                    }
                                    else
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" Title="Default Wallet" Disabled="true" />
                                    }
                                </span>
                                <span @onclick:stopPropagation="true">
                                    <MudIconButton Icon="@Icons.Material.Filled.QrCode2" Size="Size.Small" Title="Show QR Code" OnClick="() => ShowQrCode(wallet)" />
                                </span>
                                <span @onclick:stopPropagation="true">
                                    <MudIconButton Icon="@Icons.Material.Filled.Share" Size="Size.Small" Title="Copy Address" OnClick="() => CopyAddress(wallet)" />
                                </span>
                                <MudSpacer />
                                <span @onclick:stopPropagation="true">
                                    <MudButton Color="Color.Primary" Variant="Variant.Text" OnClick="() => ViewWallet(wallet.Address)">
                                        View Details
                                    </MudButton>
                                </span>
                                <span @onclick:stopPropagation="true">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="() => ConfirmDelete(wallet)" />
                                </span>
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            }
        }
        else
        {
            <MudItem xs="12">
                <MudPaper Class="pa-8 text-center" Elevation="2">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Size="Size.Large" Color="Color.Secondary" Class="mb-3" />
                    <MudText Typo="Typo.h6" Class="mb-2">No Wallets Found</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                        Get started by creating your first wallet or recovering an existing one
                    </MudText>
                    <MudStack Row="true" Justify="Justify.Center" Spacing="2">
                        <MudButton Href="wallets/recover" Color="Color.Secondary" Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Restore">
                            Recover Wallet
                        </MudButton>
                        <MudButton Href="wallets/create" Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add">
                            Create Wallet
                        </MudButton>
                    </MudStack>
                </MudPaper>
            </MudItem>
        }
    </MudGrid>
</MudContainer>

@code {
    private string searchText = "";
    private List<WalletDto> wallets = new();
    private bool isLoading = true;
    private bool isTableView;
    private string? error;
    private string? defaultWalletAddress;

    private IEnumerable<WalletDto> filteredWallets => string.IsNullOrWhiteSpace(searchText)
        ? wallets
        : wallets.Where(w =>
            w.Name.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
            w.Address.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
            w.Algorithm.Contains(searchText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadWalletsAsync();
        await LoadDefaultWalletAsync();
    }

    private async Task LoadWalletsAsync()
    {
        isLoading = true;
        error = null;

        try
        {
            wallets = await WalletService.GetWalletsAsync();
        }
        catch (HttpRequestException ex)
        {
            error = $"Failed to load wallets: {ex.Message}";
        }
        catch (Exception ex)
        {
            error = $"An unexpected error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadDefaultWalletAsync()
    {
        try
        {
            defaultWalletAddress = await WalletPreferenceService.GetDefaultWalletAsync();
        }
        catch
        {
            // Non-critical â€” default indicator just won't show
        }
    }

    private void ViewWallet(string address)
    {
        Navigation.NavigateTo($"wallets/{address}");
    }

    private async Task SetDefaultWallet(WalletDto wallet)
    {
        try
        {
            await WalletPreferenceService.SetDefaultWalletAsync(wallet.Address);
            defaultWalletAddress = wallet.Address;
            Snackbar.Add($"'{wallet.Name}' set as default wallet", Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to set default wallet: {ex.Message}", Severity.Error);
        }
    }

    private async Task ShowQrCode(WalletDto wallet)
    {
        var parameters = new DialogParameters<WalletQrDialog>
        {
            { x => x.WalletName, wallet.Name },
            { x => x.WalletAddress, wallet.Address }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.ExtraSmall,
            FullWidth = false,
            CloseOnEscapeKey = true
        };

        await DialogService.ShowAsync<WalletQrDialog>("QR Code", parameters, options);
    }

    private async Task CopyAddress(WalletDto wallet)
    {
        try
        {
            await JS.InvokeVoidAsync("QrCodeHelper.copyToClipboard", wallet.Address);
            Snackbar.Add($"Address for '{wallet.Name}' copied to clipboard", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Failed to copy address to clipboard", Severity.Error);
        }
    }

    private async Task ConfirmDelete(WalletDto wallet)
    {
        var parameters = new DialogParameters<ConfirmDialog>
        {
            { x => x.ContentText, $"Are you sure you want to delete wallet '{wallet.Name}'? This action can be reversed by support." },
            { x => x.ButtonText, "Delete" },
            { x => x.Color, Color.Error }
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Wallet", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await DeleteWalletAsync(wallet);
        }
    }

    private async Task DeleteWalletAsync(WalletDto wallet)
    {
        try
        {
            var success = await WalletService.DeleteWalletAsync(wallet.Address);
            if (success)
            {
                wallets.Remove(wallet);

                // Clear default if deleted wallet was the default
                if (wallet.Address == defaultWalletAddress)
                {
                    await WalletPreferenceService.ClearDefaultWalletAsync();
                    defaultWalletAddress = null;
                }

                Snackbar.Add($"Wallet '{wallet.Name}' deleted successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add("Wallet not found", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to delete wallet: {ex.Message}", Severity.Error);
        }
    }

    private static Color GetStatusColor(string status) => status.ToUpperInvariant() switch
    {
        "ACTIVE" => Color.Success,
        "ARCHIVED" => Color.Warning,
        "DELETED" => Color.Error,
        "LOCKED" => Color.Info,
        _ => Color.Default
    };

    private static Color GetAlgorithmColor(string algorithm) => algorithm.ToUpperInvariant() switch
    {
        "ED25519" => Color.Primary,
        "NISTP256" => Color.Secondary,
        "RSA4096" => Color.Tertiary,
        _ => Color.Default
    };
}
