@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@inject IJSRuntime JS
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.QrCode2" />
            <MudText Typo="Typo.h6">Wallet QR Code</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack AlignItems="AlignItems.Center" Spacing="3" Class="pa-4">
            <MudText Typo="Typo.subtitle1" Align="Align.Center">
                <strong>@WalletName</strong>
            </MudText>

            <div id="@_qrElementId" style="width: 256px; height: 256px; display: flex; align-items: center; justify-content: center;">
                <MudProgressCircular Indeterminate="true" Size="Size.Medium" />
            </div>

            <MudText Typo="Typo.body2" Align="Align.Center" Style="font-family: monospace; word-break: break-all; max-width: 320px;">
                @WalletAddress
            </MudText>

            <MudButton StartIcon="@Icons.Material.Filled.ContentCopy"
                       Color="Color.Primary"
                       Variant="Variant.Outlined"
                       OnClick="CopyAddressAsync">
                Copy Address
            </MudButton>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close" Color="Color.Default">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public string WalletName { get; set; } = string.Empty;

    [Parameter]
    public string WalletAddress { get; set; } = string.Empty;

    private readonly string _qrElementId = $"qr-{Guid.NewGuid():N}";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !string.IsNullOrEmpty(WalletAddress))
        {
            try
            {
                await JS.InvokeVoidAsync("QrCodeHelper.generate", _qrElementId, WalletAddress, 256);
            }
            catch
            {
                // QR library may not be loaded â€” fail silently
            }
        }
    }

    private async Task CopyAddressAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("QrCodeHelper.copyToClipboard", WalletAddress);
            Snackbar.Add("Address copied to clipboard", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Failed to copy address", Severity.Error);
        }
    }

    private void Close() => MudDialog.Close();
}
