@page "/auth/logout"
@layout AuthLayout
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@using Sorcha.UI.Web.Client.Components.Layout
@using Sorcha.UI.Core.Services.Authentication
@using Sorcha.UI.Core.Services.Configuration
@inject IAuthenticationService AuthService
@inject IConfigurationService ConfigService
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>Logout - Sorcha</PageTitle>

<div class="text-center" style="margin: 100px auto;">
    @if (_isLoggingOut)
    {
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Signing out...</span>
        </div>
        <p class="mt-3">Signing out...</p>
    }
    else
    {
        <div class="alert alert-success">
            <h5>Logged Out Successfully</h5>
            <p>You have been signed out.</p>
            <a href="auth/login" class="btn btn-primary mt-2">Sign In Again</a>
        </div>
    }
</div>

@code {
    private bool _isLoggingOut = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get active profile
            var activeProfile = await ConfigService.GetActiveProfileNameAsync();

            // Logout
            await AuthService.LogoutAsync(activeProfile);

            // Notify authentication state changed
            AuthStateProvider.NotifyAuthenticationStateChanged();

            // Wait a moment to show the message
            await Task.Delay(500);

            _isLoggingOut = false;
            StateHasChanged();

            // Auto-redirect after 2 seconds
            await Task.Delay(2000);
            Navigation.NavigateTo("auth/login", forceLoad: false);
        }
        catch (Exception)
        {
            _isLoggingOut = false;
            StateHasChanged();
        }
    }
}
