@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@page "/my-workflows"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using Sorcha.UI.Core.Components.Workflows
@using Sorcha.UI.Core.Models.Workflows
@using Sorcha.UI.Core.Services
@inject IWorkflowService WorkflowService
@inject ISnackbar Snackbar

<PageTitle>My Workflows - Sorcha Platform</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-2">
        <MudIcon Icon="@Icons.Material.Filled.AccountTree" Class="mr-2" />
        My Workflows
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        View and manage your active workflows
    </MudText>

    @if (_error != null)
    {
        <ServiceUnavailable ServiceName="Blueprint Service" OnRetry="LoadWorkflowsAsync" />
    }
    else if (_selectedWorkflow != null)
    {
        <WorkflowDetail InstanceId="@_selectedWorkflow.InstanceId" OnClose="ClearSelection" />
    }
    else
    {
        <MudStack Spacing="4">
            @* Statistics *@
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Color="Color.Info" Size="Size.Large" />
                            <MudText Typo="Typo.h4">@_workflows.Count(w => w.Status == "active")</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Active</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" />
                            <MudText Typo="Typo.h4">@_workflows.Count(w => w.Status == "completed")</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Completed</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Large" />
                            <MudText Typo="Typo.h4">@_workflows.Count(w => w.Status == "failed")</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Failed</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.List" Color="Color.Primary" Size="Size.Large" />
                            <MudText Typo="Typo.h4">@_workflows.Count</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            @* Workflow List *@
            <WorkflowList Workflows="_workflows" IsLoading="_isLoading" OnSelect="SelectWorkflow" />
        </MudStack>
    }
</MudContainer>

@code {
    private List<WorkflowInstanceViewModel> _workflows = [];
    private WorkflowInstanceViewModel? _selectedWorkflow;
    private bool _isLoading = true;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkflowsAsync();
    }

    private async Task LoadWorkflowsAsync()
    {
        _isLoading = true;
        _error = null;

        try
        {
            var result = await WorkflowService.GetMyWorkflowsAsync();
            _workflows = result.Items?.ToList() ?? [];
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void SelectWorkflow(WorkflowInstanceViewModel workflow)
    {
        _selectedWorkflow = workflow;
    }

    private void ClearSelection()
    {
        _selectedWorkflow = null;
    }
}
