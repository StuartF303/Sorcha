@page "/my-workflows"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>My Workflows - Sorcha Platform</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-2">
        <MudIcon Icon="@Icons.Material.Filled.AccountTree" Class="mr-2" />
        My Workflows
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        View and manage your active workflows
    </MudText>

    <MudGrid>
        @* Statistics cards *@
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Color="Color.Info" Size="Size.Large" />
                    <MudText Typo="Typo.h4">@_workflows.Count(w => w.Status == "In Progress")</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">In Progress</MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.Pending" Color="Color.Warning" Size="Size.Large" />
                    <MudText Typo="Typo.h4">@_workflows.Count(w => w.Status == "Pending")</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Pending</MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" />
                    <MudText Typo="Typo.h4">@_workflows.Count(w => w.Status == "Completed")</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Completed</MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.List" Color="Color.Primary" Size="Size.Large" />
                    <MudText Typo="Typo.h4">@_workflows.Count</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Total</MudText>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6">Active Workflows</MudText>
                    <MudTextField T="string" @bind-Value="_searchText" Placeholder="Search workflows..."
                                  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                                  Variant="Variant.Outlined" Margin="Margin.Dense" Style="max-width: 300px;" />
                </MudStack>

                <MudTable Items="@FilteredWorkflows" Hover="true" Striped="true" Loading="@_loading">
                    <HeaderContent>
                        <MudTh><MudTableSortLabel SortBy="new Func<WorkflowItem, object>(x => x.Name)">Workflow</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel SortBy="new Func<WorkflowItem, object>(x => x.Blueprint)">Blueprint</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel SortBy="new Func<WorkflowItem, object>(x => x.Status)">Status</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel SortBy="new Func<WorkflowItem, object>(x => x.StartedAt)">Started</MudTableSortLabel></MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Workflow">@context.Name</MudTd>
                        <MudTd DataLabel="Blueprint">@context.Blueprint</MudTd>
                        <MudTd DataLabel="Status">
                            <MudChip T="string" Size="Size.Small" Color="@context.StatusColor">@context.Status</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Started">@context.StartedAt.ToString("MMM dd, yyyy")</MudTd>
                        <MudTd DataLabel="Actions">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Primary"
                                           OnClick="() => ViewWorkflow(context)" title="View Details" />
                            <MudIconButton Icon="@Icons.Material.Filled.Timeline" Size="Size.Small" Color="Color.Info"
                                           OnClick="() => ViewTimeline(context)" title="View Timeline" />
                        </MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager />
                    </PagerContent>
                </MudTable>
            </MudPaper>
        </MudItem>

        <MudItem xs="12">
            <MudAlert Severity="Severity.Info" Class="mt-4">
                <MudText Typo="Typo.body2">
                    This is a placeholder page. Full workflow execution functionality will be implemented in future versions.
                </MudText>
            </MudAlert>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<WorkflowItem> _workflows = new();
    private string _searchText = "";
    private bool _loading = false;

    private IEnumerable<WorkflowItem> FilteredWorkflows => string.IsNullOrWhiteSpace(_searchText)
        ? _workflows
        : _workflows.Where(w => w.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                               w.Blueprint.Contains(_searchText, StringComparison.OrdinalIgnoreCase));

    protected override void OnInitialized()
    {
        LoadSampleWorkflows();
    }

    private void LoadSampleWorkflows()
    {
        _workflows = new List<WorkflowItem>
        {
            new WorkflowItem { Name = "Loan Application #1234", Blueprint = "Loan Application Workflow", Status = "In Progress", StatusColor = Color.Info, StartedAt = DateTime.Now.AddDays(-2) },
            new WorkflowItem { Name = "Supply Chain Verification #5678", Blueprint = "Supply Chain Verification", Status = "In Progress", StatusColor = Color.Info, StartedAt = DateTime.Now.AddDays(-5) },
            new WorkflowItem { Name = "Document Approval #9012", Blueprint = "Document Approval Flow", Status = "Pending", StatusColor = Color.Warning, StartedAt = DateTime.Now.AddDays(-1) },
            new WorkflowItem { Name = "Loan Application #1133", Blueprint = "Loan Application Workflow", Status = "Completed", StatusColor = Color.Success, StartedAt = DateTime.Now.AddDays(-10) },
            new WorkflowItem { Name = "Supply Chain Verification #4455", Blueprint = "Supply Chain Verification", Status = "Completed", StatusColor = Color.Success, StartedAt = DateTime.Now.AddDays(-15) },
        };
    }

    private void ViewWorkflow(WorkflowItem workflow)
    {
        Snackbar.Add($"Viewing workflow: {workflow.Name}", Severity.Info);
        // In production: Navigation.NavigateTo($"/workflows/{workflow.Id}");
    }

    private void ViewTimeline(WorkflowItem workflow)
    {
        Snackbar.Add($"Viewing timeline for: {workflow.Name}", Severity.Info);
        // In production: Navigation.NavigateTo($"/workflows/{workflow.Id}/timeline");
    }

    public class WorkflowItem
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Name { get; set; } = "";
        public string Blueprint { get; set; } = "";
        public string Status { get; set; } = "";
        public Color StatusColor { get; set; }
        public DateTime StartedAt { get; set; }
    }
}
