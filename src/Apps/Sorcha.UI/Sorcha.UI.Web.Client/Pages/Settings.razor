@page "/settings"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using Sorcha.UI.Core.Models
@using Sorcha.UI.Core.Models.Configuration
@using Sorcha.UI.Core.Services
@using Sorcha.UI.Core.Services.Configuration
@using Sorcha.UI.Core.Components.Configuration
@inject IUserPreferencesService PreferencesService
@inject IConfigurationService ConfigService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Settings - Sorcha Platform</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-2">
        <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" />
        Settings
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        Configure your experience, security, and connection profiles
    </MudText>

    <MudPaper Class="pa-4" Elevation="2">
        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">

            <!-- Appearance Tab -->
            <MudTabPanel Text="Appearance" Icon="@Icons.Material.Filled.Palette">
                <MudText Typo="Typo.h6" Class="mb-3">Theme</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    Choose how Sorcha looks to you. Select a theme or let the app match your system settings.
                </MudText>

                <MudRadioGroup T="string" Value="@_preferences.Theme" ValueChanged="OnThemeChanged">
                    <MudRadio T="string" Value="@("Light")" Color="Color.Primary">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.LightMode" Class="mr-2" />
                            Light
                        </div>
                    </MudRadio>
                    <MudRadio T="string" Value="@("Dark")" Color="Color.Primary">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.DarkMode" Class="mr-2" />
                            Dark
                        </div>
                    </MudRadio>
                    <MudRadio T="string" Value="@("System")" Color="Color.Primary">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.SettingsBrightness" Class="mr-2" />
                            System Default
                        </div>
                    </MudRadio>
                </MudRadioGroup>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.h6" Class="mb-3">Time Format</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    How timestamps are displayed throughout the application.
                </MudText>

                <MudRadioGroup T="string" Value="@_preferences.TimeFormat" ValueChanged="OnTimeFormatChanged">
                    <MudRadio T="string" Value="@("UTC")" Color="Color.Primary">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Public" Class="mr-2" />
                            UTC — Consistent across all locations
                        </div>
                    </MudRadio>
                    <MudRadio T="string" Value="@("Local")" Color="Color.Primary">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Class="mr-2" />
                            Local — Adjusted to your timezone
                        </div>
                    </MudRadio>
                </MudRadioGroup>
            </MudTabPanel>

            <!-- Language Tab -->
            <MudTabPanel Text="Language" Icon="@Icons.Material.Filled.Language">
                <MudText Typo="Typo.h6" Class="mb-3">Display Language</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    Select the language used throughout the application interface.
                </MudText>

                <MudList T="string" Dense="true" Class="mb-4" Style="max-width: 400px;">
                    @foreach (var lang in _supportedLanguages)
                    {
                        <MudListItem T="string"
                                     Icon="@(lang.Code == _preferences.Language ? Icons.Material.Filled.RadioButtonChecked : Icons.Material.Filled.RadioButtonUnchecked)"
                                     IconColor="@(lang.Code == _preferences.Language ? Color.Primary : Color.Default)"
                                     OnClick="@(() => OnLanguageChanged(lang.Code))">
                            <div class="d-flex align-center justify-space-between" style="width: 100%;">
                                <MudText>@lang.Name</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@lang.NativeName</MudText>
                            </div>
                        </MudListItem>
                    }
                </MudList>
            </MudTabPanel>

            <!-- Security Tab -->
            <MudTabPanel Text="Security" Icon="@Icons.Material.Filled.Security">
                <MudText Typo="Typo.h6" Class="mb-3">Two-Factor Authentication</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    Add an extra layer of security to your account by requiring a verification code on each login.
                </MudText>

                @if (_preferences.TwoFactorEnabled)
                {
                    <MudAlert Severity="Severity.Success" Class="mb-4">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Class="mr-2" />
                            Two-factor authentication is enabled.
                        </div>
                    </MudAlert>

                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Error"
                               StartIcon="@Icons.Material.Filled.RemoveCircle"
                               OnClick="DisableTwoFactor">
                        Disable 2FA
                    </MudButton>
                }
                else
                {
                    <MudAlert Severity="Severity.Warning" Class="mb-4">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Warning" Class="mr-2" />
                            Two-factor authentication is not enabled. Your account is less secure.
                        </div>
                    </MudAlert>

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Security"
                               OnClick="SetupTwoFactor">
                        Enable 2FA
                    </MudButton>
                }

                @if (_showTotpSetup)
                {
                    <MudDivider Class="my-4" />
                    <MudPaper Class="pa-4" Outlined="true">
                        <MudText Typo="Typo.subtitle1" Class="mb-3">Setup Authenticator App</MudText>
                        <MudText Typo="Typo.body2" Class="mb-3">
                            Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)
                        </MudText>

                        @if (!string.IsNullOrEmpty(_totpQrUri))
                        {
                            <div class="d-flex justify-center mb-4">
                                <div id="totp-qr-code" style="width: 200px; height: 200px; background: #f5f5f5; display: flex; align-items: center; justify-content: center;">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">QR Code</MudText>
                                </div>
                            </div>

                            <MudText Typo="Typo.caption" Class="mb-3" Align="Align.Center">
                                Or enter this key manually: <code>@_totpSecret</code>
                            </MudText>
                        }

                        <MudTextField @bind-Value="_totpVerificationCode"
                                      Label="Verification Code"
                                      Placeholder="Enter 6-digit code"
                                      Variant="Variant.Outlined"
                                      MaxLength="6"
                                      Style="max-width: 300px;"
                                      Class="mb-3" />

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Disabled="@(string.IsNullOrEmpty(_totpVerificationCode) || _totpVerificationCode.Length != 6)"
                                   OnClick="VerifyTotpSetup">
                            Verify and Enable
                        </MudButton>

                        @if (_totpBackupCodes.Any())
                        {
                            <MudDivider Class="my-4" />
                            <MudAlert Severity="Severity.Warning" Class="mb-3">
                                Save these backup codes in a safe place. Each code can only be used once.
                            </MudAlert>
                            <MudPaper Class="pa-3" Outlined="true" Style="max-width: 300px;">
                                @foreach (var totpCode in _totpBackupCodes)
                                {
                                    <MudText Typo="Typo.body2" Style="font-family: monospace;">@totpCode</MudText>
                                }
                            </MudPaper>
                        }
                    </MudPaper>
                }
            </MudTabPanel>

            <!-- Notifications Tab -->
            <MudTabPanel Text="Notifications" Icon="@Icons.Material.Filled.Notifications">
                <MudText Typo="Typo.h6" Class="mb-3">Push Notifications</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    Receive browser notifications when you have pending actions or important events.
                </MudText>

                <MudSwitch T="bool" Value="@_preferences.NotificationsEnabled"
                           ValueChanged="OnNotificationsChanged"
                           Color="Color.Primary"
                           Label="@(_preferences.NotificationsEnabled ? "Push notifications are enabled" : "Push notifications are disabled")" />

                @if (_preferences.NotificationsEnabled)
                {
                    <MudDivider Class="my-4" />
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Notification Types</MudText>
                    <MudCheckBox T="bool" Value="true" Disabled="true" Color="Color.Primary"
                                 Label="Pending actions requiring your attention" />
                    <MudCheckBox T="bool" Value="true" Disabled="true" Color="Color.Primary"
                                 Label="Blueprint workflow state changes" />
                    <MudCheckBox T="bool" Value="true" Disabled="true" Color="Color.Primary"
                                 Label="Validator alerts and warnings" />
                }
            </MudTabPanel>

            <!-- Connections Tab (was Configuration) -->
            <MudTabPanel Text="Connections" Icon="@Icons.Material.Filled.Dns">
                <MudText Typo="Typo.h6" Class="mb-3">Connection Profiles</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    Manage connection profiles for different Sorcha environments (local, docker, production).
                </MudText>

                <!-- Active Profile Display -->
                @if (_activeProfile != null)
                {
                    <MudAlert Severity="Severity.Info" Class="mb-4">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
                            <div>
                                <strong>Active Profile:</strong> @_activeProfile.Name
                                <br />
                                <MudText Typo="Typo.caption">
                                    @if (!string.IsNullOrEmpty(_activeProfile.SorchaServiceUrl))
                                    {
                                        <span>Base URL: @_activeProfile.SorchaServiceUrl</span>
                                    }
                                    else
                                    {
                                        <span>Using individual service URLs</span>
                                    }
                                </MudText>
                            </div>
                        </div>
                    </MudAlert>
                }

                <!-- Profile List -->
                @if (_loading)
                {
                    <MudProgressLinear Indeterminate="true" Class="mb-4" />
                }
                else if (_profiles.Any())
                {
                    <MudTable Items="@_profiles.OrderBy(p => p.Name)" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true" Class="mb-4">
                        <HeaderContent>
                            <MudTh>Profile</MudTh>
                            <MudTh>Base URL</MudTh>
                            <MudTh>SSL</MudTh>
                            <MudTh Style="width: 200px;">Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Profile">
                                <div class="d-flex align-center">
                                    <MudText>@context.Name</MudText>
                                    @if (context.Name == _activeProfile?.Name)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Class="ml-2">Active</MudChip>
                                    }
                                    @if (context.IsSystemProfile)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ml-1">System</MudChip>
                                    }
                                </div>
                                @if (!string.IsNullOrEmpty(context.Description))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Description</MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="Base URL">
                                <MudText Typo="Typo.body2">
                                    @(string.IsNullOrEmpty(context.SorchaServiceUrl) ? "(individual URLs)" : context.SorchaServiceUrl)
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="SSL">
                                <MudIcon Icon="@(context.VerifySsl ? Icons.Material.Filled.Lock : Icons.Material.Filled.LockOpen)"
                                         Color="@(context.VerifySsl ? Color.Success : Color.Warning)"
                                         Size="Size.Small" />
                            </MudTd>
                            <MudTd DataLabel="Actions">
                                @if (context.Name != _activeProfile?.Name)
                                {
                                    <MudButton Size="Size.Small"
                                               Variant="Variant.Text"
                                               Color="Color.Primary"
                                               OnClick="@(() => ActivateProfile(context.Name))">
                                        Activate
                                    </MudButton>
                                }
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                               Size="Size.Small"
                                               OnClick="@(() => EditProfile(context))" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               Disabled="@(context.IsSystemProfile || context.Name == _activeProfile?.Name)"
                                               OnClick="@(() => DeleteProfile(context))" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
                else
                {
                    <MudAlert Severity="Severity.Info" Class="mb-4">No profiles configured.</MudAlert>
                }

                <MudButton StartIcon="@Icons.Material.Filled.Add"
                           Color="Color.Primary"
                           Variant="Variant.Filled"
                           OnClick="CreateNewProfile">
                    New Profile
                </MudButton>
            </MudTabPanel>

            <!-- About Tab -->
            <MudTabPanel Text="About" Icon="@Icons.Material.Filled.Info">
                <MudText Typo="Typo.h5" Class="mb-2">Sorcha Platform</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    A distributed ledger platform for secure, multi-participant data flow orchestration
                </MudText>

                <MudDivider Class="my-4" />

                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudPaper Class="pa-4" Outlined="true">
                            <MudText Typo="Typo.subtitle1" Class="mb-3">
                                <MudIcon Icon="@Icons.Material.Filled.Code" Size="Size.Small" Class="mr-1" />
                                Version Information
                            </MudText>
                            <MudText Typo="Typo.body2" Class="mb-1">
                                <strong>Version:</strong> 1.0.0-preview
                            </MudText>
                            <MudText Typo="Typo.body2" Class="mb-1">
                                <strong>Build:</strong> @_buildNumber
                            </MudText>
                            <MudText Typo="Typo.body2" Class="mb-1">
                                <strong>Framework:</strong> .NET 10.0
                            </MudText>
                            <MudText Typo="Typo.body2">
                                <strong>Platform:</strong> Blazor WebAssembly
                            </MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudPaper Class="pa-4" Outlined="true">
                            <MudText Typo="Typo.subtitle1" Class="mb-3">
                                <MudIcon Icon="@Icons.Material.Filled.Security" Size="Size.Small" Class="mr-1" />
                                Security Features
                            </MudText>
                            <MudText Typo="Typo.body2" Class="mb-1">
                                <strong>Cryptography:</strong> ED25519, P-256, RSA-4096
                            </MudText>
                            <MudText Typo="Typo.body2" Class="mb-1">
                                <strong>HD Wallets:</strong> BIP32/BIP39/BIP44
                            </MudText>
                            <MudText Typo="Typo.body2" Class="mb-1">
                                <strong>Authentication:</strong> JWT Bearer
                            </MudText>
                            <MudText Typo="Typo.body2">
                                <strong>Model:</strong> DAD (Disclosure, Alteration, Destruction)
                            </MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.subtitle1" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Link" Size="Size.Small" Class="mr-1" />
                    Resources
                </MudText>
                <MudGrid>
                    <MudItem xs="12" sm="4">
                        <MudButton Href="https://github.com/sorcha/platform"
                                   Target="_blank"
                                   Variant="Variant.Outlined"
                                   StartIcon="@Icons.Custom.Brands.GitHub"
                                   FullWidth="true">
                            GitHub Repository
                        </MudButton>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudButton Href="help"
                                   Variant="Variant.Outlined"
                                   StartIcon="@Icons.Material.Filled.Help"
                                   FullWidth="true">
                            Help & Documentation
                        </MudButton>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudButton Href="https://sorcha.io"
                                   Target="_blank"
                                   Variant="Variant.Outlined"
                                   StartIcon="@Icons.Material.Filled.Public"
                                   FullWidth="true">
                            Website
                        </MudButton>
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    MIT License - Copyright (c) 2026 Sorcha Contributors
                </MudText>
            </MudTabPanel>
        </MudTabs>
    </MudPaper>
</MudContainer>

@code {
    private UserPreferencesDto _preferences = new();
    private List<Profile> _profiles = new();
    private Profile? _activeProfile;
    private bool _loading = true;
    private string _buildNumber = $"{DateTime.Now:yyyyMMdd}.{DateTime.Now:HHmm}";

    // TOTP setup state
    private bool _showTotpSetup;
    private string _totpSecret = string.Empty;
    private string _totpQrUri = string.Empty;
    private string _totpVerificationCode = string.Empty;
    private List<string> _totpBackupCodes = new();

    // Supported languages
    private readonly List<(string Code, string Name, string NativeName)> _supportedLanguages =
    [
        ("en", "English", "English"),
        ("fr", "French", "Français"),
        ("de", "German", "Deutsch"),
        ("es", "Spanish", "Español")
    ];

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadPreferencesAsync(), LoadProfilesAsync());
    }

    private async Task LoadPreferencesAsync()
    {
        try
        {
            _preferences = await PreferencesService.GetUserPreferencesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading preferences: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnThemeChanged(string theme)
    {
        _preferences.Theme = theme;
        await SavePreferencesAsync(new UpdateUserPreferencesRequest { Theme = theme });
        Snackbar.Add($"Theme set to {theme}", Severity.Success);
    }

    private async Task OnTimeFormatChanged(string format)
    {
        _preferences.TimeFormat = format;
        await SavePreferencesAsync(new UpdateUserPreferencesRequest { TimeFormat = format });
        Snackbar.Add($"Time format set to {format}", Severity.Success);
    }

    private async Task OnLanguageChanged(string languageCode)
    {
        _preferences.Language = languageCode;
        await SavePreferencesAsync(new UpdateUserPreferencesRequest { Language = languageCode });
        var langName = _supportedLanguages.FirstOrDefault(l => l.Code == languageCode).Name ?? languageCode;
        Snackbar.Add($"Language set to {langName}", Severity.Success);
    }

    private async Task OnNotificationsChanged(bool enabled)
    {
        _preferences.NotificationsEnabled = enabled;
        await SavePreferencesAsync(new UpdateUserPreferencesRequest { NotificationsEnabled = enabled });
        Snackbar.Add(enabled ? "Notifications enabled" : "Notifications disabled", Severity.Success);
    }

    private async Task SavePreferencesAsync(UpdateUserPreferencesRequest request)
    {
        try
        {
            _preferences = await PreferencesService.UpdateUserPreferencesAsync(request);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving preferences: {ex.Message}", Severity.Error);
        }
    }

    private void SetupTwoFactor()
    {
        _showTotpSetup = true;
        // TODO: Call TotpClientService.SetupTotpAsync() when available
        _totpSecret = "PLACEHOLDER";
        _totpQrUri = "otpauth://totp/Sorcha:user@example.com?secret=PLACEHOLDER&issuer=Sorcha";
    }

    private async Task VerifyTotpSetup()
    {
        // TODO: Call TotpClientService.VerifySetupAsync() when available
        Snackbar.Add("2FA verification will be available once the TOTP service is connected", Severity.Info);
    }

    private async Task DisableTwoFactor()
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Disable Two-Factor Authentication",
            "Are you sure? This will make your account less secure.",
            yesText: "Disable",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            // TODO: Call TotpClientService.DisableTotpAsync() when available
            Snackbar.Add("2FA disable will be available once the TOTP service is connected", Severity.Info);
        }
    }

    private async Task LoadProfilesAsync()
    {
        _loading = true;
        try
        {
            var profiles = await ConfigService.GetProfilesAsync();
            _profiles = profiles.ToList();
            _activeProfile = await ConfigService.GetActiveProfileAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading profiles: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ActivateProfile(string profileName)
    {
        try
        {
            await ConfigService.SetActiveProfileAsync(profileName);
            var profile = await ConfigService.GetProfileAsync(profileName);
            if (profile != null)
            {
                ApiConfiguration.ConfigureFromProfile(profile);
            }
            await LoadProfilesAsync();
            Snackbar.Add($"Activated profile: {profileName}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error activating profile: {ex.Message}", Severity.Error);
        }
    }

    private async Task EditProfile(Profile profile)
    {
        var parameters = new DialogParameters<ProfileEditorDialog>
        {
            { x => x.Profile, profile },
            { x => x.IsNew, false }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<ProfileEditorDialog>("Edit Profile", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadProfilesAsync();
        }
    }

    private async Task CreateNewProfile()
    {
        var parameters = new DialogParameters<ProfileEditorDialog>
        {
            { x => x.Profile, null },
            { x => x.IsNew, true }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<ProfileEditorDialog>("New Profile", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadProfilesAsync();
        }
    }

    private async Task DeleteProfile(Profile profile)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Delete Profile",
            $"Are you sure you want to delete the profile '{profile.Name}'?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                var deleted = await ConfigService.DeleteProfileAsync(profile.Name);
                if (deleted)
                {
                    await LoadProfilesAsync();
                    Snackbar.Add($"Deleted profile: {profile.Name}", Severity.Info);
                }
                else
                {
                    Snackbar.Add("Cannot delete this profile", Severity.Warning);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting profile: {ex.Message}", Severity.Error);
            }
        }
    }
}
