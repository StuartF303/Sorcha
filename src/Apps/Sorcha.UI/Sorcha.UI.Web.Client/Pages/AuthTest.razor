@page "/auth-test"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]
@using Sorcha.UI.Core.Services.Authentication
@using Microsoft.AspNetCore.Authorization
@inject IAuthenticationService AuthService
@inject NavigationManager Navigation

<h3>Authentication Test Page</h3>

<div class="alert alert-success">
    âœ… You are authenticated!
</div>

<AuthorizeView>
    <Authorized>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">User Information</h5>

                <p><strong>Username:</strong> @_authInfo?.Username</p>
                <p><strong>Profile:</strong> @_authInfo?.ProfileName</p>
                <p><strong>Roles:</strong> @string.Join(", ", _authInfo?.Roles ?? new List<string>())</p>
                <p><strong>Expires At:</strong> @_authInfo?.ExpiresAt?.ToLocalTime()</p>
                <p><strong>Authenticated:</strong> @_authInfo?.IsAuthenticated</p>

                <hr />

                <button class="btn btn-danger" @onclick="HandleLogout">Logout</button>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="alert alert-warning">
            You are not authorized to view this page.
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private AuthenticationStateInfo? _authInfo;

    protected override async Task OnInitializedAsync()
    {
        _authInfo = await AuthService.GetAuthenticationInfoAsync();
    }

    private async Task HandleLogout()
    {
        if (_authInfo != null)
        {
            await AuthService.LogoutAsync(_authInfo.ProfileName ?? "Development");
        }
        Navigation.NavigateTo("/login", forceLoad: true);
    }
}
