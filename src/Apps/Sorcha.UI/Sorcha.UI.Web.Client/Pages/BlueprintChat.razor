@page "/designer/chat"
@page "/designer/chat/{ExistingBlueprintId?}"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]
@using System.Net.Http.Json
@using Sorcha.UI.Core.Services
@using Sorcha.UI.Core.Models.Chat
@using BlueprintModel = Sorcha.Blueprint.Models.Blueprint
@using ChatMessageModel = Sorcha.UI.Core.Models.Chat.ChatMessage
@inject IChatHubConnection ChatHub
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject HttpClient Http
@implements IAsyncDisposable

<PageTitle>Blueprint Chat Designer - Sorcha Platform</PageTitle>

<div class="chat-designer-container">
    <!-- Header Toolbar -->
    <MudPaper Elevation="1" Class="pa-2" Style="border-radius: 0;">
        <div class="d-flex align-center gap-2">
            <MudIcon Icon="@Icons.Material.Filled.SmartToy" Color="Color.Primary" />
            <MudText Typo="Typo.h6" Class="mr-4">AI Blueprint Designer</MudText>

            <MudChip T="string" Color="@GetConnectionColor()" Size="MudBlazor.Size.Small" Variant="Variant.Outlined">
                @GetConnectionStatus()
            </MudChip>

            <MudSpacer />

            <MudButton StartIcon="@Icons.Material.Filled.FolderOpen"
                       Color="Color.Primary"
                       Size="MudBlazor.Size.Small"
                       Variant="Variant.Outlined"
                       OnClick="@OpenLoadBlueprintDialog">
                Load Blueprint
            </MudButton>

            @if (!string.IsNullOrEmpty(SessionId))
            {
                <MudButton StartIcon="@Icons.Material.Filled.Save"
                           Color="Color.Success"
                           Size="MudBlazor.Size.Small"
                           Variant="Variant.Filled"
                           OnClick="@SaveBlueprint"
                           Disabled="@(Session?.Blueprint == null)">
                    Save Blueprint
                </MudButton>

                <MudButton StartIcon="@Icons.Material.Filled.FileDownload"
                           Color="Color.Secondary"
                           Size="MudBlazor.Size.Small"
                           Variant="Variant.Outlined"
                           OnClick="@(() => ExportBlueprint("json"))"
                           Disabled="@(Session?.Blueprint == null)">
                    Export JSON
                </MudButton>

                <MudButton StartIcon="@Icons.Material.Filled.FileDownload"
                           Color="Color.Secondary"
                           Size="MudBlazor.Size.Small"
                           Variant="Variant.Outlined"
                           OnClick="@(() => ExportBlueprint("yaml"))"
                           Disabled="@(Session?.Blueprint == null)">
                    Export YAML
                </MudButton>

                <MudDivider Vertical="true" FlexItem="true" Class="mx-2" />

                <MudText Typo="Typo.caption" Class="mr-2">
                    Messages: @Session?.RemainingMessages / 100
                </MudText>
            }

            <MudButton StartIcon="@Icons.Material.Filled.Edit"
                       Color="Color.Info"
                       Size="MudBlazor.Size.Small"
                       Variant="Variant.Text"
                       Href="/designer"
                       Disabled="@(Session?.Blueprint == null)">
                Open in Visual Designer
            </MudButton>
        </div>
    </MudPaper>

    <!-- Main Content Area -->
    <div class="chat-main-content">
        <!-- Chat Panel (Left) -->
        <div class="chat-panel">
            <Sorcha.UI.Web.Client.Components.Chat.ChatPanel
                Messages="@(Session?.Messages ?? [])"
                IsProcessing="@(Session?.IsProcessing ?? false)"
                IsConnected="@(ChatHub.State == ChatConnectionState.Connected)"
                OnSendMessage="@SendMessage"
                OnCancelGeneration="@CancelGeneration"
                @ref="chatPanelRef" />
        </div>

        <!-- Preview Panel (Right) -->
        <div class="preview-panel">
            <Sorcha.UI.Web.Client.Components.Chat.BlueprintPreview
                Blueprint="@Session?.Blueprint"
                Validation="@Session?.Validation" />
        </div>
    </div>
</div>

<style>
    .chat-designer-container {
        display: flex;
        flex-direction: column;
        /* Account for MudAppBar (64px) and MudContainer margins (32px) */
        height: calc(100vh - 64px - 32px);
        /* Also support dynamic viewport height for mobile browsers */
        height: calc(100dvh - 64px - 32px);
        overflow: hidden;
    }

    .chat-main-content {
        flex: 1;
        display: flex;
        flex-direction: row;
        overflow: hidden;
        min-height: 0; /* Allow flex children to shrink below content size */
    }

    .chat-panel {
        flex: 1;
        min-width: 400px;
        max-width: 600px;
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--mud-palette-divider);
        min-height: 0; /* Allow flex children to shrink */
    }

    .preview-panel {
        flex: 2;
        overflow: auto;
        background: var(--mud-palette-background-grey);
    }
</style>

@code {
    [Parameter]
    public string? ExistingBlueprintId { get; set; }

    private Sorcha.UI.Web.Client.Components.Chat.ChatPanel? chatPanelRef;
    private ChatSession? Session { get; set; }
    private string? SessionId { get; set; }
    private string _currentAssistantMessage = "";

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to hub events
        ChatHub.OnChunkReceived += HandleChunkReceived;
        ChatHub.OnToolExecuted += HandleToolExecuted;
        ChatHub.OnBlueprintUpdated += HandleBlueprintUpdated;
        ChatHub.OnMessageComplete += HandleMessageComplete;
        ChatHub.OnSessionError += HandleSessionError;
        ChatHub.OnMessageLimitWarning += HandleMessageLimitWarning;
        ChatHub.OnStateChanged += HandleStateChanged;
        ChatHub.OnSessionStarted += HandleSessionStarted;

        try
        {
            // Connect to the hub
            await ChatHub.ConnectAsync();

            // Start a new session - SessionStarted event will be fired with any loaded blueprint
            SessionId = await ChatHub.StartSessionAsync(ExistingBlueprintId);
            Session = new ChatSession
            {
                SessionId = SessionId,
                IsConnected = true
            };

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to connect: {ex.Message}", Severity.Error);
        }
    }

    private void HandleChunkReceived(string chunk)
    {
        InvokeAsync(() =>
        {
            _currentAssistantMessage += chunk;

            // Update or create the current assistant message
            var lastMessage = Session?.Messages.LastOrDefault();
            if (lastMessage?.Role == MessageRole.Assistant && lastMessage.IsStreaming)
            {
                lastMessage.Content = _currentAssistantMessage;
            }
            else
            {
                Session?.Messages.Add(new ChatMessageModel
                {
                    Role = MessageRole.Assistant,
                    Content = _currentAssistantMessage,
                    Timestamp = DateTime.UtcNow,
                    IsStreaming = true
                });
            }

            StateHasChanged();
        });
    }

    private void HandleToolExecuted(string toolName, bool success, string? error)
    {
        InvokeAsync(() =>
        {
            if (Session != null)
            {
                // Add tool execution indicator to the message
                var lastMessage = Session.Messages.LastOrDefault();
                if (lastMessage != null)
                {
                    lastMessage.ToolResults.Add(new ToolExecutionResult
                    {
                        ToolName = toolName,
                        Success = success,
                        Error = error
                    });
                }
            }
            StateHasChanged();
        });
    }

    private void HandleBlueprintUpdated(BlueprintModel blueprint, ValidationResult validation)
    {
        InvokeAsync(() =>
        {
            if (Session != null)
            {
                Session.Blueprint = blueprint;
                Session.Validation = validation;
            }
            StateHasChanged();
        });
    }

    private void HandleMessageComplete(string messageId)
    {
        InvokeAsync(() =>
        {
            _currentAssistantMessage = "";

            if (Session != null)
            {
                Session.IsProcessing = false;

                // Mark the streaming message as complete
                var lastMessage = Session.Messages.LastOrDefault();
                if (lastMessage?.Role == MessageRole.Assistant)
                {
                    lastMessage.IsStreaming = false;
                }
            }

            StateHasChanged();
        });
    }

    private void HandleSessionError(string code, string message)
    {
        InvokeAsync(() =>
        {
            Snackbar.Add($"Error [{code}]: {message}", Severity.Error);

            if (Session != null)
            {
                Session.IsProcessing = false;
            }

            StateHasChanged();
        });
    }

    private void HandleMessageLimitWarning(int remaining)
    {
        InvokeAsync(() =>
        {
            if (Session != null)
            {
                Session.RemainingMessages = remaining;
            }

            if (remaining <= 10)
            {
                Snackbar.Add($"Warning: Only {remaining} messages remaining in this session", Severity.Warning);
            }

            StateHasChanged();
        });
    }

    private void HandleStateChanged(ChatConnectionState state)
    {
        InvokeAsync(() =>
        {
            if (Session != null)
            {
                Session.IsConnected = state == ChatConnectionState.Connected;
            }

            StateHasChanged();
        });
    }

    private void HandleSessionStarted(string sessionId, BlueprintModel? blueprint, int messageCount)
    {
        InvokeAsync(() =>
        {
            if (Session != null)
            {
                // SessionId is set during creation in OnInitializedAsync, no need to set it here

                // If we received a loaded blueprint, display it
                if (blueprint != null)
                {
                    Session.Blueprint = blueprint;
                    Session.Messages.Add(new ChatMessageModel
                    {
                        Role = MessageRole.Assistant,
                        Content = $"I've loaded the blueprint **\"{blueprint.Title}\"** for editing.\n\n" +
                                  $"This blueprint has:\n" +
                                  $"- **{blueprint.Participants.Count} participants**: {string.Join(", ", blueprint.Participants.Select(p => p.Name))}\n" +
                                  $"- **{blueprint.Actions.Count} actions**: {string.Join(", ", blueprint.Actions.Select(a => a.Title))}\n\n" +
                                  $"What changes would you like to make? You can:\n" +
                                  $"- Add or remove participants\n" +
                                  $"- Add, modify, or remove actions\n" +
                                  $"- Update data schemas and disclosure rules\n" +
                                  $"- Configure routing logic",
                        Timestamp = DateTime.UtcNow
                    });

                    Snackbar.Add($"Loaded blueprint: {blueprint.Title}", Severity.Info);
                }
                else
                {
                    // New blueprint - show standard welcome
                    Session.Messages.Add(new ChatMessageModel
                    {
                        Role = MessageRole.Assistant,
                        Content = "Hello! I'm your AI blueprint designer. Describe the workflow you want to create, and I'll help you build it step by step.\n\n" +
                                  "For example, you could say:\n" +
                                  "- \"Create a two-party approval workflow where Alice submits and Bob approves\"\n" +
                                  "- \"I need a supply chain tracking process with manufacturer, shipper, and retailer\"\n" +
                                  "- \"Design a document review workflow with author, reviewer, and approver roles\"\n\n" +
                                  "What would you like to create?",
                        Timestamp = DateTime.UtcNow
                    });
                }

                // Handle resumed sessions with existing messages
                if (messageCount > 0)
                {
                    Session.RemainingMessages = 100 - messageCount;
                }
            }

            StateHasChanged();
        });
    }

    private async Task SendMessage(string message)
    {
        if (string.IsNullOrWhiteSpace(message) || string.IsNullOrEmpty(SessionId))
            return;

        // Add user message
        Session?.Messages.Add(new ChatMessageModel
        {
            Role = MessageRole.User,
            Content = message,
            Timestamp = DateTime.UtcNow
        });

        if (Session != null)
        {
            Session.IsProcessing = true;
        }

        StateHasChanged();

        try
        {
            await ChatHub.SendMessageAsync(SessionId, message);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to send message: {ex.Message}", Severity.Error);
            if (Session != null)
            {
                Session.IsProcessing = false;
            }
        }
    }

    private async Task CancelGeneration()
    {
        if (string.IsNullOrEmpty(SessionId))
            return;

        try
        {
            await ChatHub.CancelGenerationAsync(SessionId);
            if (Session != null)
            {
                Session.IsProcessing = false;
            }
            Snackbar.Add("Generation cancelled", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to cancel: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveBlueprint()
    {
        if (string.IsNullOrEmpty(SessionId))
            return;

        try
        {
            var blueprintId = await ChatHub.SaveBlueprintAsync(SessionId);
            Snackbar.Add($"Blueprint saved successfully! ID: {blueprintId}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save blueprint: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportBlueprint(string format)
    {
        if (string.IsNullOrEmpty(SessionId))
            return;

        try
        {
            var content = await ChatHub.ExportBlueprintAsync(SessionId, format);

            // TODO: Trigger file download in browser
            // For now, show in a dialog
            var parameters = new DialogParameters
            {
                { "Content", content },
                { "Format", format }
            };

            await DialogService.ShowAsync<ExportContentDialog>($"Export as {format.ToUpperInvariant()}", parameters);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to export: {ex.Message}", Severity.Error);
        }
    }

    private Color GetConnectionColor() => ChatHub.State switch
    {
        ChatConnectionState.Connected => Color.Success,
        ChatConnectionState.Connecting or ChatConnectionState.Reconnecting => Color.Warning,
        _ => Color.Error
    };

    private string GetConnectionStatus() => ChatHub.State switch
    {
        ChatConnectionState.Connected => "Connected",
        ChatConnectionState.Connecting => "Connecting...",
        ChatConnectionState.Reconnecting => "Reconnecting...",
        _ => "Disconnected"
    };

    private async Task OpenLoadBlueprintDialog()
    {
        try
        {
            // Fetch blueprints from API
            var response = await Http.GetFromJsonAsync<BlueprintListResponse>("/api/blueprints?pageSize=50");
            var blueprints = response?.Items?.ToList() ?? [];

            var parameters = new DialogParameters<Sorcha.UI.Core.Components.Designer.LoadBlueprintDialog>
            {
                { x => x.Blueprints, blueprints }
            };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.Medium,
                FullWidth = true
            };

            var dialog = await DialogService.ShowAsync<Sorcha.UI.Core.Components.Designer.LoadBlueprintDialog>(
                "Load Blueprint", parameters, options);
            var result = await dialog.Result;

            if (result is { Canceled: false, Data: string blueprintId })
            {
                // Navigate to edit the selected blueprint
                Navigation.NavigateTo($"/designer/chat/{blueprintId}");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load blueprints: {ex.Message}", Severity.Error);
        }
    }

    private record BlueprintListResponse(IEnumerable<BlueprintModel>? Items, int TotalCount, int Page, int PageSize);

    public async ValueTask DisposeAsync()
    {
        // Unsubscribe from events
        ChatHub.OnChunkReceived -= HandleChunkReceived;
        ChatHub.OnToolExecuted -= HandleToolExecuted;
        ChatHub.OnBlueprintUpdated -= HandleBlueprintUpdated;
        ChatHub.OnMessageComplete -= HandleMessageComplete;
        ChatHub.OnSessionError -= HandleSessionError;
        ChatHub.OnMessageLimitWarning -= HandleMessageLimitWarning;
        ChatHub.OnStateChanged -= HandleStateChanged;
        ChatHub.OnSessionStarted -= HandleSessionStarted;

        // End session and disconnect
        if (!string.IsNullOrEmpty(SessionId))
        {
            try
            {
                await ChatHub.EndSessionAsync(SessionId);
            }
            catch
            {
                // Ignore errors during cleanup
            }
        }

        await ChatHub.DisposeAsync();
    }
}
