@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@page "/participants/{OrganizationId:guid}/{ParticipantId:guid}"
@using Sorcha.UI.Core.Components.Participants
@using Sorcha.UI.Core.Models.Participants
@using Sorcha.UI.Core.Services
@using Sorcha.UI.Core.Services.Participants
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

<PageTitle>Participant Details</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <MudButton Color="Color.Default" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack"
               OnClick="NavigateBack" Class="mb-4">
        Back to Participants
    </MudButton>

    <ParticipantDetail @ref="_detail"
                       OrganizationId="OrganizationId"
                       ParticipantId="ParticipantId"
                       OnEditClick="ShowEditDialog"
                       OnLinkWalletClick="ShowWalletLinkDialog"
                       OnPublishClick="ShowPublishDialog"
                       OnParticipantChanged="OnParticipantChanged" />
</MudContainer>

@code {
    [Parameter] public Guid OrganizationId { get; set; }
    [Parameter] public Guid ParticipantId { get; set; }

    [Inject] private IParticipantApiService ParticipantService { get; set; } = default!;
    [Inject] private IOrganizationAdminService OrganizationService { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private ParticipantDetail? _detail;

    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Home", href: ""),
        new BreadcrumbItem("Participants", href: "participants"),
        new BreadcrumbItem("Details", href: null, disabled: true)
    };

    private void NavigateBack()
    {
        Navigation.NavigateTo("participants");
    }

    private async Task ShowEditDialog(ParticipantDetailViewModel participant)
    {
        var parameters = new DialogParameters
        {
            { nameof(ParticipantForm.OrganizationId), OrganizationId },
            { nameof(ParticipantForm.ParticipantId), ParticipantId },
            { nameof(ParticipantForm.ExistingParticipant), participant }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ParticipantForm>("Edit Participant", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled && _detail != null)
        {
            await _detail.RefreshAsync();
        }
    }

    private async Task ShowWalletLinkDialog(ParticipantDetailViewModel participant)
    {
        var parameters = new DialogParameters
        {
            { nameof(WalletLinkForm.OrganizationId), OrganizationId },
            { nameof(WalletLinkForm.ParticipantId), ParticipantId }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<WalletLinkForm>("Link Wallet", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled && _detail != null)
        {
            await _detail.RefreshAsync();
        }
    }

    private async Task ShowPublishDialog(ParticipantDetailViewModel participant)
    {
        var org = await OrganizationService.GetOrganizationAsync(OrganizationId);
        if (org == null)
        {
            Snackbar.Add("Could not load organization details", Severity.Error);
            return;
        }

        var parameters = new DialogParameters<PublishParticipantDialog>
        {
            { x => x.OrganizationId, OrganizationId },
            { x => x.ParticipantId, ParticipantId },
            { x => x.Participant, participant },
            { x => x.Organization, org }
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<PublishParticipantDialog>(
            "Publish Participant to Register", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled)
        {
            Snackbar.Add("Participant published to register", Severity.Success);
        }
    }

    private void OnParticipantChanged()
    {
        Navigation.NavigateTo("participants");
    }
}
