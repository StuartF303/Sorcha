@page "/schemas"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]
@using Sorcha.UI.Core.Components
@using Sorcha.UI.Core.Models.SchemaLibrary
@using Sorcha.UI.Core.Services
@inject ISchemaLibraryApiService SchemaApiService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Schema Library - Sorcha Platform</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">
    <MudStack Spacing="3">
        <!-- Header -->
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Schema" Size="Size.Large" />
                <MudText Typo="Typo.h4">Schema Library</MudText>
            </MudStack>
            @if (_totalCount > 0)
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                    @_totalCount schemas indexed
                </MudChip>
            }
        </MudStack>

        <!-- Search Bar -->
        <MudPaper Class="pa-3" Elevation="1">
            <SchemaSearchBar SearchText="@_searchQuery"
                             OnSearch="HandleSearch"
                             OnProviderChanged="HandleProviderChanged"
                             Providers="@_providerNames" />
        </MudPaper>

        <!-- Sector Filter Chips -->
        @if (_sectors.Count > 0)
        {
            <SectorFilterChips Sectors="@_sectors"
                               ActiveSectors="@_activeSectors"
                               ActiveSectorsChanged="HandleSectorFilterChanged" />
        }

        <!-- Loading Providers Banner -->
        @if (_loadingProviders is { Length: > 0 })
        {
            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-0">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <MudText Typo="Typo.body2">
                        Still loading: @string.Join(", ", _loadingProviders). Results will update automatically.
                    </MudText>
                </MudStack>
            </MudAlert>
        }

        <!-- Results -->
        @if (_isLoading)
        {
            <MudGrid>
                @for (int i = 0; i < 6; i++)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="180px" />
                    </MudItem>
                }
            </MudGrid>
        }
        else if (_results.Count == 0)
        {
            <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Elevation="0">
                <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Default" Class="mb-3" />
                <MudText Typo="Typo.h6" Color="Color.Default">No schemas found</MudText>
                <MudText Typo="Typo.body2" Color="Color.Default" Class="mt-1">
                    @if (!string.IsNullOrWhiteSpace(_searchQuery))
                    {
                        @:Try a different search term or adjust your sector filters.
                    }
                    else
                    {
                        @:The schema index is still being populated. Check back shortly.
                    }
                </MudText>
            </MudPaper>
        }
        else
        {
            <MudGrid>
                @foreach (var entry in _results)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <SchemaCard Entry="@entry" OnViewDetail="HandleViewDetail" />
                    </MudItem>
                }
            </MudGrid>

            <!-- Pagination -->
            @if (_nextCursor is not null || _previousCursors.Count > 0)
            {
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="2" Class="mt-2">
                    <MudButton Variant="Variant.Outlined"
                               Disabled="@(_previousCursors.Count == 0)"
                               OnClick="GoToPreviousPage"
                               StartIcon="@Icons.Material.Filled.ChevronLeft">
                        Previous
                    </MudButton>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                        Showing @_results.Count of @_totalCount
                    </MudText>
                    <MudButton Variant="Variant.Outlined"
                               Disabled="@(_nextCursor is null)"
                               OnClick="GoToNextPage"
                               EndIcon="@Icons.Material.Filled.ChevronRight">
                        Next
                    </MudButton>
                </MudStack>
            }
        }
    </MudStack>
</MudContainer>

@code {
    private bool _isLoading = true;
    private string? _searchQuery;
    private string? _selectedProvider;
    private IReadOnlyList<string>? _activeSectors;
    private string? _nextCursor;
    private readonly Stack<string?> _previousCursors = new();
    private string? _currentCursor;
    private int _totalCount;
    private string[]? _loadingProviders;

    private List<SchemaIndexEntryViewModel> _results = [];
    private List<SchemaSectorViewModel> _sectors = [];
    private List<string> _providerNames = [];

    protected override async Task OnInitializedAsync()
    {
        var sectorsTask = SchemaApiService.GetSectorsAsync();
        var searchTask = LoadResultsAsync();

        _sectors = (await sectorsTask).ToList();
        await searchTask;
    }

    private async Task LoadResultsAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            var response = await SchemaApiService.SearchAsync(
                search: _searchQuery,
                sectors: _activeSectors?.ToArray(),
                provider: _selectedProvider,
                limit: 24,
                cursor: _currentCursor);

            _results = response.Results.ToList();
            _totalCount = response.TotalCount;
            _nextCursor = response.NextCursor;
            _loadingProviders = response.LoadingProviders;

            // Collect distinct provider names from results for the filter dropdown
            var providerSet = new HashSet<string>(_results.Select(r => r.SourceProvider));
            foreach (var name in _providerNames) providerSet.Add(name);
            _providerNames = providerSet.OrderBy(n => n).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading schemas: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleSearch(string? query)
    {
        _searchQuery = query;
        _currentCursor = null;
        _previousCursors.Clear();
        await LoadResultsAsync();
    }

    private async Task HandleProviderChanged(string? provider)
    {
        _selectedProvider = provider;
        _currentCursor = null;
        _previousCursors.Clear();
        await LoadResultsAsync();
    }

    private async Task HandleSectorFilterChanged(IReadOnlyList<string>? sectors)
    {
        _activeSectors = sectors;
        _currentCursor = null;
        _previousCursors.Clear();
        await LoadResultsAsync();
    }

    private void HandleViewDetail(SchemaIndexEntryViewModel entry)
    {
        Navigation.NavigateTo($"schemas/{entry.ShortCode}");
    }

    private async Task GoToNextPage()
    {
        if (_nextCursor is null) return;
        _previousCursors.Push(_currentCursor);
        _currentCursor = _nextCursor;
        await LoadResultsAsync();
    }

    private async Task GoToPreviousPage()
    {
        if (_previousCursors.Count == 0) return;
        _currentCursor = _previousCursors.Pop();
        await LoadResultsAsync();
    }
}
