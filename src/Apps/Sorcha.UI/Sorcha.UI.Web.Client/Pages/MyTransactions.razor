@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2025 Sorcha Contributors *@

@page "/my-transactions"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using Sorcha.UI.Core.Models.Registers
@using Sorcha.UI.Core.Models.Wallet
@using Sorcha.UI.Core.Components.Shared
@using Sorcha.UI.Core.Services
@using Sorcha.UI.Core.Services.Wallet
@inject ITransactionService TransactionService
@inject IWalletApiService WalletApi
@inject ISnackbar Snackbar

<PageTitle>My Transactions - Sorcha Platform</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-2">
        <MudIcon Icon="@Icons.Material.Filled.Receipt" Class="mr-2" />
        My Transactions
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        View your transaction history on the distributed ledger
    </MudText>

    @if (_serviceError)
    {
        <ServiceUnavailable ServiceName="Register Service" OnRetry="LoadTransactionsAsync" />
    }
    else
    {
        @* Wallet selector *@
        @if (_wallets.Count > 1)
        {
            <MudPaper Class="pa-4 mb-4" Elevation="2">
                <MudSelect T="string" Value="_selectedWalletAddress" Label="Wallet"
                           Variant="Variant.Outlined" Margin="Margin.Dense"
                           ValueChanged="OnWalletChanged">
                    @foreach (var wallet in _wallets)
                    {
                        <MudSelectItem Value="@wallet.Address">@wallet.Name â€” @wallet.Address[..Math.Min(12, wallet.Address.Length)]...</MudSelectItem>
                    }
                </MudSelect>
            </MudPaper>
        }

        @* Filter toolbar *@
        <MudPaper Class="pa-4 mb-4" Elevation="2">
            <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center">
                <MudTextField T="string" @bind-Value="_searchText" Placeholder="Search by ID or workflow..."
                              Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                              Variant="Variant.Outlined" Margin="Margin.Dense" Style="max-width: 300px;" />
                <MudSpacer />
                <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Refresh" OnClick="LoadTransactionsAsync">
                    Refresh
                </MudButton>
            </MudStack>
        </MudPaper>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
        }
        else if (_transactions.Count == 0)
        {
            <EmptyState Icon="@Icons.Material.Filled.Receipt"
                        Title="No Transactions"
                        Description="No transactions found for your wallet address." />
        }
        else
        {
            <MudPaper Class="pa-4" Elevation="2">
                <MudTable Items="@FilteredTransactions" Hover="true" Striped="true" Dense="true">
                    <HeaderContent>
                        <MudTh>Transaction ID</MudTh>
                        <MudTh>Register</MudTh>
                        <MudTh>Sender</MudTh>
                        <MudTh>Timestamp</MudTh>
                        <MudTh>Docket</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Transaction ID">
                            <TruncatedId Value="@context.Transaction.TxId" />
                        </MudTd>
                        <MudTd DataLabel="Register">
                            <TruncatedId Value="@context.RegisterId" />
                        </MudTd>
                        <MudTd DataLabel="Sender">
                            <TruncatedId Value="@context.Transaction.SenderWallet" />
                        </MudTd>
                        <MudTd DataLabel="Timestamp">
                            @context.Transaction.TimeStamp.ToString("MMM dd, yyyy HH:mm")
                        </MudTd>
                        <MudTd DataLabel="Docket">
                            @context.Transaction.DocketNumber
                        </MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[] { 10, 25, 50 }" />
                    </PagerContent>
                </MudTable>
            </MudPaper>
        }
    }
</MudContainer>

@code {
    private List<WalletDto> _wallets = [];
    private string _selectedWalletAddress = "";
    private List<TransactionQueryResultItem> _transactions = [];
    private string _searchText = "";
    private bool _loading = true;
    private bool _serviceError;

    private IEnumerable<TransactionQueryResultItem> FilteredTransactions =>
        string.IsNullOrWhiteSpace(_searchText)
            ? _transactions
            : _transactions.Where(t =>
                t.Transaction.TxId.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                t.Transaction.InstanceId?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) == true ||
                t.RegisterName.Contains(_searchText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _wallets = await WalletApi.GetWalletsAsync();
            if (_wallets.Count > 0)
            {
                _selectedWalletAddress = _wallets[0].Address;
                await LoadTransactionsAsync();
            }
            else
            {
                _loading = false;
            }
        }
        catch
        {
            _serviceError = true;
            _loading = false;
        }
    }

    private async Task OnWalletChanged(string address)
    {
        _selectedWalletAddress = address;
        await LoadTransactionsAsync();
    }

    private async Task LoadTransactionsAsync()
    {
        if (string.IsNullOrEmpty(_selectedWalletAddress))
        {
            _loading = false;
            return;
        }

        _loading = true;
        _serviceError = false;

        try
        {
            var result = await TransactionService.QueryByWalletAsync(_selectedWalletAddress, 1, 50);
            _transactions = result.Items.ToList();
        }
        catch
        {
            _serviceError = true;
        }
        finally
        {
            _loading = false;
        }
    }
}
