@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@page "/admin/schema-providers"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize(Roles = "Administrator")]
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using Sorcha.UI.Core.Models.SchemaLibrary
@using Sorcha.UI.Core.Services
@inject ISchemaLibraryApiService SchemaLibraryApi
@inject ISnackbar Snackbar

<PageTitle>Schema Providers - Sorcha Platform</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" Class="mb-2 px-0" />
    <MudText Typo="Typo.h4" Class="mb-2">
        <MudIcon Icon="@Icons.Material.Filled.CloudSync" Class="mr-2" />
        Schema Provider Health
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        Monitor schema providers, view health status, and trigger manual refreshes
    </MudText>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }
    else if (_providers.Count == 0)
    {
        <MudAlert Severity="Severity.Warning">No schema providers found.</MudAlert>
    }
    else
    {
        <MudGrid>
            @foreach (var provider in _providers)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="2" Style="height: 100%;">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.h6">@provider.ProviderName</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@GetHealthColor(provider.HealthStatus)">
                                        @provider.HealthStatus
                                    </MudChip>
                                </MudStack>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudStack Spacing="1">
                                @if (!string.IsNullOrWhiteSpace(provider.ProviderType))
                                {
                                    <MudStack Row="true" Spacing="2">
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">Type:</MudText>
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@provider.ProviderType</MudChip>
                                    </MudStack>
                                }

                                <MudStack Row="true" Spacing="2">
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">Schemas:</MudText>
                                    <MudText Typo="Typo.body2">@provider.SchemaCount</MudText>
                                </MudStack>

                                @if (provider.LastSuccessfulFetch.HasValue)
                                {
                                    <MudStack Row="true" Spacing="2">
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">Last fetch:</MudText>
                                        <MudText Typo="Typo.body2">@provider.LastSuccessfulFetch.Value.ToString("g")</MudText>
                                    </MudStack>
                                }

                                @if (!string.IsNullOrWhiteSpace(provider.LastError))
                                {
                                    <MudExpansionPanels Dense="true" Class="mt-2">
                                        <MudExpansionPanel Text="Last Error" Icon="@Icons.Material.Filled.Error">
                                            <MudText Typo="Typo.caption" Color="Color.Error" Style="word-break: break-word;">
                                                @provider.LastError
                                            </MudText>
                                            @if (provider.LastErrorAt.HasValue)
                                            {
                                                <MudText Typo="Typo.caption" Class="mud-text-secondary mt-1">
                                                    @provider.LastErrorAt.Value.ToString("g")
                                                </MudText>
                                            }
                                        </MudExpansionPanel>
                                    </MudExpansionPanels>
                                }
                            </MudStack>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Size="Size.Small" Variant="Variant.Text" Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Refresh"
                                       Disabled="@(_refreshingProvider == provider.ProviderName)"
                                       OnClick="@(() => RefreshProvider(provider.ProviderName))">
                                @if (_refreshingProvider == provider.ProviderName)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" />
                                }
                                Refresh Now
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

@code {
    private bool _loading = true;
    private string? _refreshingProvider;
    private List<SchemaProviderStatusViewModel> _providers = [];

    private readonly List<BreadcrumbItem> _breadcrumbs =
    [
        new("Admin", href: "/admin/health"),
        new("Schema Providers", href: null, disabled: true)
    ];

    protected override async Task OnInitializedAsync()
    {
        await LoadProviders();
    }

    private async Task LoadProviders()
    {
        _loading = true;
        try
        {
            var statuses = await SchemaLibraryApi.GetProviderStatusesAsync();
            _providers = statuses?.ToList() ?? [];
        }
        catch (Exception)
        {
            Snackbar.Add("Failed to load provider statuses", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task RefreshProvider(string providerName)
    {
        _refreshingProvider = providerName;
        StateHasChanged();
        try
        {
            var triggered = await SchemaLibraryApi.RefreshProviderAsync(providerName);
            if (triggered)
            {
                Snackbar.Add($"Refresh triggered for {providerName}. Status will update on next page load.", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Refresh for {providerName} was rejected (may be in backoff)", Severity.Warning);
            }
        }
        catch (Exception)
        {
            Snackbar.Add($"Failed to refresh {providerName}", Severity.Error);
        }
        finally
        {
            _refreshingProvider = null;
            await LoadProviders();
        }
    }

    private static Color GetHealthColor(string status)
    {
        return status.ToLowerInvariant() switch
        {
            "healthy" => Color.Success,
            "degraded" => Color.Warning,
            "unavailable" => Color.Error,
            _ => Color.Default
        };
    }
}
