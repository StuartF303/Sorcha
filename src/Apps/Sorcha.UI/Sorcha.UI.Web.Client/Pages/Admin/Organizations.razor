@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@page "/admin/organizations"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize(Roles = "Administrator,OrganizationAdmin")]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Sorcha.UI.Core.Components.Admin
@using Sorcha.UI.Core.Services

@inject IOrganizationAdminService OrganizationService

<PageTitle>Organizations - Sorcha Platform</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" Class="mb-2 px-0" />
    <MudText Typo="Typo.h4" Class="mb-2">
        <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" />
        Organizations
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        Manage platform organizations, users, and configuration
    </MudText>

    @if (_selectedOrganization != null)
    {
        <OrganizationDashboard Organization="_selectedOrganization"
                               IsSystemAdmin="_isSystemAdmin"
                               CurrentUserId="_currentUserId"
                               OnBack="OnBackToOrganizations" />
    }
    else if (_isSystemAdmin)
    {
        <OrganizationList OnOrganizationSelected="OnOrganizationSelected" />
    }
    else
    {
        @* Org admin without system admin â€” loading their org *@
        @if (_loadingOrgAdmin)
        {
            <MudProgressCircular Indeterminate="true" />
            <MudText Class="mt-2">Loading your organization...</MudText>
        }
        else if (_orgAdminError != null)
        {
            <MudAlert Severity="Severity.Error">@_orgAdminError</MudAlert>
        }
    }
</MudContainer>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationState { get; set; }

    private readonly List<BreadcrumbItem> _breadcrumbs =
    [
        new("Admin", href: "/admin/health"),
        new("Organizations", href: null, disabled: true)
    ];

    private OrganizationDto? _selectedOrganization;
    private bool _isSystemAdmin;
    private Guid? _currentUserId;
    private bool _loadingOrgAdmin;
    private string? _orgAdminError;

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationState != null)
        {
            var authState = await AuthenticationState;

            _isSystemAdmin = authState.User.Claims
                .Any(c => c.Type == ClaimTypes.Role &&
                     (c.Value == "Administrator" || c.Value == "SystemAdmin"));

            var userIdClaim = authState.User.Claims
                .FirstOrDefault(c => c.Type == "sub" || c.Type == ClaimTypes.NameIdentifier);
            if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var userId))
            {
                _currentUserId = userId;
            }

            // Org admin without system admin: auto-load their organization
            if (!_isSystemAdmin)
            {
                await LoadOrgAdminOrganizationAsync(authState);
            }
        }
    }

    private async Task LoadOrgAdminOrganizationAsync(AuthenticationState authState)
    {
        _loadingOrgAdmin = true;
        try
        {
            var orgIdClaim = authState.User.Claims
                .FirstOrDefault(c => c.Type == "org_id" || c.Type == "organization_id");

            if (orgIdClaim != null && Guid.TryParse(orgIdClaim.Value, out var orgId))
            {
                _selectedOrganization = await OrganizationService.GetOrganizationAsync(orgId);
                if (_selectedOrganization == null)
                {
                    _orgAdminError = "Your organization could not be found.";
                }
            }
            else
            {
                _orgAdminError = "No organization claim found in your token. Please contact your administrator.";
            }
        }
        catch (Exception ex)
        {
            _orgAdminError = $"Failed to load organization: {ex.Message}";
        }
        finally
        {
            _loadingOrgAdmin = false;
        }
    }

    private void OnOrganizationSelected(OrganizationDto organization)
    {
        _selectedOrganization = organization;
    }

    private void OnBackToOrganizations()
    {
        _selectedOrganization = null;
    }
}
