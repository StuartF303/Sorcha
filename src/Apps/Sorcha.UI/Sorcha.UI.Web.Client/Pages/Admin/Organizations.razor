@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2025 Sorcha Contributors *@

@page "/admin/organizations"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize(Roles = "Administrator")]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Sorcha.UI.Core.Components.Admin

<PageTitle>Organizations - Sorcha Platform</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" Class="mb-2 px-0" />
    <MudText Typo="Typo.h4" Class="mb-2">
        <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" />
        Organizations
    </MudText>
    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
        Manage platform organizations, users, and configuration
    </MudText>

    @if (_selectedOrganization != null)
    {
        <UserList Organization="_selectedOrganization"
                  IsReadOnly="!_isAdmin"
                  CurrentUserId="_currentUserId"
                  OnBackToOrganizations="OnBackToOrganizations" />
    }
    else
    {
        <OrganizationList OnOrganizationSelected="OnOrganizationSelected" />
    }
</MudContainer>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationState { get; set; }

    private readonly List<BreadcrumbItem> _breadcrumbs =
    [
        new("Admin", href: "/admin/health"),
        new("Organizations", href: null, disabled: true)
    ];

    private OrganizationDto? _selectedOrganization;
    private bool _isAdmin;
    private Guid? _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationState != null)
        {
            var authState = await AuthenticationState;
            _isAdmin = authState.User.Claims
                .Any(c => c.Type == ClaimTypes.Role &&
                     (c.Value == "Administrator" || c.Value == "OrganizationAdmin"));

            var userIdClaim = authState.User.Claims
                .FirstOrDefault(c => c.Type == "sub" || c.Type == ClaimTypes.NameIdentifier);
            if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var userId))
            {
                _currentUserId = userId;
            }
        }
    }

    private void OnOrganizationSelected(OrganizationDto organization)
    {
        _selectedOrganization = organization;
    }

    private void OnBackToOrganizations()
    {
        _selectedOrganization = null;
    }
}
