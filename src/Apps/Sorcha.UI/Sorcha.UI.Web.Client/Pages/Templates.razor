@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2025 Sorcha Contributors *@

@page "/templates"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using Sorcha.UI.Core.Models.Templates
@using Sorcha.UI.Core.Components.Templates
@using Sorcha.UI.Core.Components.Shared
@using Sorcha.UI.Core.Services
@inject ITemplateApiService TemplateApi
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Blueprint Templates - Sorcha Platform</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudStack Spacing="0">
            <MudText Typo="Typo.h4">
                <MudIcon Icon="@Icons.Material.Filled.ContentCopy" Class="mr-2" />
                Blueprint Templates
            </MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Quick start templates for common workflows
            </MudText>
        </MudStack>

        <MudTextField T="string" @bind-Value="_searchText" Placeholder="Search templates..."
                      Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                      Variant="Variant.Outlined" Margin="Margin.Dense" Style="max-width: 300px;" />
    </MudStack>

    @if (_serviceError)
    {
        <ServiceUnavailable ServiceName="Template Service" OnRetry="LoadTemplatesAsync" />
    }
    else if (_loading)
    {
        <MudGrid>
            @for (var i = 0; i < 6; i++)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudCard Elevation="2">
                        <MudCardContent>
                            <MudSkeleton Width="60%" Height="24px" Class="mb-2" />
                            <MudSkeleton Width="100%" Height="16px" Class="mb-2" />
                            <MudSkeleton Width="40%" Height="16px" />
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else
    {
        @if (!FilteredTemplates.Any())
        {
            <EmptyState Icon="@Icons.Material.Filled.ContentCopy"
                        Title="No Templates Found"
                        Description="No templates match your search criteria." />
        }
        else
        {
            <TemplateList Templates="@FilteredTemplates.ToList()" OnSelect="UseTemplate" />
        }
    }
</MudContainer>

@code {
    private List<TemplateListItemViewModel> _templates = [];
    private string _searchText = "";
    private bool _loading = true;
    private bool _serviceError;

    private IEnumerable<TemplateListItemViewModel> FilteredTemplates =>
        string.IsNullOrWhiteSpace(_searchText)
            ? _templates
            : _templates.Where(t =>
                t.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                t.Description.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                t.Category.Contains(_searchText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplatesAsync();
    }

    private async Task LoadTemplatesAsync()
    {
        _loading = true;
        _serviceError = false;

        try
        {
            _templates = await TemplateApi.GetTemplatesAsync();
        }
        catch
        {
            _serviceError = true;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task UseTemplate(TemplateListItemViewModel template)
    {
        var parameters = new DialogParameters
        {
            ["Template"] = template
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<TemplateEvaluator>("Use Template", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            Snackbar.Add($"Template '{template.Name}' applied. Opening Designer.", Severity.Success);
            Navigation.NavigateTo("designer");
        }
    }
}
