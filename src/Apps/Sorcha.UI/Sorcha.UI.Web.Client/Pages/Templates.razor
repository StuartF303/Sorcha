@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2025 Sorcha Contributors *@

@page "/templates"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using Sorcha.UI.Core.Models.Templates
@using Sorcha.UI.Core.Components.Templates
@using Sorcha.UI.Core.Components.Shared
@using Sorcha.UI.Core.Components.Designer
@using Sorcha.UI.Core.Services
@inject ITemplateApiService TemplateApi
@inject IBlueprintApiService BlueprintApi
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Catalogue - Sorcha Platform</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    @if (_selectedTemplate == null)
    {
        @* State A: Full-width template list *@
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudStack Spacing="0">
                <MudText Typo="Typo.h4">
                    <MudIcon Icon="@Icons.Material.Filled.ContentCopy" Class="mr-2" />
                    Catalogue
                </MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    Browse workflow templates and create blueprints from proven patterns.
                </MudText>
            </MudStack>

            <MudTextField T="string" @bind-Value="_searchText" Placeholder="Search templates..."
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined" Margin="Margin.Dense" Style="max-width: 300px;" />
        </MudStack>

        @if (_serviceError)
        {
            <ServiceUnavailable ServiceName="Template Service" OnRetry="LoadTemplatesAsync" />
        }
        else if (_loading)
        {
            <MudGrid>
                @for (var i = 0; i < 6; i++)
                {
                    <MudItem xs="12" md="6" lg="4">
                        <MudCard Elevation="2">
                            <MudCardContent>
                                <MudSkeleton Width="60%" Height="24px" Class="mb-2" />
                                <MudSkeleton Width="100%" Height="16px" Class="mb-2" />
                                <MudSkeleton Width="40%" Height="16px" />
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
        else if (!FilteredTemplates.Any())
        {
            <EmptyState Icon="@Icons.Material.Filled.ContentCopy"
                        Title="No Templates Available"
                        Description="No templates are available. Contact your administrator to seed the template library." />
        }
        else
        {
            <TemplateList Templates="@FilteredTemplates.ToList()" OnSelect="SelectTemplate" />
        }
    }
    else
    {
        @* State B: Full-page wizard view *@
        <MudButton Variant="Variant.Text" Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.ArrowBack"
                   OnClick="CloseDetail" Class="mb-3">
            Back to Catalogue
        </MudButton>

        <MudGrid>
            <MudItem xs="12" lg="8">
                <MudStack Spacing="0" Class="mb-4">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudText Typo="Typo.h4">@_selectedTemplate.Title</MudText>
                        @if (!string.IsNullOrEmpty(_selectedTemplate.Category))
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Info">@_selectedTemplate.Category</MudChip>
                        }
                    </MudStack>
                    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mt-2">
                        @_selectedTemplate.Description
                    </MudText>
                </MudStack>

                @* Parameters section *@
                @if (_selectedTemplate.Parameters.Count > 0)
                {
                    <MudText Typo="Typo.h6" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Tune" Size="Size.Small" Class="mr-1" />
                        Parameters
                    </MudText>
                    <MudSimpleTable Dense="true" Hover="true" Class="mb-4">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Required</th>
                                <th>Default</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var param in _selectedTemplate.Parameters)
                            {
                                <tr>
                                    <td><code>@param.Name</code></td>
                                    <td>@param.Type</td>
                                    <td>
                                        @if (param.Required)
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                        }
                                    </td>
                                    <td><code>@(param.DefaultValue ?? "—")</code></td>
                                    <td>@param.Description</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }

                @* Participants section *@
                @if (_previewBlueprint?.Participants?.Count > 0)
                {
                    <MudText Typo="Typo.h6" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" Class="mr-1" />
                        Participants
                    </MudText>
                    <MudGrid Class="mb-4">
                        @foreach (var participant in _previewBlueprint.Participants)
                        {
                            <MudItem xs="12" sm="6" md="4">
                                <MudPaper Elevation="1" Class="pa-3">
                                    <MudText Typo="Typo.subtitle2">@participant.Name</MudText>
                                    @if (!string.IsNullOrEmpty(participant.Organisation))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@participant.Organisation</MudText>
                                    }
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                }

                @* Actions summary *@
                @if (_previewBlueprint?.Actions?.Count > 0)
                {
                    <MudText Typo="Typo.h6" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Size="Size.Small" Class="mr-1" />
                        Actions
                    </MudText>
                    <MudSimpleTable Dense="true" Hover="true" Class="mb-4">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Title</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var action in _previewBlueprint.Actions)
                            {
                                <tr>
                                    <td>@action.Id</td>
                                    <td>@action.Title</td>
                                    <td>@action.Description</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }

                @* Workflow preview diagram *@
                <MudText Typo="Typo.h6" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.AccountTree" Size="Size.Small" Class="mr-1" />
                    Workflow Preview
                </MudText>
                @if (_previewLoading)
                {
                    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-2" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Loading preview...</MudText>
                }
                else if (_previewBlueprint is not null)
                {
                    <MudPaper Elevation="1" Class="pa-2 mb-4">
                        <BlueprintViewerDiagram Blueprint="@_previewBlueprint" Height="400px" />
                    </MudPaper>
                }
                else if (_previewError is not null)
                {
                    <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-4">@_previewError</MudAlert>
                }
            </MudItem>

            <MudItem xs="12" lg="4">
                <MudCard Elevation="2">
                    <MudCardContent>
                        <MudText Typo="Typo.subtitle1" Class="mb-2">Template Details</MudText>
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Version: v@(_selectedTemplate.Version)
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Uses: @_selectedTemplate.UsageCount
                            </MudText>
                            @if (_previewBlueprint != null)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Participants: @_previewBlueprint.Participants.Count
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Actions: @_previewBlueprint.Actions.Count
                                </MudText>
                            }
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                ID: @_selectedTemplate.Id
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Color="Color.Primary" Variant="Variant.Filled"
                                   StartIcon="@Icons.Material.Filled.PlayArrow"
                                   OnClick="UseTemplateAsync"
                                   Disabled="_saving"
                                   FullWidth="true">
                            @if (_saving)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                @:Saving...
                            }
                            else
                            {
                                @:Use This Template
                            }
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private List<TemplateListItemViewModel> _templates = [];
    private string _searchText = "";
    private bool _loading = true;
    private bool _serviceError;
    private TemplateListItemViewModel? _selectedTemplate;
    private Sorcha.Blueprint.Models.Blueprint? _previewBlueprint;
    private bool _previewLoading;
    private string? _previewError;
    private bool _saving;

    private IEnumerable<TemplateListItemViewModel> FilteredTemplates =>
        string.IsNullOrWhiteSpace(_searchText)
            ? _templates
            : _templates.Where(t =>
                t.Title.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                t.Description.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                t.Category.Contains(_searchText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplatesAsync();
    }

    private async Task LoadTemplatesAsync()
    {
        _loading = true;
        _serviceError = false;

        try
        {
            _templates = await TemplateApi.GetTemplatesAsync();
        }
        catch
        {
            _serviceError = true;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SelectTemplate(TemplateListItemViewModel template)
    {
        _selectedTemplate = template;
        await LoadTemplatePreviewAsync(template);
    }

    private void CloseDetail()
    {
        _selectedTemplate = null;
        _previewBlueprint = null;
        _previewError = null;
    }

    private async Task LoadTemplatePreviewAsync(TemplateListItemViewModel template)
    {
        _previewBlueprint = null;
        _previewError = null;
        _previewLoading = true;
        StateHasChanged();

        try
        {
            var defaultParams = new Dictionary<string, object>();
            foreach (var param in template.Parameters)
            {
                if (param.DefaultValue is not null)
                    defaultParams[param.Name] = param.DefaultValue;
            }

            _previewBlueprint = await TemplateApi.EvaluateTemplateForPreviewAsync(
                template.Id, defaultParams);

            if (_previewBlueprint is null)
                _previewError = "Preview unavailable — could not evaluate template.";
        }
        catch
        {
            _previewError = "Preview unavailable — template evaluation failed.";
        }
        finally
        {
            _previewLoading = false;
            StateHasChanged();
        }
    }

    private async Task UseTemplateAsync()
    {
        if (_previewBlueprint is null || _selectedTemplate is null) return;

        _saving = true;
        StateHasChanged();

        try
        {
            var saved = await BlueprintApi.SaveBlueprintAsync(_previewBlueprint);
            if (saved is not null)
            {
                Snackbar.Add($"Blueprint created from '{_selectedTemplate.Title}'", Severity.Success);
                _ = TemplateApi.IncrementUsageAsync(_selectedTemplate.Id);
                Navigation.NavigateTo($"blueprints?highlight={saved.Id}");
            }
            else
            {
                Snackbar.Add("Failed to save blueprint from template", Severity.Error);
            }
        }
        catch
        {
            Snackbar.Add("Error saving blueprint from template", Severity.Error);
        }
        finally
        {
            _saving = false;
            StateHasChanged();
        }
    }
}
