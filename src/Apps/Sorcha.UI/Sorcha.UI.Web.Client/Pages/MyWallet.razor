@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@page "/my-wallet"
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using Sorcha.UI.Core.Models.Wallet
@using Sorcha.UI.Core.Components.Shared
@using Sorcha.UI.Core.Services.Wallet
@inject IWalletApiService WalletApi
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>My Wallet - Sorcha Platform</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudStack Spacing="0">
            <MudText Typo="Typo.h4">
                <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Class="mr-2" />
                My Wallet
            </MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Manage your cryptographic wallets and identity
            </MudText>
        </MudStack>
        <MudButton Href="/wallets/create" Color="Color.Primary" Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.Add">
            Create Wallet
        </MudButton>
    </MudStack>

    @if (_serviceError)
    {
        <ServiceUnavailable ServiceName="Wallet Service" OnRetry="LoadWalletsAsync" />
    }
    else if (_loading)
    {
        <MudGrid>
            @for (var i = 0; i < 3; i++)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudCard Elevation="2">
                        <MudCardContent>
                            <MudSkeleton Width="60%" Height="24px" Class="mb-2" />
                            <MudSkeleton Width="100%" Height="16px" Class="mb-2" />
                            <MudSkeleton Width="40%" Height="16px" />
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else if (_wallets.Count == 0)
    {
        <EmptyState Icon="@Icons.Material.Filled.AccountBalanceWallet"
                    Title="No Wallets"
                    Description="Create your first wallet to start participating in workflows."
                    ActionText="Create Wallet"
                    OnAction="@(() => Navigation.NavigateTo("/wallets/create"))" />
    }
    else
    {
        <MudGrid>
            @foreach (var wallet in _wallets)
            {
                <MudItem xs="12" md="6" lg="4">
                    <MudCard Elevation="2" Style="cursor: pointer" @onclick="() => NavigateToWallet(wallet)">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@wallet.Name</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary">@wallet.Algorithm</MudChip>
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudField Label="Address" Variant="Variant.Text">
                                <TruncatedId Value="@wallet.Address" />
                            </MudField>
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                Created: @wallet.CreatedAt.ToString("MMM dd, yyyy")
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        <MudStack Row="true" Justify="Justify.Center" Class="mt-4">
            <MudButton Href="/wallets" Color="Color.Primary" Variant="Variant.Outlined"
                       StartIcon="@Icons.Material.Filled.ManageAccounts">
                Manage All Wallets
            </MudButton>
        </MudStack>
    }
</MudContainer>

@code {
    private List<WalletDto> _wallets = [];
    private bool _loading = true;
    private bool _serviceError;

    protected override async Task OnInitializedAsync()
    {
        await LoadWalletsAsync();
    }

    private async Task LoadWalletsAsync()
    {
        _loading = true;
        _serviceError = false;

        try
        {
            _wallets = await WalletApi.GetWalletsAsync();
        }
        catch
        {
            _serviceError = true;
        }
        finally
        {
            _loading = false;
        }
    }

    private void NavigateToWallet(WalletDto wallet)
    {
        Navigation.NavigateTo($"wallets/{wallet.Address}");  // Relative path respects base href /app/
    }
}
