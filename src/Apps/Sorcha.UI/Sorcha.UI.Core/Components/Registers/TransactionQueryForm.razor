@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@using Sorcha.UI.Core.Models.Registers

<MudPaper Elevation="1" Class="pa-4" data-testid="transaction-query-form">
    <MudStack Spacing="3">
        <MudText Typo="Typo.h6">Query Transactions</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            Search for transactions by wallet address across all registers you have access to.
        </MudText>

        <MudTextField @bind-Value="_walletAddress"
                      Label="Wallet Address"
                      Placeholder="Enter wallet address (26-58 characters)"
                      Required="true"
                      RequiredError="Wallet address is required"
                      Validation="@(new Func<string, string?>(ValidateAddress))"
                      Immediate="true"
                      Variant="Variant.Outlined"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.AccountBalanceWallet"
                      AdornmentColor="Color.Secondary"
                      Class="monospace-input"
                      data-testid="wallet-address-input" />

        <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
            @if (!string.IsNullOrWhiteSpace(_walletAddress))
            {
                <MudButton Variant="Variant.Text"
                           Color="Color.Secondary"
                           OnClick="ClearInput"
                           data-testid="clear-button">
                    Clear
                </MudButton>
            }
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Search"
                       OnClick="SubmitQuery"
                       Disabled="@(!IsValid || IsLoading)"
                       data-testid="search-button">
                @if (IsLoading)
                {
                    <MudProgressCircular Size="Size.Small" Color="Color.Inherit" Indeterminate="true" Class="mr-2" />
                    <span>Searching...</span>
                }
                else
                {
                    <span>Search Transactions</span>
                }
            </MudButton>
        </MudStack>
    </MudStack>
</MudPaper>

@code {
    /// <summary>
    /// Whether the form is in loading state
    /// </summary>
    [Parameter]
    public bool IsLoading { get; set; }

    /// <summary>
    /// Callback when search is submitted
    /// </summary>
    [Parameter]
    public EventCallback<string> OnSearch { get; set; }

    private string _walletAddress = string.Empty;

    private bool IsValid =>
        !string.IsNullOrWhiteSpace(_walletAddress) &&
        _walletAddress.Length >= 26 &&
        _walletAddress.Length <= 58;

    private string? ValidateAddress(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return "Wallet address is required";

        if (value.Length < 26)
            return "Address must be at least 26 characters";

        if (value.Length > 58)
            return "Address cannot exceed 58 characters";

        // Basic character validation (alphanumeric only for most wallet formats)
        if (!value.All(c => char.IsLetterOrDigit(c)))
            return "Address contains invalid characters";

        return null;
    }

    private async Task SubmitQuery()
    {
        if (IsValid && !IsLoading)
        {
            await OnSearch.InvokeAsync(_walletAddress.Trim());
        }
    }

    private void ClearInput()
    {
        _walletAddress = string.Empty;
    }
}

<style>
    .monospace-input input {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    }
</style>
