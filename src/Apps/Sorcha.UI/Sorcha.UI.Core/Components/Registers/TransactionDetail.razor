@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@using Sorcha.UI.Core.Models.Registers
@using Microsoft.JSInterop

@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar

<MudPaper Elevation="1" Class="pa-4" data-testid="transaction-detail">
    <MudStack Row="true"
              Justify="Justify.SpaceBetween"
              AlignItems="AlignItems.Center"
              Class="mb-3">
        <MudText Typo="Typo.h6">Transaction Details</MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Close"
                       Size="Size.Small"
                       OnClick="OnCloseClicked"
                       aria-label="Close details"
                       data-testid="close-detail" />
    </MudStack>

    <MudDivider Class="mb-4" />

    @* Transaction ID Section *@
    <MudStack Spacing="3">
        <MudStack Spacing="0">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Transaction ID</MudText>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudText Typo="Typo.body2" Class="monospace-text" Style="word-break: break-all;" data-testid="tx-id">
                    @Transaction.TxId
                </MudText>
                <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                               Size="Size.Small"
                               OnClick="CopyTxId"
                               aria-label="Copy transaction ID"
                               data-testid="copy-tx-id" />
            </MudStack>
        </MudStack>

        @* Status and Type *@
        <MudGrid Spacing="3">
            <MudItem xs="6">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Status</MudText>
                    @if (Transaction.DocketNumber.HasValue)
                    {
                        <MudChip T="string"
                                 Size="Size.Small"
                                 Icon="@Icons.Material.Filled.CheckCircle"
                                 Color="Color.Success">
                            Confirmed
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string"
                                 Size="Size.Small"
                                 Icon="@Icons.Material.Filled.Schedule"
                                 Color="Color.Warning">
                            Pending
                        </MudChip>
                    }
                </MudStack>
            </MudItem>
            <MudItem xs="6">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Type</MudText>
                    <MudChip T="string"
                             Size="Size.Small"
                             Color="@GetTypeColor()">
                        @Transaction.TransactionType
                    </MudChip>
                </MudStack>
            </MudItem>
        </MudGrid>

        @* Docket Information *@
        @if (Transaction.DocketNumber.HasValue)
        {
            <MudStack Spacing="0">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Docket Number</MudText>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.Layers" Size="Size.Small" Color="Color.Secondary" />
                    <MudText Typo="Typo.body1">@Transaction.DocketNumber</MudText>
                </MudStack>
            </MudStack>
        }

        @* Timestamp *@
        <MudStack Spacing="0">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Timestamp</MudText>
            <MudText Typo="Typo.body1">@Transaction.TimeStamp.ToString("yyyy-MM-dd HH:mm:ss UTC")</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">(@Transaction.TimeStampFormatted)</MudText>
        </MudStack>

        <MudDivider />

        @* Sender Information *@
        <MudStack Spacing="0">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Sender Wallet</MudText>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudText Typo="Typo.body2" Class="monospace-text" Style="word-break: break-all;" data-testid="sender-wallet">
                    @Transaction.SenderWallet
                </MudText>
                <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                               Size="Size.Small"
                               OnClick="CopySenderWallet"
                               aria-label="Copy sender wallet"
                               data-testid="copy-sender-wallet" />
            </MudStack>
        </MudStack>

        @* Recipients *@
        @if (Transaction.RecipientsWallets.Count > 0)
        {
            <MudStack Spacing="1">
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Recipients (@Transaction.RecipientsWallets.Count)
                </MudText>
                @foreach (var recipient in Transaction.RecipientsWallets)
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudText Typo="Typo.body2" Class="monospace-text" Style="word-break: break-all;" data-testid="recipient-wallet">
                            @recipient
                        </MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                       Size="Size.Small"
                                       OnClick="@(() => CopyRecipientWallet(recipient))"
                                       aria-label="Copy recipient wallet"
                                       data-testid="copy-recipient-wallet" />
                    </MudStack>
                }
            </MudStack>
        }

        <MudDivider />

        @* Signature Information *@
        <MudStack Spacing="0">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Signature</MudText>
            <MudText Typo="Typo.body2" Class="monospace-text signature-text" data-testid="signature">
                @Transaction.Signature
            </MudText>
            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                           Size="Size.Small"
                           OnClick="CopySignature"
                           aria-label="Copy signature"
                           data-testid="copy-signature" />
        </MudStack>

        @* Payload Information *@
        <MudStack Spacing="1">
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Payloads (@Transaction.PayloadCount)
            </MudText>
            @if (Transaction.Payloads.Count > 0)
            {
                <MudExpansionPanels MultiExpansion="true" Elevation="0" Dense="true">
                    @foreach (var payload in Transaction.Payloads)
                    {
                        <MudExpansionPanel data-testid="@($"payload-panel-{payload.Index}")">
                            <TitleContent>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Attachment" Size="Size.Small" Color="Color.Secondary" />
                                    <MudText Typo="Typo.body2">Payload @payload.Index</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@payload.PayloadSizeFormatted</MudText>
                                </MudStack>
                            </TitleContent>
                            <ChildContent>
                                <MudStack Spacing="2" Class="pa-2">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Hash</MudText>
                                        <MudText Typo="Typo.body2" Class="monospace-text" Style="word-break: break-all;">
                                            @payload.Hash
                                        </MudText>
                                    </MudStack>

                                    @if (payload.WalletAccess.Count > 0)
                                    {
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                Wallet Access (@payload.WalletAccess.Count)
                                            </MudText>
                                            @foreach (var wallet in payload.WalletAccess)
                                            {
                                                <MudText Typo="Typo.body2" Class="monospace-text" Style="word-break: break-all;">
                                                    @wallet
                                                </MudText>
                                            }
                                        </MudStack>
                                    }

                                    <MudGrid Spacing="2">
                                        @if (!string.IsNullOrEmpty(payload.PayloadFlags))
                                        {
                                            <MudItem xs="6">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">Flags</MudText>
                                                <MudText Typo="Typo.body2">@payload.PayloadFlags</MudText>
                                            </MudItem>
                                        }
                                        <MudItem xs="6">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Encrypted</MudText>
                                            <MudText Typo="Typo.body2">@(payload.HasIV ? "Yes" : "No")</MudText>
                                        </MudItem>
                                        @if (payload.ChallengeCount > 0)
                                        {
                                            <MudItem xs="6">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">Challenges</MudText>
                                                <MudText Typo="Typo.body2">@payload.ChallengeCount</MudText>
                                            </MudItem>
                                        }
                                    </MudGrid>

                                    @if (!string.IsNullOrEmpty(payload.Data))
                                    {
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Data</MudText>
                                            <div class="payload-data-container">
                                                <MudText Typo="Typo.body2" Class="monospace-text">
                                                    @payload.Data
                                                </MudText>
                                            </div>
                                        </MudStack>
                                    }
                                </MudStack>
                            </ChildContent>
                        </MudExpansionPanel>
                    }
                </MudExpansionPanels>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">No payload details available</MudText>
            }
        </MudStack>

        @* Action ID (if applicable) *@
        @if (Transaction.ActionId.HasValue)
        {
            <MudStack Spacing="0">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Action ID</MudText>
                <MudText Typo="Typo.body1">@Transaction.ActionId</MudText>
            </MudStack>
        }
    </MudStack>
</MudPaper>

@code {
    /// <summary>
    /// The transaction to display
    /// </summary>
    [Parameter]
    public required TransactionViewModel Transaction { get; set; }

    /// <summary>
    /// Callback when the close button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnClose { get; set; }

    private Color GetTypeColor() => Transaction.TransactionType switch
    {
        "Action" => Color.Primary,
        "Blueprint" => Color.Secondary,
        _ => Color.Default
    };

    private async Task OnCloseClicked()
    {
        await OnClose.InvokeAsync();
    }

    private async Task CopyTxId()
    {
        await CopyToClipboardAsync(Transaction.TxId);
    }

    private async Task CopySenderWallet()
    {
        await CopyToClipboardAsync(Transaction.SenderWallet);
    }

    private async Task CopyRecipientWallet(string recipient)
    {
        await CopyToClipboardAsync(recipient);
    }

    private async Task CopySignature()
    {
        await CopyToClipboardAsync(Transaction.Signature);
    }

    private async Task CopyToClipboardAsync(string text)
    {
        try
        {
            var success = await JSRuntime.InvokeAsync<bool>("clipboardInterop.copyText", text);
            if (success)
            {
                Snackbar.Add("Copied to clipboard", Severity.Success, config =>
                {
                    config.VisibleStateDuration = 1500;
                    config.ShowCloseIcon = false;
                });
            }
            else
            {
                Snackbar.Add("Failed to copy to clipboard", Severity.Error);
            }
        }
        catch
        {
            // Fallback to navigator.clipboard for compatibility
            try
            {
                await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
                Snackbar.Add("Copied to clipboard", Severity.Success, config =>
                {
                    config.VisibleStateDuration = 1500;
                    config.ShowCloseIcon = false;
                });
            }
            catch
            {
                Snackbar.Add("Failed to copy to clipboard", Severity.Error);
            }
        }
    }
}

<style>
    .monospace-text {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.85rem;
    }

    .signature-text {
        word-break: break-all;
        max-height: 60px;
        overflow-y: auto;
    }

    .payload-data-container {
        max-height: 200px;
        overflow-y: auto;
        background: var(--mud-palette-background-grey);
        border-radius: 4px;
        padding: 8px;
        word-break: break-all;
    }
</style>
