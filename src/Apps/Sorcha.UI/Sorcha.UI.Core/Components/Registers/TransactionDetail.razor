@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2025 Sorcha Contributors *@

@using Sorcha.UI.Core.Models.Registers
@using Microsoft.JSInterop

@inject IJSRuntime JSRuntime

<MudPaper Elevation="1" Class="pa-4" data-testid="transaction-detail">
    <MudStack Row="true"
              Justify="Justify.SpaceBetween"
              AlignItems="AlignItems.Center"
              Class="mb-3">
        <MudText Typo="Typo.h6">Transaction Details</MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Close"
                       Size="Size.Small"
                       OnClick="OnCloseClicked"
                       aria-label="Close details" />
    </MudStack>

    <MudDivider Class="mb-4" />

    @* Transaction ID Section *@
    <MudStack Spacing="3">
        <MudStack Spacing="0">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Transaction ID</MudText>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudText Typo="Typo.body2" Class="monospace-text" Style="word-break: break-all;">
                    @Transaction.TxId
                </MudText>
                <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                               Size="Size.Small"
                               OnClick="CopyTxId"
                               aria-label="Copy transaction ID" />
            </MudStack>
        </MudStack>

        @* Status and Type *@
        <MudGrid Spacing="3">
            <MudItem xs="6">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Status</MudText>
                    @if (Transaction.BlockNumber.HasValue)
                    {
                        <MudChip T="string"
                                 Size="Size.Small"
                                 Icon="@Icons.Material.Filled.CheckCircle"
                                 Color="Color.Success">
                            Confirmed
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string"
                                 Size="Size.Small"
                                 Icon="@Icons.Material.Filled.Schedule"
                                 Color="Color.Warning">
                            Pending
                        </MudChip>
                    }
                </MudStack>
            </MudItem>
            <MudItem xs="6">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Type</MudText>
                    <MudChip T="string"
                             Size="Size.Small"
                             Color="@GetTypeColor()">
                        @Transaction.TransactionType
                    </MudChip>
                </MudStack>
            </MudItem>
        </MudGrid>

        @* Block Information *@
        @if (Transaction.BlockNumber.HasValue)
        {
            <MudStack Spacing="0">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Block Number</MudText>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.Layers" Size="Size.Small" Color="Color.Secondary" />
                    <MudText Typo="Typo.body1">@Transaction.BlockNumber</MudText>
                </MudStack>
            </MudStack>
        }

        @* Timestamp *@
        <MudStack Spacing="0">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Timestamp</MudText>
            <MudText Typo="Typo.body1">@Transaction.TimeStamp.ToString("yyyy-MM-dd HH:mm:ss UTC")</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">(@Transaction.TimeStampFormatted)</MudText>
        </MudStack>

        <MudDivider />

        @* Sender Information *@
        <MudStack Spacing="0">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Sender Wallet</MudText>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudText Typo="Typo.body2" Class="monospace-text" Style="word-break: break-all;">
                    @Transaction.SenderWallet
                </MudText>
                <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                               Size="Size.Small"
                               OnClick="CopySenderWallet"
                               aria-label="Copy sender wallet" />
            </MudStack>
        </MudStack>

        @* Recipients *@
        @if (Transaction.RecipientsWallets.Count > 0)
        {
            <MudStack Spacing="1">
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Recipients (@Transaction.RecipientsWallets.Count)
                </MudText>
                @foreach (var recipient in Transaction.RecipientsWallets)
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudText Typo="Typo.body2" Class="monospace-text" Style="word-break: break-all;">
                            @recipient
                        </MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                       Size="Size.Small"
                                       OnClick="@(() => CopyRecipientWallet(recipient))"
                                       aria-label="Copy recipient wallet" />
                    </MudStack>
                }
            </MudStack>
        }

        <MudDivider />

        @* Signature Information *@
        <MudStack Spacing="0">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Signature</MudText>
            <MudText Typo="Typo.body2" Class="monospace-text signature-text">
                @Transaction.Signature
            </MudText>
            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                           Size="Size.Small"
                           OnClick="CopySignature"
                           aria-label="Copy signature" />
        </MudStack>

        @* Payload Information *@
        <MudStack Spacing="0">
            <MudText Typo="Typo.caption" Color="Color.Secondary">Payloads</MudText>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudIcon Icon="@Icons.Material.Filled.Attachment" Size="Size.Small" Color="Color.Secondary" />
                <MudText Typo="Typo.body1">@Transaction.PayloadCount payload(s)</MudText>
            </MudStack>
        </MudStack>

        @* Action ID (if applicable) *@
        @if (Transaction.ActionId.HasValue)
        {
            <MudStack Spacing="0">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Action ID</MudText>
                <MudText Typo="Typo.body1">@Transaction.ActionId</MudText>
            </MudStack>
        }
    </MudStack>
</MudPaper>

@code {
    /// <summary>
    /// The transaction to display
    /// </summary>
    [Parameter]
    public required TransactionViewModel Transaction { get; set; }

    /// <summary>
    /// Callback when the close button is clicked
    /// </summary>
    [Parameter]
    public EventCallback OnClose { get; set; }

    private Color GetTypeColor() => Transaction.TransactionType switch
    {
        "Action" => Color.Primary,
        "Blueprint" => Color.Secondary,
        _ => Color.Default
    };

    private async Task OnCloseClicked()
    {
        await OnClose.InvokeAsync();
    }

    private async Task CopyTxId()
    {
        await CopyToClipboardAsync(Transaction.TxId);
    }

    private async Task CopySenderWallet()
    {
        await CopyToClipboardAsync(Transaction.SenderWallet);
    }

    private async Task CopyRecipientWallet(string recipient)
    {
        await CopyToClipboardAsync(recipient);
    }

    private async Task CopySignature()
    {
        await CopyToClipboardAsync(Transaction.Signature);
    }

    private async Task CopyToClipboardAsync(string text)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        }
        catch
        {
            // Clipboard API might not be available in all contexts
            // Fail silently
        }
    }
}

<style>
    .monospace-text {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.85rem;
    }

    .signature-text {
        word-break: break-all;
        max-height: 60px;
        overflow-y: auto;
    }
</style>
