@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2025 Sorcha Contributors *@

@using Sorcha.Register.Models.Enums
@using Sorcha.UI.Core.Models.Registers
@using Sorcha.UI.Core.Models.Wallet
@using Sorcha.UI.Core.Services
@using Sorcha.UI.Core.Services.Wallet

@inject IRegisterService RegisterService
@inject IWalletApiService WalletService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />
            Create New Register
        </MudText>
    </TitleContent>
    <DialogContent>
        @* Step indicator *@
        <MudStepper @bind-ActiveIndex="_activeStep"
                    CurrentStepColor="Color.Primary"
                    Class="mb-4"
                    data-testid="wizard-stepper">
            <MudStep Title="Name" data-testid="step-name">
                <MudText Typo="Typo.body2">Enter a name for your register</MudText>
            </MudStep>
            <MudStep Title="Wallet" data-testid="step-wallet">
                <MudText Typo="Typo.body2">Select signing wallet</MudText>
            </MudStep>
            <MudStep Title="Options" data-testid="step-options">
                <MudText Typo="Typo.body2">Configure register settings</MudText>
            </MudStep>
            <MudStep Title="Create" data-testid="step-create">
                <MudText Typo="Typo.body2">Review and create</MudText>
            </MudStep>
        </MudStepper>

        @* Step content *@
        <MudPaper Elevation="0" Class="pa-4">
            @if (_state.IsProcessing)
            {
                <MudStack AlignItems="AlignItems.Center" Spacing="4" Class="py-8">
                    <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
                    <MudText Typo="Typo.body1" Color="Color.Secondary">
                        @GetProcessingMessage()
                    </MudText>
                </MudStack>
            }
            else if (_state.ErrorMessage is not null)
            {
                <MudAlert Severity="Severity.Error" Class="mb-4" data-testid="error-alert">
                    <MudStack Spacing="2">
                        <MudText>@_state.ErrorMessage</MudText>
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Error"
                                   Size="Size.Small"
                                   OnClick="RetryCreation"
                                   data-testid="retry-button">
                            Try Again
                        </MudButton>
                    </MudStack>
                </MudAlert>
            }
            else
            {
                @switch (_activeStep)
                {
                    case 0:
                        @* Step 1: Enter register name *@
                        <MudStack Spacing="4" data-testid="wizard-step-1">
                            <MudTextField @bind-Value="_name"
                                          Label="Register Name"
                                          Placeholder="Enter a name (1-38 characters)"
                                          Required="true"
                                          RequiredError="Register name is required"
                                          Counter="38"
                                          MaxLength="38"
                                          Immediate="true"
                                          Validation="@(new Func<string, string?>(ValidateName))"
                                          HelperText="A unique name to identify your register"
                                          data-testid="register-name-input" />

                            <MudTextField @bind-Value="_description"
                                          Label="Description"
                                          Placeholder="Describe the purpose of this register (optional)"
                                          Lines="3"
                                          MaxLength="500"
                                          Counter="500"
                                          HelperText="A brief description visible to participants"
                                          data-testid="register-description-input" />

                            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                                <MudText Typo="Typo.body2">
                                    The register name will be visible to all participants with access to the register.
                                    Choose a descriptive name that reflects the register's purpose.
                                </MudText>
                            </MudAlert>
                        </MudStack>
                        break;

                    case 1:
                        @* Step 2: Select signing wallet *@
                        <MudStack Spacing="4" data-testid="wizard-step-2">
                            @if (_state.IsLoadingWallets)
                            {
                                <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="py-4">
                                    <MudProgressCircular Indeterminate="true" Size="Size.Medium" Color="Color.Primary" />
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Loading wallets...</MudText>
                                </MudStack>
                            }
                            else if (_wallets.Count == 0)
                            {
                                <MudAlert Severity="Severity.Warning" data-testid="no-wallets-warning">
                                    <MudText Typo="Typo.body1">No Wallets Available</MudText>
                                    <MudText Typo="Typo.body2" Class="mt-2">
                                        You need at least one active wallet to create a register.
                                        Please create a wallet first using the Wallet section.
                                    </MudText>
                                </MudAlert>
                            }
                            else
                            {
                                <MudText Typo="Typo.body1" Class="mb-2">Select a wallet to sign the register creation:</MudText>

                                <MudSelect T="string"
                                           @bind-Value="_selectedWalletAddress"
                                           Label="Signing Wallet"
                                           Placeholder="Choose a wallet"
                                           Required="true"
                                           RequiredError="Please select a wallet"
                                           Variant="Variant.Outlined"
                                           FullWidth="true"
                                           AnchorOrigin="Origin.BottomCenter"
                                           data-testid="wallet-select">
                                    @foreach (var wallet in _wallets)
                                    {
                                        <MudSelectItem Value="@wallet.Address" data-testid="wallet-option">
                                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                                <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Size="Size.Small" />
                                                <MudStack Spacing="0">
                                                    <MudText Typo="Typo.body2">@wallet.Name</MudText>
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="monospace-text">
                                                        @wallet.AddressTruncated
                                                    </MudText>
                                                </MudStack>
                                                <MudChip T="string" Size="Size.Small" Color="Color.Default">
                                                    @wallet.Algorithm
                                                </MudChip>
                                            </MudStack>
                                        </MudSelectItem>
                                    }
                                </MudSelect>

                                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                                    <MudText Typo="Typo.body2">
                                        This wallet will sign the register's control record, establishing you as the register owner.
                                        All future administrative actions will require this wallet's signature.
                                    </MudText>
                                </MudAlert>
                            }
                        </MudStack>
                        break;

                    case 2:
                        @* Step 3: Configure options *@
                        <MudStack Spacing="4" data-testid="wizard-step-3">
                            <MudPaper Elevation="0" Class="pa-3 mud-theme-secondary" Style="border-radius: 8px;">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body1">Public Register</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            Advertise this register to network peers
                                        </MudText>
                                    </MudStack>
                                    <MudSwitch @bind-Value="_advertise"
                                               Color="Color.Primary"
                                               data-testid="advertise-switch" />
                                </MudStack>
                            </MudPaper>

                            <MudPaper Elevation="0" Class="pa-3 mud-theme-secondary" Style="border-radius: 8px;">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body1">Full Replica</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            Maintain complete transaction history
                                        </MudText>
                                    </MudStack>
                                    <MudSwitch @bind-Value="_isFullReplica"
                                               Color="Color.Primary"
                                               data-testid="full-replica-switch" />
                                </MudStack>
                            </MudPaper>

                            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                                <MudText Typo="Typo.body2">
                                    @if (_advertise)
                                    {
                                        <span><strong>Public:</strong> Other participants can discover and subscribe to this register.</span>
                                    }
                                    else
                                    {
                                        <span><strong>Private:</strong> Only invited participants can access this register.</span>
                                    }
                                </MudText>
                            </MudAlert>
                        </MudStack>
                        break;

                    case 3:
                        @* Step 4: Review and create *@
                        <MudStack Spacing="4" data-testid="wizard-step-4">
                            <MudText Typo="Typo.h6">Review Your Register</MudText>

                            <MudPaper Elevation="1" Class="pa-4">
                                <MudStack Spacing="3">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Name</MudText>
                                        <MudText Typo="Typo.body1" data-testid="review-name">@_name</MudText>
                                    </MudStack>
                                    <MudDivider />
                                    @if (!string.IsNullOrWhiteSpace(_description))
                                    {
                                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Description</MudText>
                                            <MudText Typo="Typo.body2" data-testid="review-description" Style="max-width: 60%; text-align: right;">
                                                @_description
                                            </MudText>
                                        </MudStack>
                                        <MudDivider />
                                    }
                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Signing Wallet</MudText>
                                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                                            <MudText Typo="Typo.body2" data-testid="review-wallet-name">@GetSelectedWalletName()</MudText>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="monospace-text">
                                                @GetSelectedWalletTruncated()
                                            </MudText>
                                        </MudStack>
                                    </MudStack>
                                    <MudDivider />
                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Visibility</MudText>
                                        <MudChip T="string"
                                                 Size="Size.Small"
                                                 Color="@(_advertise ? Color.Success : Color.Default)"
                                                 data-testid="review-visibility">
                                            @(_advertise ? "Public" : "Private")
                                        </MudChip>
                                    </MudStack>
                                    <MudDivider />
                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Storage Mode</MudText>
                                        <MudChip T="string"
                                                 Size="Size.Small"
                                                 Color="@(_isFullReplica ? Color.Primary : Color.Secondary)"
                                                 data-testid="review-storage">
                                            @(_isFullReplica ? "Full Replica" : "Lightweight")
                                        </MudChip>
                                    </MudStack>
                                </MudStack>
                            </MudPaper>

                            <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined">
                                <MudText Typo="Typo.body2">
                                    Creating a register will sign the control record with your selected wallet.
                                    This action cannot be undone.
                                </MudText>
                            </MudAlert>
                        </MudStack>
                        break;
                }
            }
        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel"
                   Disabled="@_state.IsProcessing"
                   data-testid="wizard-cancel">
            Cancel
        </MudButton>
        @if (_activeStep > 0)
        {
            <MudButton OnClick="PreviousStep"
                       Disabled="@_state.IsProcessing"
                       Variant="Variant.Outlined"
                       data-testid="wizard-back">
                Back
            </MudButton>
        }
        @if (_activeStep < 3)
        {
            <MudButton OnClick="NextStep"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="@(!CanProceed())"
                       data-testid="wizard-next">
                Next
            </MudButton>
        }
        else
        {
            <MudButton OnClick="CreateRegisterAsync"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="@(_state.IsProcessing || !HasValidWallet())"
                       data-testid="wizard-create">
                Create Register
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    /// <summary>
    /// Tenant ID for the new register
    /// </summary>
    [Parameter]
    public string TenantId { get; set; } = string.Empty;

    /// <summary>
    /// Current user ID for the owner attestation
    /// </summary>
    [Parameter]
    public string UserId { get; set; } = "user-001";

    /// <summary>
    /// Callback when register is created successfully
    /// </summary>
    [Parameter]
    public EventCallback<RegisterViewModel> OnRegisterCreated { get; set; }

    private int _activeStep = 0;
    private string _name = string.Empty;
    private string _description = string.Empty;
    private string? _selectedWalletAddress;
    private bool _advertise;
    private bool _isFullReplica = true;
    private RegisterCreationState _state = new();
    private List<WalletViewModel> _wallets = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadWalletsAsync();
    }

    private async Task LoadWalletsAsync()
    {
        _state = _state with { IsLoadingWallets = true };

        try
        {
            var walletDtos = await WalletService.GetWalletsAsync();
            _wallets = walletDtos
                .Where(w => w.Status == "Active")
                .Select(w => new WalletViewModel
                {
                    Address = w.Address,
                    Name = w.Name,
                    Algorithm = w.Algorithm,
                    Status = w.Status ?? "Active"
                })
                .ToList();

            // Auto-select first wallet if only one available
            if (_wallets.Count == 1)
            {
                _selectedWalletAddress = _wallets[0].Address;
            }
        }
        catch
        {
            // Failed to load wallets - will show empty state
            _wallets = [];
        }
        finally
        {
            _state = _state with { IsLoadingWallets = false };
        }
    }

    private string? ValidateName(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return "Register name is required";

        if (value.Length < 1)
            return "Name must be at least 1 character";

        if (value.Length > 38)
            return "Name cannot exceed 38 characters";

        return null;
    }

    private bool CanProceed() => _activeStep switch
    {
        0 => !string.IsNullOrWhiteSpace(_name) && _name.Length >= 1 && _name.Length <= 38,
        1 => HasValidWallet(),
        2 => true,
        3 => true,
        _ => false
    };

    private bool HasValidWallet() => !string.IsNullOrEmpty(_selectedWalletAddress);

    private string GetSelectedWalletName()
    {
        var wallet = _wallets.FirstOrDefault(w => w.Address == _selectedWalletAddress);
        return wallet?.Name ?? "Unknown";
    }

    private string GetSelectedWalletTruncated()
    {
        var wallet = _wallets.FirstOrDefault(w => w.Address == _selectedWalletAddress);
        return wallet?.AddressTruncated ?? _selectedWalletAddress ?? "";
    }

    private string GetProcessingMessage() => _state.CurrentStep switch
    {
        1 => "Initiating register creation...",
        2 => "Signing attestation...",
        3 => "Finalizing register...",
        _ => "Processing..."
    };

    private void NextStep()
    {
        if (CanProceed() && _activeStep < 3)
        {
            _activeStep++;
        }
    }

    private void PreviousStep()
    {
        if (_activeStep > 0)
        {
            _activeStep--;
        }
    }

    private void RetryCreation()
    {
        _state = _state with { ErrorMessage = null };
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private async Task CreateRegisterAsync()
    {
        if (!HasValidWallet())
        {
            _state = _state with { ErrorMessage = "Please select a wallet to sign the register creation." };
            return;
        }

        _state = _state with
        {
            IsProcessing = true,
            ErrorMessage = null,
            CurrentStep = 1
        };

        try
        {
            // Step 1: Initiate register creation
            var initiateRequest = new CreateRegisterRequest
            {
                Name = _name,
                Description = string.IsNullOrWhiteSpace(_description) ? null : _description.Trim(),
                TenantId = TenantId,
                Owners = new List<OwnerInfo>
                {
                    new OwnerInfo
                    {
                        UserId = UserId,
                        WalletId = _selectedWalletAddress!
                    }
                },
                Metadata = new Dictionary<string, string>
                {
                    ["advertise"] = _advertise.ToString().ToLowerInvariant(),
                    ["isFullReplica"] = _isFullReplica.ToString().ToLowerInvariant()
                }
            };

            var initiateResponse = await RegisterService.InitiateRegisterAsync(initiateRequest);

            if (initiateResponse is null || initiateResponse.AttestationsToSign.Count == 0)
            {
                _state = _state with
                {
                    IsProcessing = false,
                    ErrorMessage = "Failed to initiate register creation. Please try again."
                };
                return;
            }

            _state = _state with { CurrentStep = 2 };

            // Step 2: Sign each attestation
            var signedAttestations = new List<SignedAttestation>();

            foreach (var attestation in initiateResponse.AttestationsToSign)
            {
                // Convert hex hash to bytes for signing
                var hashBytes = Convert.FromHexString(attestation.DataToSign);

                // Sign the hash with the wallet (hash is pre-computed, don't re-hash)
                var signRequest = new SignTransactionRequest
                {
                    TransactionData = Convert.ToBase64String(hashBytes),
                    DerivationPath = "sorcha:register-attestation",
                    IsPreHashed = true
                };

                var signResponse = await WalletService.SignDataAsync(
                    attestation.WalletId,
                    signRequest);

                if (signResponse is null || string.IsNullOrEmpty(signResponse.Signature))
                {
                    _state = _state with
                    {
                        IsProcessing = false,
                        ErrorMessage = $"Failed to sign attestation for {attestation.UserId}. Please try again."
                    };
                    return;
                }

                // Get algorithm from the wallet model
                var signingWallet = _wallets.FirstOrDefault(w => w.Address == attestation.WalletId);
                var algorithm = signingWallet?.Algorithm ?? "ED25519";

                signedAttestations.Add(new SignedAttestation
                {
                    AttestationData = attestation.AttestationData,
                    PublicKey = signResponse.PublicKey ?? "",
                    Signature = signResponse.Signature,
                    Algorithm = algorithm
                });
            }

            _state = _state with { CurrentStep = 3 };

            // Step 3: Finalize register creation with signed attestations
            var finalizeRequest = new FinalizeRegisterRequest
            {
                RegisterId = initiateResponse.RegisterId,
                Nonce = initiateResponse.Nonce,
                SignedAttestations = signedAttestations
            };

            var finalizeResponse = await RegisterService.FinalizeRegisterAsync(finalizeRequest);

            if (finalizeResponse is null)
            {
                _state = _state with
                {
                    IsProcessing = false,
                    ErrorMessage = "Failed to finalize register creation. Please try again."
                };
                return;
            }

            // Success - create view model for callback
            // Parse status string to enum (default to Online for newly created registers)
            var status = Enum.TryParse<RegisterStatus>(finalizeResponse.Status, true, out var parsedStatus)
                ? parsedStatus
                : RegisterStatus.Online;

            var createdRegister = new RegisterViewModel
            {
                Id = finalizeResponse.RegisterId,
                Name = _name,
                Description = string.IsNullOrWhiteSpace(_description) ? null : _description.Trim(),
                Status = status,
                Advertise = _advertise,
                IsFullReplica = _isFullReplica,
                TenantId = TenantId,
                CreatedAt = finalizeResponse.CreatedAt.UtcDateTime,
                UpdatedAt = finalizeResponse.CreatedAt.UtcDateTime
            };

            await OnRegisterCreated.InvokeAsync(createdRegister);
            MudDialog?.Close(DialogResult.Ok(createdRegister));
        }
        catch (Exception ex)
        {
            _state = _state with
            {
                IsProcessing = false,
                ErrorMessage = $"An error occurred: {ex.Message}"
            };
        }
    }
}

<style>
    .monospace-text {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.85rem;
    }
</style>
