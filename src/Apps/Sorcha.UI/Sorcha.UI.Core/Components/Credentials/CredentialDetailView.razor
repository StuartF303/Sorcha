@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@using MudBlazor
@using Sorcha.UI.Core.Models.Credentials

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" />
            <MudText Typo="Typo.h6">@Credential.Type</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            @* Status and metadata *@
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudChip T="string" Color="@GetStatusColor()" Variant="Variant.Filled">
                    @Credential.Status
                </MudChip>
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    ID: @Credential.CredentialId
                </MudText>
            </MudStack>

            <MudDivider />

            @* Key metadata *@
            <MudSimpleTable Dense="true" Hover="true" Bordered="false">
                <tbody>
                    <tr>
                        <td><MudText Typo="Typo.body2" Color="Color.Secondary">Issuer</MudText></td>
                        <td><MudText Typo="Typo.body2">@Credential.IssuerDid</MudText></td>
                    </tr>
                    <tr>
                        <td><MudText Typo="Typo.body2" Color="Color.Secondary">Subject</MudText></td>
                        <td><MudText Typo="Typo.body2">@Credential.SubjectDid</MudText></td>
                    </tr>
                    <tr>
                        <td><MudText Typo="Typo.body2" Color="Color.Secondary">Issued</MudText></td>
                        <td><MudText Typo="Typo.body2">@Credential.IssuedAt.ToString("yyyy-MM-dd HH:mm:ss")</MudText></td>
                    </tr>
                    @if (Credential.ExpiresAt.HasValue)
                    {
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Expires</MudText></td>
                            <td><MudText Typo="Typo.body2">@Credential.ExpiresAt.Value.ToString("yyyy-MM-dd HH:mm:ss")</MudText></td>
                        </tr>
                    }
                    <tr>
                        <td><MudText Typo="Typo.body2" Color="Color.Secondary">Usage Policy</MudText></td>
                        <td><MudText Typo="Typo.body2">@FormatUsagePolicy()</MudText></td>
                    </tr>
                    @if (Credential.PresentationCount > 0)
                    {
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Presentations</MudText></td>
                            <td><MudText Typo="Typo.body2">@Credential.PresentationCount</MudText></td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>

            @* Claims section *@
            @if (Credential.Claims.Count > 0)
            {
                <MudText Typo="Typo.subtitle2" Class="mt-2">Claims</MudText>
                <MudSimpleTable Dense="true" Hover="true" Bordered="true">
                    <thead>
                        <tr>
                            <th>Claim</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var claim in Credential.Claims)
                        {
                            <tr>
                                <td><MudText Typo="Typo.body2">@claim.Key</MudText></td>
                                <td><MudText Typo="Typo.body2">@claim.Value?.ToString()</MudText></td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        @if (Credential.Status == "Active")
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled"
                       StartIcon="@Icons.Material.Filled.Share"
                       OnClick="@(() => OnPresent.InvokeAsync())">
                Present
            </MudButton>
            <MudButton Color="Color.Default" Variant="Variant.Outlined"
                       StartIcon="@Icons.Material.Filled.Download"
                       OnClick="@(() => OnExport.InvokeAsync())">
                Export
            </MudButton>
        }
        <MudButton Color="Color.Error" Variant="Variant.Text"
                   StartIcon="@Icons.Material.Filled.Delete"
                   OnClick="@(() => OnDelete.InvokeAsync())">
            Delete
        </MudButton>
        <MudButton Color="Color.Default" OnClick="@(() => MudDialog.Close())">
            Close
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter, EditorRequired]
    public CredentialDetailViewModel Credential { get; set; } = default!;

    [Parameter]
    public EventCallback OnPresent { get; set; }

    [Parameter]
    public EventCallback OnExport { get; set; }

    [Parameter]
    public EventCallback OnDelete { get; set; }

    private Color GetStatusColor() => Credential.Status switch
    {
        "Active" => Color.Success,
        "Suspended" => Color.Warning,
        "Revoked" => Color.Error,
        "Expired" => Color.Default,
        "Consumed" => Color.Default,
        _ => Color.Default
    };

    private string FormatUsagePolicy()
    {
        return Credential.UsagePolicy switch
        {
            "LimitedUse" => $"Limited Use ({Credential.PresentationCount}/{Credential.MaxPresentations})",
            "SingleUse" => "Single Use",
            _ => "Reusable"
        };
    }
}
