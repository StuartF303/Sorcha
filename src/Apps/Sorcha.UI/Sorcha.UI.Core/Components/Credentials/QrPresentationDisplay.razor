@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@using Sorcha.UI.Core.Services
@inject IQrPresentationService QrService

<MudCard Elevation="3" Class="pa-4">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Credential Verification</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Scan the QR code with your wallet to present credentials
            </MudText>
        </CardHeaderContent>
    </MudCardHeader>

    <MudCardContent Class="d-flex flex-column align-center">
        @if (!string.IsNullOrEmpty(_svgContent))
        {
            <div class="qr-code-container mb-4">
                @((MarkupString)_svgContent)
            </div>
        }

        @if (Status == "Pending")
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-2" />
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Waiting for presentation...
            </MudText>
        }
        else if (Status == "Verified")
        {
            <MudAlert Severity="Severity.Success" Class="mt-2">
                Credential verified successfully
            </MudAlert>
        }
        else if (Status == "Denied")
        {
            <MudAlert Severity="Severity.Error" Class="mt-2">
                Presentation denied or verification failed
            </MudAlert>
        }
        else if (Status == "Expired")
        {
            <MudAlert Severity="Severity.Warning" Class="mt-2">
                Request has expired. Please create a new one.
            </MudAlert>
        }

        @if (ExpiresAt.HasValue && Status == "Pending")
        {
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                Expires: @ExpiresAt.Value.LocalDateTime.ToString("HH:mm:ss")
            </MudText>
        }
    </MudCardContent>
</MudCard>

<style>
    .qr-code-container svg {
        max-width: 280px;
        max-height: 280px;
    }
</style>

@code {
    [Parameter] public string? RequestUrl { get; set; }
    [Parameter] public string? Nonce { get; set; }
    [Parameter] public string? RequestId { get; set; }
    [Parameter] public string Status { get; set; } = "Pending";
    [Parameter] public DateTimeOffset? ExpiresAt { get; set; }
    [Parameter] public EventCallback<string> OnStatusChanged { get; set; }

    private string? _svgContent;
    private System.Timers.Timer? _pollTimer;

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrEmpty(RequestUrl) && !string.IsNullOrEmpty(Nonce))
        {
            _svgContent = QrService.GenerateSvg(RequestUrl, Nonce);
        }

        if (Status == "Pending" && _pollTimer == null)
        {
            StartPolling();
        }
        else if (Status != "Pending")
        {
            StopPolling();
        }
    }

    private void StartPolling()
    {
        _pollTimer = new System.Timers.Timer(2000);
        _pollTimer.Elapsed += async (_, _) => await PollResultAsync();
        _pollTimer.AutoReset = true;
        _pollTimer.Start();
    }

    private void StopPolling()
    {
        _pollTimer?.Stop();
        _pollTimer?.Dispose();
        _pollTimer = null;
    }

    private async Task PollResultAsync()
    {
        if (string.IsNullOrEmpty(RequestId)) return;

        // The parent component should wire up actual HTTP polling.
        // This component signals via OnStatusChanged when the status changes.
        // For now, the parent is responsible for updating the Status parameter.
        await Task.CompletedTask;
    }

    public void Dispose()
    {
        StopPolling();
    }
}
