@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@using MudBlazor
@using Sorcha.UI.Core.Models.Credentials
@using Sorcha.UI.Core.Services.Credentials

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Share" />
            <MudText Typo="Typo.h6">Presentation Request</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            @* Verifier identity *@
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                <MudText Typo="Typo.body2">
                    <strong>@Request.VerifierIdentity</strong> is requesting a <strong>@Request.CredentialType</strong>
                </MudText>
            </MudAlert>

            @* Expiry countdown *@
            @if (!Request.IsExpired)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Request expires in @FormatTimeRemaining()
                </MudText>
            }
            else
            {
                <MudAlert Severity="Severity.Warning" Dense="true">This request has expired.</MudAlert>
            }

            @* Required claims *@
            @if (Request.RequestedClaims.Count > 0)
            {
                <MudText Typo="Typo.subtitle2">Requested Claims</MudText>
                <MudChipSet T="string" ReadOnly="true">
                    @foreach (var claim in Request.RequestedClaims)
                    {
                        <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined" Size="MudBlazor.Size.Small">
                            @claim
                        </MudChip>
                    }
                </MudChipSet>
            }

            @* Credential selection *@
            @if (Request.MatchingCredentials.Count > 0)
            {
                <MudText Typo="Typo.subtitle2">Select Credential</MudText>
                <MudRadioGroup T="string" Value="@_selectedCredentialId" ValueChanged="OnCredentialSelected">
                    @foreach (var cred in Request.MatchingCredentials)
                    {
                        <MudRadio T="string" Value="@cred.CredentialId" Color="Color.Primary">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2">@cred.Type</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Issuer: @(cred.IssuerDid.Length > 30 ? cred.IssuerDid[..30] + "..." : cred.IssuerDid)
                                </MudText>
                            </MudStack>
                        </MudRadio>
                    }
                </MudRadioGroup>

                @* Disclosure selection *@
                @if (_selectedCredential != null)
                {
                    <MudText Typo="Typo.subtitle2" Class="mt-2">Claims to Disclose</MudText>
                    @foreach (var claim in _selectedCredential.AvailableClaims)
                    {
                        var isRequired = Request.RequestedClaims.Contains(claim);
                        <MudCheckBox T="bool" Value="@_disclosedClaims.Contains(claim)"
                                     ValueChanged="@(v => OnClaimToggle(claim, v))"
                                     Disabled="@isRequired"
                                     Color="Color.Primary"
                                     Label="@claim" />
                    }
                }
            }
            else
            {
                <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined">
                    No matching credentials found in your wallet for this request.
                </MudAlert>
            }

            @if (_submitting)
            {
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
            }

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Dense="true">@_errorMessage</MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        @if (!Request.IsExpired && Request.MatchingCredentials.Count > 0)
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled"
                       StartIcon="@Icons.Material.Filled.Check"
                       Disabled="@(string.IsNullOrEmpty(_selectedCredentialId) || _submitting)"
                       OnClick="OnApprove">
                Approve
            </MudButton>
        }
        <MudButton Color="Color.Error" Variant="Variant.Text"
                   StartIcon="@Icons.Material.Filled.Close"
                   Disabled="@_submitting"
                   OnClick="OnDeny">
            Deny
        </MudButton>
        <MudButton Color="Color.Default" OnClick="@(() => MudDialog.Close())"
                   Disabled="@_submitting">
            Cancel
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter, EditorRequired]
    public PresentationRequestViewModel Request { get; set; } = default!;

    [Parameter]
    public EventCallback<PresentationSubmitResult> OnSubmitted { get; set; }

    [Parameter]
    public EventCallback OnDenied { get; set; }

    [Inject]
    private ICredentialApiService CredentialApi { get; set; } = default!;

    private string _selectedCredentialId = string.Empty;
    private MatchingCredentialViewModel? _selectedCredential;
    private HashSet<string> _disclosedClaims = new();
    private bool _submitting;
    private string? _errorMessage;

    protected override void OnInitialized()
    {
        // Auto-select first matching credential
        if (Request.MatchingCredentials.Count > 0)
        {
            OnCredentialSelected(Request.MatchingCredentials[0].CredentialId);
        }
    }

    private void OnCredentialSelected(string credentialId)
    {
        _selectedCredentialId = credentialId;
        _selectedCredential = Request.MatchingCredentials
            .FirstOrDefault(c => c.CredentialId == credentialId);

        // Pre-check required claims
        _disclosedClaims = new HashSet<string>(Request.RequestedClaims);
    }

    private void OnClaimToggle(string claim, bool disclosed)
    {
        if (disclosed)
            _disclosedClaims.Add(claim);
        else if (!Request.RequestedClaims.Contains(claim))
            _disclosedClaims.Remove(claim);
    }

    private async Task OnApprove()
    {
        _submitting = true;
        _errorMessage = null;
        StateHasChanged();

        var result = await CredentialApi.SubmitPresentationAsync(
            Request.RequestId,
            _selectedCredentialId,
            _disclosedClaims.ToList(),
            "placeholder-vp-token");

        _submitting = false;

        if (result.Success)
        {
            await OnSubmitted.InvokeAsync(result);
            MudDialog.Close(DialogResult.Ok(true));
        }
        else
        {
            _errorMessage = result.ErrorMessage ?? "Failed to submit presentation.";
            StateHasChanged();
        }
    }

    private async Task OnDeny()
    {
        _submitting = true;
        StateHasChanged();

        var denied = await CredentialApi.DenyPresentationAsync(Request.RequestId);

        _submitting = false;

        if (denied)
        {
            await OnDenied.InvokeAsync();
            MudDialog.Close(DialogResult.Ok(false));
        }
        else
        {
            _errorMessage = "Failed to deny request.";
            StateHasChanged();
        }
    }

    private string FormatTimeRemaining()
    {
        var remaining = Request.TimeRemaining;
        if (remaining.TotalHours >= 1) return $"{(int)remaining.TotalHours}h {remaining.Minutes}m";
        if (remaining.TotalMinutes >= 1) return $"{(int)remaining.TotalMinutes}m";
        return "less than a minute";
    }
}
