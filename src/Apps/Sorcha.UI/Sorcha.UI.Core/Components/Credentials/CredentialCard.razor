@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@using MudBlazor
@using Sorcha.UI.Core.Models.Credentials

<MudCard Elevation="2" Class="credential-card" Style="@CardStyle">
    <MudCardContent>
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
            <MudStack Spacing="0">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@GetTypeIcon()" Size="MudBlazor.Size.Small" Style="@($"color: {Credential.DisplayConfig.TextColor}")" />
                    <MudText Typo="Typo.subtitle1" Style="@($"color: {Credential.DisplayConfig.TextColor}; font-weight: 600")">
                        @Credential.Type
                    </MudText>
                </MudStack>
                <MudText Typo="Typo.caption" Style="@($"color: {Credential.DisplayConfig.TextColor}; opacity: 0.8")">
                    @Credential.IssuerName
                </MudText>
            </MudStack>
            <MudChip T="string"
                     Color="@GetStatusColor()"
                     Size="MudBlazor.Size.Small"
                     Variant="Variant.Filled">
                @GetStatusText()
            </MudChip>
        </MudStack>

        @if (Credential.HighlightClaims.Count > 0)
        {
            <MudDivider Class="my-2" Style="@($"border-color: {Credential.DisplayConfig.TextColor}; opacity: 0.3")" />
            @foreach (var claim in Credential.HighlightClaims.Take(3))
            {
                <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-1">
                    <MudText Typo="Typo.caption" Style="@($"color: {Credential.DisplayConfig.TextColor}; opacity: 0.7")">
                        @claim.Key
                    </MudText>
                    <MudText Typo="Typo.caption" Style="@($"color: {Credential.DisplayConfig.TextColor}")">
                        @claim.Value
                    </MudText>
                </MudStack>
            }
        }

        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mt-2">
            <MudText Typo="Typo.caption" Style="@($"color: {Credential.DisplayConfig.TextColor}; opacity: 0.6")">
                Issued @Credential.IssuedAt.ToString("MMM d, yyyy")
            </MudText>
            @if (Credential.IsExpiringSoon)
            {
                <MudChip T="string" Color="Color.Warning" Size="MudBlazor.Size.Small" Variant="Variant.Outlined">
                    Expires @GetExpiryText()
                </MudChip>
            }
            else if (Credential.ExpiresAt.HasValue && Credential.Status == "Active")
            {
                <MudText Typo="Typo.caption" Style="@($"color: {Credential.DisplayConfig.TextColor}; opacity: 0.6")">
                    Expires @Credential.ExpiresAt.Value.ToString("MMM d, yyyy")
                </MudText>
            }
        </MudStack>
    </MudCardContent>
    <MudCardActions>
        <MudButton Size="MudBlazor.Size.Small" Color="Color.Inherit"
                   Style="@($"color: {Credential.DisplayConfig.TextColor}")"
                   OnClick="@(() => OnViewClick.InvokeAsync(Credential))">
            View
        </MudButton>
        @if (Credential.AvailableActions.Contains("Present"))
        {
            <MudButton Size="MudBlazor.Size.Small" Color="Color.Inherit"
                       Style="@($"color: {Credential.DisplayConfig.TextColor}")"
                       OnClick="@(() => OnPresentClick.InvokeAsync(Credential))">
                Present
            </MudButton>
        }
    </MudCardActions>
</MudCard>

@code {
    [Parameter, EditorRequired]
    public CredentialCardViewModel Credential { get; set; } = default!;

    [Parameter]
    public EventCallback<CredentialCardViewModel> OnViewClick { get; set; }

    [Parameter]
    public EventCallback<CredentialCardViewModel> OnPresentClick { get; set; }

    private string CardStyle =>
        $"background-color: {Credential.DisplayConfig.BackgroundColor}; " +
        $"border-radius: 12px; " +
        (Credential.Status is "Revoked" or "Consumed" ? "opacity: 0.6; " : "") +
        (Credential.Status == "Consumed" ? "text-decoration: line-through; " : "");

    private string GetTypeIcon() => Credential.DisplayConfig.Icon switch
    {
        "Shield" => Icons.Material.Filled.Shield,
        "Badge" => Icons.Material.Filled.Badge,
        "School" => Icons.Material.Filled.School,
        "WorkspacePremium" => Icons.Material.Filled.WorkspacePremium,
        _ => Icons.Material.Filled.VerifiedUser
    };

    private Color GetStatusColor() => Credential.Status switch
    {
        "Active" => Color.Success,
        "Suspended" => Color.Warning,
        "Revoked" => Color.Error,
        "Expired" => Color.Default,
        "Consumed" => Color.Default,
        _ => Color.Default
    };

    private string GetStatusText() => Credential.Status switch
    {
        "Consumed" => "Used",
        _ => Credential.Status
    };

    private string GetExpiryText()
    {
        if (!Credential.ExpiresAt.HasValue) return "";
        var days = (Credential.ExpiresAt.Value - DateTimeOffset.UtcNow).Days;
        return days switch
        {
            <= 0 => "today",
            1 => "in 1 day",
            _ => $"in {days} days"
        };
    }
}
