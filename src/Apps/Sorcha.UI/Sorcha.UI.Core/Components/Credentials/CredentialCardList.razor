@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@using MudBlazor
@using Sorcha.UI.Core.Models.Credentials

<MudStack Spacing="3">
    @* Status filter chips *@
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
        <MudChipSet T="string" SelectionMode="SelectionMode.SingleSelection"
                    SelectedValue="@_selectedStatus"
                    SelectedValueChanged="OnStatusFilterChanged">
            <MudChip T="string" Value="@("All")" Color="Color.Default" Variant="Variant.Outlined">
                All (@Credentials.Count)
            </MudChip>
            <MudChip T="string" Value="@("Active")" Color="Color.Success" Variant="Variant.Outlined">
                Active (@Credentials.Count(c => c.Status == "Active"))
            </MudChip>
            <MudChip T="string" Value="@("Expired")" Color="Color.Default" Variant="Variant.Outlined">
                Expired (@Credentials.Count(c => c.Status == "Expired"))
            </MudChip>
            <MudChip T="string" Value="@("Revoked")" Color="Color.Error" Variant="Variant.Outlined">
                Revoked (@Credentials.Count(c => c.Status == "Revoked"))
            </MudChip>
        </MudChipSet>

        <MudSpacer />

        <MudTextField @bind-Value="_searchText" Placeholder="Search by type or issuer..."
                      Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                      Immediate="true" Variant="Variant.Outlined" Margin="Margin.Dense"
                      Class="search-field" Style="max-width: 300px" />
    </MudStack>

    @* Credential grid *@
    @if (FilteredCredentials.Any())
    {
        <MudGrid>
            @foreach (var credential in FilteredCredentials)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <CredentialCard Credential="credential"
                                    OnViewClick="OnViewClick"
                                    OnPresentClick="OnPresentClick" />
                </MudItem>
            }
        </MudGrid>
    }
    else if (Credentials.Any())
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
            No credentials match the current filter.
        </MudAlert>
    }
    else
    {
        <MudPaper Elevation="0" Class="pa-8 d-flex flex-column align-center justify-center" Style="min-height: 200px">
            <MudIcon Icon="@Icons.Material.Filled.Badge" Size="MudBlazor.Size.Large" Color="Color.Default" Class="mb-4" />
            <MudText Typo="Typo.h6" Color="Color.Secondary">No Credentials Yet</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-1">
                Credentials will appear here when issued through workflow actions.
            </MudText>
        </MudPaper>
    }
</MudStack>

@code {
    [Parameter]
    public List<CredentialCardViewModel> Credentials { get; set; } = new();

    [Parameter]
    public EventCallback<CredentialCardViewModel> OnViewClick { get; set; }

    [Parameter]
    public EventCallback<CredentialCardViewModel> OnPresentClick { get; set; }

    private string _selectedStatus = "All";
    private string _searchText = string.Empty;

    private IEnumerable<CredentialCardViewModel> FilteredCredentials
    {
        get
        {
            var filtered = Credentials.AsEnumerable();

            if (_selectedStatus != "All")
                filtered = filtered.Where(c => c.Status == _selectedStatus);

            if (!string.IsNullOrWhiteSpace(_searchText))
            {
                var search = _searchText.Trim();
                filtered = filtered.Where(c =>
                    c.Type.Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    c.IssuerName.Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    c.IssuerDid.Contains(search, StringComparison.OrdinalIgnoreCase));
            }

            return filtered.OrderByDescending(c => c.IssuedAt);
        }
    }

    private void OnStatusFilterChanged(string value)
    {
        _selectedStatus = value ?? "All";
    }
}
