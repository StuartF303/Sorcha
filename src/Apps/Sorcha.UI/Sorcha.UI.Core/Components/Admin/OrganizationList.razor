@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@using Sorcha.UI.Core.Services
@inject IOrganizationAdminService OrganizationService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudStack Spacing="4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" />
            Organizations
        </MudText>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="OpenCreateDialogAsync">
            Create Organization
        </MudButton>
    </MudStack>

    @if (_error != null)
    {
        <MudAlert Severity="Severity.Error">@_error</MudAlert>
    }

    <MudDataGrid T="OrganizationDto"
                 Items="_organizations"
                 Loading="_isLoading"
                 Dense="true"
                 Hover="true"
                 Striped="true"
                 Class="organization-list"
                 data-testid="organization-list">
        <Columns>
            <TemplateColumn Title="ID" CellStyle="width: 160px">
                <CellTemplate>
                    <TruncatedId Value="@context.Item.Id.ToString()" />
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => x.Name" Title="Name" />
            <PropertyColumn Property="x => x.Subdomain" Title="Subdomain" />
            <TemplateColumn Title="Status">
                <CellTemplate>
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Item.Status)">
                        @context.Item.Status
                    </MudChip>
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => x.CreatedAt" Title="Created" Format="yyyy-MM-dd" />
            <TemplateColumn Title="Actions" CellStyle="width: 150px">
                <CellTemplate>
                    <MudStack Row="true" Spacing="1">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Size="Size.Small"
                                       OnClick="() => OpenEditDialogAsync(context.Item)"
                                       aria-label="Edit" />
                        <MudIconButton Icon="@Icons.Material.Filled.People"
                                       Size="Size.Small"
                                       OnClick="() => NavigateToUsers(context.Item)"
                                       aria-label="Manage Users" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Size="Size.Small"
                                       Color="Color.Error"
                                       OnClick="() => ConfirmDeactivateAsync(context.Item)"
                                       Disabled="@(context.Item.Status == "Deleted")"
                                       aria-label="Deactivate" />
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <NoRecordsContent>
            <MudText>No organizations found.</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudProgressCircular Indeterminate="true" />
        </LoadingContent>
        <PagerContent>
            <MudDataGridPager T="OrganizationDto" data-testid="pagination" />
        </PagerContent>
    </MudDataGrid>

    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
        <MudCheckBox T="bool" @bind-Value="_includeInactive" Label="Show inactive organizations" />
        <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                       OnClick="LoadOrganizationsAsync"
                       Disabled="_isLoading" />
    </MudStack>
</MudStack>

@code {
    [Parameter]
    public EventCallback<OrganizationDto> OnOrganizationSelected { get; set; }

    private List<OrganizationDto> _organizations = [];
    private bool _isLoading = true;
    private bool _includeInactive;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganizationsAsync();
    }

    private async Task LoadOrganizationsAsync()
    {
        _isLoading = true;
        _error = null;

        try
        {
            var result = await OrganizationService.ListOrganizationsAsync(_includeInactive);
            _organizations = result.Organizations.ToList();
        }
        catch (Exception ex)
        {
            _error = $"Failed to load organizations: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OpenCreateDialogAsync()
    {
        var parameters = new DialogParameters<OrganizationForm>
        {
            { x => x.IsEdit, false }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<OrganizationForm>("Create Organization", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: OrganizationDto newOrg })
        {
            _organizations.Insert(0, newOrg);
            Snackbar.Add($"Organization '{newOrg.Name}' created successfully.", Severity.Success);
            StateHasChanged();
        }
    }

    private async Task OpenEditDialogAsync(OrganizationDto organization)
    {
        var parameters = new DialogParameters<OrganizationForm>
        {
            { x => x.IsEdit, true },
            { x => x.Organization, organization }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<OrganizationForm>("Edit Organization", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: OrganizationDto updatedOrg })
        {
            var index = _organizations.FindIndex(o => o.Id == updatedOrg.Id);
            if (index >= 0)
            {
                _organizations[index] = updatedOrg;
            }
            Snackbar.Add($"Organization '{updatedOrg.Name}' updated successfully.", Severity.Success);
            StateHasChanged();
        }
    }

    private async Task ConfirmDeactivateAsync(OrganizationDto organization)
    {
        var result = await DialogService.ShowMessageBox(
            "Confirm Deactivation",
            $"Are you sure you want to deactivate '{organization.Name}'? This action can be reversed by an administrator.",
            yesText: "Deactivate",
            cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                var success = await OrganizationService.DeactivateOrganizationAsync(organization.Id);
                if (success)
                {
                    var index = _organizations.FindIndex(o => o.Id == organization.Id);
                    if (index >= 0)
                    {
                        _organizations[index] = organization with { Status = "Deleted" };
                    }
                    Snackbar.Add($"Organization '{organization.Name}' deactivated.", Severity.Warning);
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to deactivate: {ex.Message}", Severity.Error);
            }
        }
    }

    private void NavigateToUsers(OrganizationDto organization)
    {
        OnOrganizationSelected.InvokeAsync(organization);
    }

    private static Color GetStatusColor(string status) => status switch
    {
        "Active" => Color.Success,
        "Suspended" => Color.Warning,
        "Deleted" => Color.Error,
        _ => Color.Default
    };
}
