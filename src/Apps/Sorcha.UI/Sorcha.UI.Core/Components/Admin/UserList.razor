@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2025 Sorcha Contributors *@

@using Sorcha.UI.Core.Services
@inject IOrganizationAdminService OrganizationService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudStack Spacing="4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                           OnClick="@(() => OnBackToOrganizations.InvokeAsync())"
                           aria-label="Back" />
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" />
                Users - @Organization?.Name
            </MudText>
        </MudStack>
        @if (!IsReadOnly)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.PersonAdd"
                       OnClick="OpenAddUserDialogAsync">
                Add User
            </MudButton>
        }
    </MudStack>

    @if (_error != null)
    {
        <MudAlert Severity="Severity.Error">@_error</MudAlert>
    }

    <MudDataGrid T="UserDto"
                 Items="_users"
                 Loading="_isLoading"
                 Dense="true"
                 Hover="true"
                 Striped="true"
                 Class="user-list"
                 data-testid="user-list">
        <Columns>
            <PropertyColumn Property="x => x.DisplayName" Title="Name" />
            <PropertyColumn Property="x => x.Email" Title="Email" />
            <TemplateColumn Title="Roles">
                <CellTemplate>
                    <MudStack Row="true" Spacing="1">
                        @foreach (var role in context.Item.Roles)
                        {
                            <MudChip T="string" Size="Size.Small" Color="@GetRoleColor(role)">
                                @role
                            </MudChip>
                        }
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Status">
                <CellTemplate>
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Item.Status)">
                        @context.Item.Status
                    </MudChip>
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => x.LastLoginAt" Title="Last Login" Format="yyyy-MM-dd HH:mm" />
            <TemplateColumn Title="Actions" CellStyle="width: 120px">
                <CellTemplate>
                    <MudStack Row="true" Spacing="1">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Size="Size.Small"
                                       OnClick="() => OpenEditUserDialogAsync(context.Item)"
                                       Disabled="@IsReadOnly"
                                       aria-label="Edit" />
                        <MudIconButton Icon="@Icons.Material.Filled.PersonRemove"
                                       Size="Size.Small"
                                       Color="Color.Error"
                                       OnClick="() => ConfirmRemoveUserAsync(context.Item)"
                                       Disabled="@(IsReadOnly || IsCurrentUser(context.Item) || context.Item.Status == "Removed")"
                                       aria-label="Remove" />
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <NoRecordsContent>
            <MudText>No users found in this organization.</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudProgressCircular Indeterminate="true" />
        </LoadingContent>
        <PagerContent>
            <MudDataGridPager T="UserDto" data-testid="pagination" />
        </PagerContent>
    </MudDataGrid>

    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
        <MudCheckBox T="bool" @bind-Value="_includeInactive" Label="Show inactive users" />
        <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                       OnClick="LoadUsersAsync"
                       Disabled="_isLoading" />
    </MudStack>
</MudStack>

@code {
    [Parameter]
    public OrganizationDto? Organization { get; set; }

    [Parameter]
    public bool IsReadOnly { get; set; }

    [Parameter]
    public Guid? CurrentUserId { get; set; }

    [Parameter]
    public EventCallback OnBackToOrganizations { get; set; }

    private List<UserDto> _users = [];
    private bool _isLoading = true;
    private bool _includeInactive;
    private string? _error;

    protected override async Task OnParametersSetAsync()
    {
        if (Organization != null)
        {
            await LoadUsersAsync();
        }
    }

    private async Task LoadUsersAsync()
    {
        if (Organization == null)
        {
            return;
        }

        _isLoading = true;
        _error = null;

        try
        {
            var result = await OrganizationService.GetOrganizationUsersAsync(
                Organization.Id, _includeInactive);
            _users = result.Users.ToList();
        }
        catch (Exception ex)
        {
            _error = $"Failed to load users: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OpenAddUserDialogAsync()
    {
        if (Organization == null)
        {
            return;
        }

        var parameters = new DialogParameters<UserForm>
        {
            { x => x.IsEdit, false },
            { x => x.OrganizationId, Organization.Id }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<UserForm>("Add User", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: UserDto newUser })
        {
            _users.Insert(0, newUser);
            Snackbar.Add($"User '{newUser.DisplayName}' added successfully.", Severity.Success);
            StateHasChanged();
        }
    }

    private async Task OpenEditUserDialogAsync(UserDto user)
    {
        if (Organization == null)
        {
            return;
        }

        var parameters = new DialogParameters<UserForm>
        {
            { x => x.IsEdit, true },
            { x => x.OrganizationId, Organization.Id },
            { x => x.User, user }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseOnEscapeKey = true
        };

        var dialog = await DialogService.ShowAsync<UserForm>("Edit User", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: UserDto updatedUser })
        {
            var index = _users.FindIndex(u => u.Id == updatedUser.Id);
            if (index >= 0)
            {
                _users[index] = updatedUser;
            }
            Snackbar.Add($"User '{updatedUser.DisplayName}' updated successfully.", Severity.Success);
            StateHasChanged();
        }
    }

    private async Task ConfirmRemoveUserAsync(UserDto user)
    {
        if (Organization == null)
        {
            return;
        }

        if (IsCurrentUser(user))
        {
            Snackbar.Add("You cannot remove yourself from the organization.", Severity.Error);
            return;
        }

        var result = await DialogService.ShowMessageBox(
            "Confirm Removal",
            $"Are you sure you want to remove '{user.DisplayName}' from this organization? They will lose access to all organization resources.",
            yesText: "Remove",
            cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                var success = await OrganizationService.RemoveUserFromOrganizationAsync(
                    Organization.Id, user.Id);

                if (success)
                {
                    var index = _users.FindIndex(u => u.Id == user.Id);
                    if (index >= 0)
                    {
                        _users[index] = user with { Status = "Removed" };
                    }
                    Snackbar.Add($"User '{user.DisplayName}' removed from organization.", Severity.Warning);
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to remove user: {ex.Message}", Severity.Error);
            }
        }
    }

    private bool IsCurrentUser(UserDto user)
    {
        return CurrentUserId.HasValue && user.Id == CurrentUserId.Value;
    }

    private static Color GetRoleColor(string role) => role switch
    {
        "Administrator" => Color.Primary,
        "Designer" => Color.Secondary,
        "Member" => Color.Default,
        _ => Color.Default
    };

    private static Color GetStatusColor(string status) => status switch
    {
        "Active" => Color.Success,
        "Suspended" => Color.Warning,
        "Removed" => Color.Error,
        _ => Color.Default
    };
}
