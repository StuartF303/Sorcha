@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2025 Sorcha Contributors *@

@using Sorcha.UI.Core.Models.Admin
@using Sorcha.UI.Core.Services
@inject IHealthCheckService HealthService
@inject IOrganizationAdminService OrganizationService
@inject IAlertService AlertService
@inject ISnackbar Snackbar
@implements IDisposable

<MudStack Spacing="4">
    @* Refresh Button *@
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.HealthAndSafety" Class="mr-2" />
            Service Health Monitor
        </MudText>
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            @if (_isLoading)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
            }
            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           OnClick="RefreshHealthStatusAsync"
                           Disabled="_isLoading"
                           Size="Size.Small"
                           Color="Color.Primary"
                           aria-label="Refresh" />
        </MudStack>
    </MudStack>

    @* KPI Summary Panel *@
    @if (_kpis != null)
    {
        <KpiSummaryPanel Kpis="_kpis" ActiveAlertCount="_activeAlertCount" />
    }
    else
    {
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="150px" />
    }

    @* Alerts Panel *@
    <AlertsPanel Alerts="_alerts" OnRefresh="RefreshAlertsAsync" />

    @* Service Health Cards Grid *@
    @if (_error != null)
    {
        <MudAlert Severity="Severity.Error" Class="mt-4">
            @_error
        </MudAlert>
    }
    else if (HealthService.ServiceStatuses.Count == 0 && _isLoading)
    {
        <MudGrid>
            @for (var i = 0; i < 7; i++)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" />
                </MudItem>
            }
        </MudGrid>
    }
    else
    {
        <MudGrid>
            @foreach (var serviceStatus in HealthService.ServiceStatuses)
            {
                <MudItem xs="12" sm="6" md="4">
                    <ServiceHealthCard Status="serviceStatus"
                                       ServiceAlerts="GetAlertsForService(serviceStatus.ServiceKey)" />
                </MudItem>
            }
        </MudGrid>
    }

    @* Polling Status *@
    @if (_pollingActive)
    {
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-center">
            <MudIcon Icon="@Icons.Material.Filled.Loop" Size="Size.Small" Class="mr-1" />
            Auto-refresh every 30 seconds
        </MudText>
    }
</MudStack>

@code {
    private PlatformKpis? _kpis;
    private bool _isLoading = true;
    private bool _pollingActive;
    private string? _error;
    private IReadOnlyList<ServiceAlert>? _alerts;
    private int _activeAlertCount;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to health status changes
        HealthService.HealthStatusChanged += OnHealthStatusChanged;

        // Load initial data
        await LoadInitialDataAsync();

        // Start health polling
        await StartPollingAsync();
    }

    private async Task LoadInitialDataAsync()
    {
        _isLoading = true;
        _error = null;

        try
        {
            // Load platform KPIs and alerts in parallel
            var kpiTask = OrganizationService.GetPlatformStatsAsync();
            var alertTask = AlertService.GetAlertsAsync();

            await Task.WhenAll(kpiTask, alertTask);

            _kpis = kpiTask.Result;
            var alertsResponse = alertTask.Result;
            _alerts = alertsResponse.Alerts;
            _activeAlertCount = alertsResponse.TotalCount;

            // Update KPIs with health service data
            UpdateKpisFromHealthService();

            // Subscribe to alert changes for snackbar notifications
            AlertService.AlertsChanged += OnAlertsChanged;
        }
        catch (Exception ex)
        {
            _error = $"Failed to load dashboard data: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task StartPollingAsync()
    {
        try
        {
            await HealthService.StartAsync();
            _pollingActive = true;
        }
        catch (Exception ex)
        {
            _error = $"Failed to start health monitoring: {ex.Message}";
        }
    }

    private async Task RefreshHealthStatusAsync()
    {
        _isLoading = true;
        _error = null;
        StateHasChanged();

        try
        {
            var healthTask = HealthService.RefreshAsync();
            var kpiTask = OrganizationService.GetPlatformStatsAsync();
            var alertTask = AlertService.GetAlertsAsync();

            await Task.WhenAll(healthTask, kpiTask, alertTask);

            _kpis = kpiTask.Result;
            var alertsResponse = alertTask.Result;
            _alerts = alertsResponse.Alerts;
            _activeAlertCount = alertsResponse.TotalCount;
            UpdateKpisFromHealthService();
        }
        catch (Exception ex)
        {
            _error = $"Failed to refresh health status: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void OnHealthStatusChanged(object? sender, HealthStatusChangedEventArgs e)
    {
        InvokeAsync(() =>
        {
            UpdateKpisFromHealthService();
            StateHasChanged();
        });
    }

    private void UpdateKpisFromHealthService()
    {
        if (_kpis == null) return;

        var healthyCount = HealthService.ServiceStatuses
            .Count(s => s.Status == HealthStatus.Healthy);

        var totalCount = HealthService.ServiceStatuses.Count;

        _kpis = _kpis with
        {
            HealthyServices = healthyCount,
            TotalServices = totalCount,
            LastUpdated = DateTimeOffset.UtcNow
        };
    }

    private async Task RefreshAlertsAsync()
    {
        var alertsResponse = await AlertService.GetAlertsAsync();
        _alerts = alertsResponse.Alerts;
        _activeAlertCount = alertsResponse.TotalCount;
        StateHasChanged();
    }

    private void OnAlertsChanged(object? sender, AlertsChangedEventArgs e)
    {
        InvokeAsync(() =>
        {
            foreach (var alert in e.NewAlerts)
            {
                if (alert.Severity >= AlertSeverity.Warning)
                {
                    var severity = alert.Severity switch
                    {
                        AlertSeverity.Critical => MudBlazor.Severity.Error,
                        AlertSeverity.Error => MudBlazor.Severity.Error,
                        AlertSeverity.Warning => MudBlazor.Severity.Warning,
                        _ => MudBlazor.Severity.Info
                    };
                    Snackbar.Add($"{alert.Source}: {alert.Message}", severity);
                }
            }
            StateHasChanged();
        });
    }

    private IReadOnlyList<ServiceAlert>? GetAlertsForService(string serviceKey)
    {
        if (_alerts == null || _alerts.Count == 0)
            return null;

        var filtered = _alerts.Where(a => string.Equals(a.Source, serviceKey, StringComparison.OrdinalIgnoreCase)).ToList();
        return filtered.Count > 0 ? filtered : null;
    }

    public void Dispose()
    {
        HealthService.HealthStatusChanged -= OnHealthStatusChanged;
        AlertService.AlertsChanged -= OnAlertsChanged;
        _ = HealthService.StopAsync();
    }
}
