@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@using System.Net.Http.Json
@using System.Text.Json
@using Sorcha.UI.Core.Models.Participants
@using Sorcha.UI.Core.Models.Registers
@using Sorcha.UI.Core.Services
@using Sorcha.UI.Core.Services.Participants

@inject IRegisterService RegisterService
@inject IParticipantPublishingService PublishingService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudStack Spacing="3" Class="mt-2">
    @if (_loading)
    {
        <MudProgressCircular Indeterminate="true" />
        <MudText>Loading published participants...</MudText>
    }
    else if (_published.Count == 0)
    {
        <MudAlert Severity="Severity.Info">
            No participants have been published to any register yet.
            Use the Participants tab to publish participant identities.
        </MudAlert>
    }
    else
    {
        <MudDataGrid T="PublishedParticipantViewModel" Items="_published" Dense="true" Hover="true">
            <Columns>
                <PropertyColumn Property="x => x.ParticipantName" Title="Participant" />
                <PropertyColumn Property="x => x.RegisterName" Title="Register" />
                <TemplateColumn Title="Status">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small" Color="@GetPublishStatusColor(context.Item.Status)">
                            @context.Item.Status
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.Version" Title="Version" />
                <PropertyColumn Property="x => x.AddressCount" Title="Addresses" />
                <TemplateColumn Title="TX ID">
                    <CellTemplate>
                        <code>@TruncateTxId(context.Item.LatestTxId)</code>
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.PublishedAt" Title="Published" Format="yyyy-MM-dd HH:mm" />
                <TemplateColumn Title="Actions" CellStyle="width: 100px">
                    <CellTemplate>
                        @if (context.Item.Status != "Revoked")
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                           Color="Color.Error"
                                           OnClick="@(() => ConfirmRevokeAsync(context.Item))"
                                           title="Revoke" />
                        }
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <NoRecordsContent>
                <MudText>No published participants found.</MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudDataGridPager T="PublishedParticipantViewModel" />
            </PagerContent>
        </MudDataGrid>
    }

    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
        <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                       OnClick="LoadPublishedParticipantsAsync"
                       Disabled="_loading" title="Refresh" />
    </MudStack>
</MudStack>

@code {
    [Parameter, EditorRequired]
    public Guid OrganizationId { get; set; }

    [Inject] private HttpClient HttpClient { get; set; } = default!;

    private List<PublishedParticipantViewModel> _published = [];
    private bool _loading = true;

    protected override async Task OnParametersSetAsync()
    {
        await LoadPublishedParticipantsAsync();
    }

    private async Task LoadPublishedParticipantsAsync()
    {
        _loading = true;
        _published = [];

        try
        {
            // First get registers for this tenant/org
            var registers = await RegisterService.GetRegistersAsync(OrganizationId.ToString());

            // Then query published participants on each register
            foreach (var register in registers)
            {
                try
                {
                    var url = $"/api/registers/{Uri.EscapeDataString(register.Id)}/participants?status=Active";
                    var response = await HttpClient.GetAsync(url);

                    if (response.IsSuccessStatusCode)
                    {
                        var page = await response.Content.ReadFromJsonAsync<ParticipantPageResponse>();
                        if (page?.Participants != null)
                        {
                            foreach (var p in page.Participants)
                            {
                                _published.Add(new PublishedParticipantViewModel
                                {
                                    ParticipantId = p.ParticipantId,
                                    ParticipantName = p.ParticipantName,
                                    OrganizationName = p.OrganizationName,
                                    RegisterId = register.Id,
                                    RegisterName = register.Name,
                                    Status = p.Status,
                                    Version = p.Version,
                                    LatestTxId = p.LatestTxId,
                                    AddressCount = p.Addresses?.Count ?? 0,
                                    PublishedAt = p.PublishedAt
                                });
                            }
                        }
                    }
                }
                catch
                {
                    // Skip registers that fail to load
                }
            }
        }
        catch
        {
            // Failed to load registers
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ConfirmRevokeAsync(PublishedParticipantViewModel item)
    {
        var result = await DialogService.ShowMessageBox(
            "Confirm Revocation",
            $"Are you sure you want to revoke the published record for '{item.ParticipantName}' on register '{item.RegisterName}'? This action cannot be undone.",
            yesText: "Revoke",
            cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                if (Guid.TryParse(item.ParticipantId, out var participantGuid))
                {
                    var success = await PublishingService.RevokeAsync(OrganizationId, participantGuid);
                    if (success)
                    {
                        Snackbar.Add($"Published record for '{item.ParticipantName}' revoked.", Severity.Success);
                        await LoadPublishedParticipantsAsync();
                    }
                    else
                    {
                        Snackbar.Add("Failed to revoke published record", Severity.Error);
                    }
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error revoking record: {ex.Message}", Severity.Error);
            }
        }
    }

    private static Color GetPublishStatusColor(string status) => status switch
    {
        "Active" => Color.Success,
        "Revoked" => Color.Error,
        "Superseded" => Color.Warning,
        _ => Color.Default
    };

    private static string TruncateTxId(string txId)
    {
        if (string.IsNullOrEmpty(txId) || txId.Length <= 16) return txId;
        return $"{txId[..8]}...{txId[^4..]}";
    }

    /// <summary>
    /// Response model matching the Register Service participant page endpoint.
    /// </summary>
    private class ParticipantPageResponse
    {
        public int Page { get; set; }
        public int PageSize { get; set; }
        public int Total { get; set; }
        public List<ParticipantRecordResponse>? Participants { get; set; }
    }

    private class ParticipantRecordResponse
    {
        public string ParticipantId { get; set; } = string.Empty;
        public string OrganizationName { get; set; } = string.Empty;
        public string ParticipantName { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public int Version { get; set; }
        public string LatestTxId { get; set; } = string.Empty;
        public List<AddressInfoResponse>? Addresses { get; set; }
        public DateTimeOffset PublishedAt { get; set; }
    }

    private class AddressInfoResponse
    {
        public string WalletAddress { get; set; } = string.Empty;
        public string PublicKey { get; set; } = string.Empty;
        public string Algorithm { get; set; } = string.Empty;
        public bool Primary { get; set; }
    }
}
