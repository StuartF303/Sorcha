@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@using Sorcha.UI.Core.Models.Explorer
@using Sorcha.UI.Core.Models.Common
@using Sorcha.UI.Core.Models.Registers
@using Sorcha.UI.Core.Components.Shared
@using Sorcha.UI.Core.Services

@inject IODataQueryService ODataService

<MudPaper Elevation="2" Class="pa-4">
    <MudText Typo="Typo.h6" Class="mb-3">
        <MudIcon Icon="@Icons.Material.Filled.FilterList" Class="mr-2" />
        Query Builder
    </MudText>

    @* Filter rows *@
    @for (var i = 0; i < _query.Filters.Count; i++)
    {
        var index = i;
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-2">
            @if (index > 0)
            {
                <MudSelect T="string" @bind-Value="_query.Filters[index].LogicalOperator"
                           Variant="Variant.Outlined" Margin="Margin.Dense" Style="max-width: 80px;">
                    <MudSelectItem Value="@("and")">AND</MudSelectItem>
                    <MudSelectItem Value="@("or")">OR</MudSelectItem>
                </MudSelect>
            }
            else
            {
                <div style="min-width: 80px;"></div>
            }

            <MudSelect T="string" @bind-Value="_query.Filters[index].Field"
                       Label="Field" Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width: 180px;">
                @foreach (var field in _availableFields)
                {
                    <MudSelectItem Value="@field">@field</MudSelectItem>
                }
            </MudSelect>

            <MudSelect T="string" @bind-Value="_query.Filters[index].Operator"
                       Label="Operator" Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width: 140px;">
                <MudSelectItem Value="@("eq")">equals</MudSelectItem>
                <MudSelectItem Value="@("ne")">not equals</MudSelectItem>
                <MudSelectItem Value="@("gt")">greater than</MudSelectItem>
                <MudSelectItem Value="@("lt")">less than</MudSelectItem>
                <MudSelectItem Value="@("ge")">greater or equal</MudSelectItem>
                <MudSelectItem Value="@("le")">less or equal</MudSelectItem>
                <MudSelectItem Value="@("contains")">contains</MudSelectItem>
                <MudSelectItem Value="@("startswith")">starts with</MudSelectItem>
            </MudSelect>

            <MudTextField T="string" @bind-Value="_query.Filters[index].Value"
                          Label="Value" Variant="Variant.Outlined" Margin="Margin.Dense" />

            <MudIconButton Icon="@Icons.Material.Filled.RemoveCircle" Color="Color.Error" Size="Size.Small"
                           OnClick="() => RemoveFilter(index)" />
        </MudStack>
    }

    <MudButton StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary" Variant="Variant.Text"
               Size="Size.Small" OnClick="AddFilter" Class="mb-3">
        Add Filter
    </MudButton>

    @* Sort options *@
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-3">
        <MudSelect T="string" @bind-Value="_query.OrderBy" Label="Order By"
                   Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width: 180px;">
            <MudSelectItem Value="@("")">None</MudSelectItem>
            @foreach (var field in _availableFields)
            {
                <MudSelectItem Value="@field">@field</MudSelectItem>
            }
        </MudSelect>
        <MudSelect T="string" @bind-Value="_query.OrderDirection" Label="Direction"
                   Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width: 120px;">
            <MudSelectItem Value="@("asc")">Ascending</MudSelectItem>
            <MudSelectItem Value="@("desc")">Descending</MudSelectItem>
        </MudSelect>
        <MudNumericField T="int" @bind-Value="_query.Top" Label="Page Size"
                         Variant="Variant.Outlined" Margin="Margin.Dense" Min="1" Max="100" Style="max-width: 120px;" />
    </MudStack>

    @* Query preview *@
    @if (_query.Filters.Count > 0)
    {
        <MudPaper Elevation="0" Class="pa-2 mb-3" Style="background-color: var(--mud-palette-background-grey);">
            <MudText Typo="Typo.caption" Color="Color.Secondary">OData Query Preview:</MudText>
            <MudText Typo="Typo.body2" Style="font-family: monospace; word-break: break-all;">
                $filter=@ODataService.BuildFilterString(_query)
            </MudText>
        </MudPaper>
    }

    @* Execute *@
    <MudStack Row="true" Spacing="2">
        <MudButton Color="Color.Primary" Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.Search"
                   OnClick="ExecuteQuery" Disabled="@_executing">
            @if (_executing)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Execute Query
        </MudButton>
        <MudButton Color="Color.Default" Variant="Variant.Outlined"
                   OnClick="ClearQuery">Clear</MudButton>
    </MudStack>
</MudPaper>

@* Results *@
@if (_results != null)
{
    <MudPaper Elevation="2" Class="pa-4 mt-4">
        <MudText Typo="Typo.h6" Class="mb-3">
            Results (@_results.TotalCount total)
        </MudText>
        <MudTable Items="@_results.Items" Hover="true" Striped="true" Dense="true">
            <HeaderContent>
                <MudTh>Transaction ID</MudTh>
                <MudTh>Register</MudTh>
                <MudTh>Sender</MudTh>
                <MudTh>Timestamp</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd><TruncatedId Value="@context.TxId" /></MudTd>
                <MudTd><TruncatedId Value="@context.RegisterId" /></MudTd>
                <MudTd><TruncatedId Value="@context.SenderWallet" /></MudTd>
                <MudTd>@context.TimeStamp.ToString("MMM dd, yyyy HH:mm")</MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 10, 20, 50 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>
}

@code {
    [Parameter]
    public EventCallback<ODataQueryModel> OnExecute { get; set; }

    private ODataQueryModel _query = new();
    private PaginatedList<TransactionViewModel>? _results;
    private bool _executing;

    private readonly List<string> _availableFields =
    [
        "TxId", "RegisterId", "SenderWallet", "TimeStamp", "DocketNumber",
        "Version", "BlueprintId", "InstanceId", "ActionId"
    ];

    private void AddFilter()
    {
        _query.Filters.Add(new ODataFilterRow
        {
            Field = _availableFields.First(),
            Operator = "eq",
            Value = "",
            LogicalOperator = "and"
        });
    }

    private void RemoveFilter(int index)
    {
        _query.Filters.RemoveAt(index);
    }

    private async Task ExecuteQuery()
    {
        _executing = true;

        try
        {
            _results = await ODataService.ExecuteTransactionQueryAsync(_query);
            await OnExecute.InvokeAsync(_query);
        }
        catch
        {
            _results = new PaginatedList<TransactionViewModel>();
        }
        finally
        {
            _executing = false;
        }
    }

    private void ClearQuery()
    {
        _query = new ODataQueryModel();
        _results = null;
    }
}
