@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@using Sorcha.UI.Core.Models.Explorer
@using Sorcha.UI.Core.Components.Shared
@using Sorcha.UI.Core.Services

@inject IDocketService DocketService

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Class="mb-4" />
}
else if (_error)
{
    <ServiceUnavailable ServiceName="Docket Service" Message="Unable to load docket chain." OnRetry="LoadDocketsAsync" />
}
else if (_dockets.Count == 0)
{
    <EmptyState Icon="@Icons.Material.Filled.LinkOff"
                Title="No Dockets"
                Description="This register has no dockets yet." />
}
else
{
    <MudTimeline TimelinePosition="TimelinePosition.Start">
        @foreach (var docket in _dockets.OrderByDescending(d => d.Version))
        {
            <MudTimelineItem Color="@(docket.IsIntegrityValid ? Color.Primary : Color.Error)" Size="Size.Small"
                             Variant="Variant.Filled">
                <ItemContent>
                    <MudCard Elevation="0" Outlined="true" Class="@($"mb-2 {(_selectedDocketId == docket.DocketId ? "mud-border-primary" : "")}")"
                             @onclick="() => SelectDocket(docket)">
                        <MudCardContent Class="pa-3" Style="cursor: pointer">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.subtitle2">Docket #@docket.Version</MudText>
                                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                    <MudChip T="string" Size="Size.Small"
                                             Color="@(docket.IsIntegrityValid ? Color.Success : Color.Error)"
                                             Icon="@(docket.IsIntegrityValid ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)">
                                        @(docket.IsIntegrityValid ? "Valid" : "Invalid")
                                    </MudChip>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @docket.TransactionCount txs
                                    </MudText>
                                </MudStack>
                            </MudStack>
                            <MudStack Spacing="1" Class="mt-2">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Hash:
                                </MudText>
                                <MudText Typo="Typo.caption" Class="monospace-text" Style="word-break: break-all;">
                                    @docket.Hash
                                </MudText>
                                @if (!string.IsNullOrEmpty(docket.PreviousHash))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        Previous Hash:
                                    </MudText>
                                    <MudText Typo="Typo.caption" Class="monospace-text" Style="word-break: break-all;">
                                        @docket.PreviousHash
                                    </MudText>
                                }
                                else
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        Genesis docket
                                    </MudText>
                                }
                            </MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                                @docket.CreatedAt.ToString("MMM dd, yyyy HH:mm")
                            </MudText>
                        </MudCardContent>
                    </MudCard>
                </ItemContent>
            </MudTimelineItem>
        }
    </MudTimeline>

    @if (_selectedDocket != null)
    {
        <DocketDetail Docket="_selectedDocket" RegisterId="@RegisterId" />
    }
}

@code {
    [Parameter]
    public string RegisterId { get; set; } = "";

    private List<DocketViewModel> _dockets = [];
    private DocketViewModel? _selectedDocket;
    private string? _selectedDocketId;
    private bool _loading = true;
    private bool _error;

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(RegisterId))
        {
            await LoadDocketsAsync();
        }
    }

    public async Task RefreshAsync()
    {
        await LoadDocketsAsync();
        StateHasChanged();
    }

    private async Task LoadDocketsAsync()
    {
        _loading = true;
        _error = false;

        try
        {
            _dockets = await DocketService.GetDocketsAsync(RegisterId);
        }
        catch
        {
            _error = true;
        }
        finally
        {
            _loading = false;
        }
    }

    private void SelectDocket(DocketViewModel docket)
    {
        if (_selectedDocketId == docket.DocketId)
        {
            _selectedDocket = null;
            _selectedDocketId = null;
        }
        else
        {
            _selectedDocket = docket;
            _selectedDocketId = docket.DocketId;
        }
    }
}

<style>
    .monospace-text {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.8rem;
    }
</style>
