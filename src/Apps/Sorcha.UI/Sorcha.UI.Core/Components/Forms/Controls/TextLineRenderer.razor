@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@using Sorcha.Blueprint.Models
@using Sorcha.UI.Core.Models.Forms
@using Sorcha.UI.Core.Services.Forms

@inject IFormSchemaService SchemaService

<MudTextField T="string"
              Label="@Control.Title"
              Value="@_value"
              ValueChanged="OnValueChanged"
              Disabled="@(IsDisabled || FormContext?.IsReadOnly == true)"
              Required="@_isRequired"
              ErrorText="@_errorText"
              Error="@(!string.IsNullOrEmpty(_errorText))"
              Immediate="false"
              Variant="Variant.Outlined"
              Margin="Margin.Dense"
              DebounceInterval="300"
              OnBlur="OnBlur" />

@code {
    [CascadingParameter] public FormContext? FormContext { get; set; }
    [Parameter, EditorRequired] public Control Control { get; set; } = new();
    [Parameter] public bool IsDisabled { get; set; }

    private string _value = string.Empty;
    private string _errorText = string.Empty;
    private bool _isRequired;

    protected override void OnParametersSet()
    {
        _value = FormContext?.GetValue<string>(Control.Scope) ?? string.Empty;
        _isRequired = SchemaService.IsRequired(FormContext?.DataSchema, Control.Scope);
        UpdateErrors();
    }

    private void OnValueChanged(string newValue)
    {
        _value = newValue;
        FormContext?.SetValue(Control.Scope, newValue);
    }

    private void OnBlur()
    {
        if (FormContext is null) return;
        var errors = SchemaService.ValidateField(FormContext.DataSchema, Control.Scope, _value);
        FormContext.SetErrors(Control.Scope, errors);
        UpdateErrors();
    }

    private void UpdateErrors()
    {
        var errors = FormContext?.GetErrors(Control.Scope) ?? [];
        _errorText = errors.Count > 0 ? string.Join("; ", errors) : string.Empty;
    }
}
