@* SPDX-License-Identifier: MIT *@
@* Copyright (c) 2026 Sorcha Contributors *@

@using System.Text.Json
@using Sorcha.Blueprint.Models
@using Sorcha.UI.Core.Models.Forms
@using Sorcha.UI.Core.Models.Workflows

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.subtitle1">@Action.ActionName</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">@Action.Description</MudText>

            <SorchaFormRenderer Action="_blueprintAction"
                                     ParticipantAddress="@_participantAddress"
                                     SigningWalletAddress="@_signingWallet"
                                     OnSubmit="HandleFormSubmit"
                                     OnReject="HandleReject"
                                     OnCancel="HandleCancel" />
        </MudStack>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public PendingActionViewModel Action { get; set; } = new();

    [Parameter]
    public string WalletAddress { get; set; } = string.Empty;

    private Sorcha.Blueprint.Models.Action _blueprintAction = new();
    private string _participantAddress = string.Empty;
    private string _signingWallet = string.Empty;

    protected override void OnParametersSet()
    {
        // Map PendingActionViewModel to blueprint Action
        _blueprintAction = new Sorcha.Blueprint.Models.Action
        {
            Id = int.TryParse(Action.ActionId, out var id) ? id : 0,
            Title = Action.ActionName,
            Description = Action.Description
        };

        // Map DataSchema if present
        if (Action.DataSchema.HasValue)
        {
            var schemaJson = Action.DataSchema.Value.GetRawText();
            _blueprintAction.DataSchemas = [JsonDocument.Parse(schemaJson)];
        }

        // Wire wallet address for signing
        if (!string.IsNullOrEmpty(WalletAddress))
        {
            _signingWallet = WalletAddress;
            _participantAddress = WalletAddress;
        }
    }

    private Task HandleFormSubmit(FormSubmission submission)
    {
        var submissionVm = new ActionSubmissionViewModel
        {
            ActionId = Action.ActionId,
            InstanceId = Action.InstanceId,
            Data = submission.Data.ToDictionary(
                kvp => kvp.Key.TrimStart('/'),
                kvp => kvp.Value ?? (object)string.Empty)
        };

        MudDialog?.Close(DialogResult.Ok(submissionVm));
        return Task.CompletedTask;
    }

    private Task HandleReject(string reason)
    {
        MudDialog?.Close(DialogResult.Ok("reject"));
        return Task.CompletedTask;
    }

    private Task HandleCancel()
    {
        MudDialog?.Cancel();
        return Task.CompletedTask;
    }
}
