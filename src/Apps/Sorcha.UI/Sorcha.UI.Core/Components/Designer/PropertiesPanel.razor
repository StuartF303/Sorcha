@using MudBlazor
@using Sorcha.UI.Core.Models.Designer
@using Sorcha.Blueprint.Models
@using System.Text.Json.Nodes
@using BlueprintAction = Sorcha.Blueprint.Models.Action

<div class="properties-panel">
    <div class="properties-panel-header">
        <div class="d-flex align-center justify-space-between" style="width: 100%;">
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@(SelectedNode != null ? Icons.Material.Filled.PlayArrow : Icons.Material.Filled.Description)" Size="Size.Small" Class="mr-2" />
                @(SelectedNode != null && SelectedNode is ActionNodeModel actionModel ? $"Action {actionModel.Action.Id} Properties" : "Blueprint Properties")
            </MudText>
            <div>
                <MudIconButton Icon="@Icons.Material.Filled.Save"
                               Color="Color.Success"
                               Size="Size.Small"
                               OnClick="SaveChanges"
                               title="Save changes" />
                <MudIconButton Icon="@Icons.Material.Filled.Close"
                               Color="Color.Default"
                               Size="Size.Small"
                               OnClick="DiscardChanges"
                               title="@(SelectedNode != null ? "Close and return to Blueprint" : "Discard changes")" />
            </div>
        </div>
    </div>

    <div class="properties-panel-content">
        @if (SelectedNode != null && SelectedNode is ActionNodeModel actionNode)
        {
            <!-- Basic Information -->
            <MudText Typo="Typo.subtitle1" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-2" />
                Basic Information
            </MudText>

            <MudTextField @bind-Value="editedAction.Title"
                         Label="Title"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Class="mb-3" />

            <MudTextField @bind-Value="editedAction.Description"
                         Label="Description"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Lines="3"
                         Class="mb-3" />

            <MudTextField @bind-Value="editedAction.Sender"
                         Label="Sender Address"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Class="mb-3"
                         HelperText="Address of the sender (participant)" />

            <MudDivider Class="my-4" />

            <!-- Expandable Sections -->
            <MudExpansionPanels MultiExpansion="true" Class="mb-3">
                <!-- Participants Section -->
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" Size="Size.Small" />
                            <MudText>Participants</MudText>
                            @if (Blueprint?.Participants != null)
                            {
                                <MudChip T="string" Size="Size.Small" Class="ml-2">@Blueprint.Participants.Count</MudChip>
                            }
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                            Manage blueprint participants with roles, wallet addresses, and metadata
                        </MudText>

                        <div class="d-flex justify-end mb-3">
                            <MudButton StartIcon="@Icons.Material.Filled.PersonAdd"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       Variant="Variant.Filled"
                                       OnClick="OpenAddParticipantDialog">
                                Add Participant
                            </MudButton>
                        </div>

                        @if (Blueprint != null && Blueprint.Participants.Any())
                        {
                            <MudList T="Participant" Dense="true" Class="pa-0">
                                @foreach (var participant in Blueprint.Participants)
                                {
                                    <MudListItem T="Participant" Class="pa-0 mb-1">
                                        <MudPaper Class="pa-2" Outlined="true" Style="width: 100%;">
                                            <div class="d-flex align-center justify-space-between">
                                                <div class="d-flex align-center" style="flex: 1; min-width: 0;">
                                                    <MudAvatar Color="@GetParticipantRoleColor(participant)" Size="Size.Small" Class="mr-2">
                                                        <MudIcon Icon="@GetParticipantRoleIcon(participant)" Size="Size.Small" />
                                                    </MudAvatar>
                                                    <div style="flex: 1; min-width: 0;">
                                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                                            @participant.Name
                                                        </MudText>
                                                        @if (!string.IsNullOrWhiteSpace(participant.Organisation))
                                                        {
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                                @participant.Organisation
                                                            </MudText>
                                                        }
                                                    </div>
                                                </div>
                                                <div class="d-flex align-center gap-1">
                                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                                   Size="Size.Small"
                                                                   Color="Color.Default"
                                                                   OnClick="@(() => OpenEditParticipantDialog(participant))" />
                                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                                   Size="Size.Small"
                                                                   Color="Color.Error"
                                                                   OnClick="@(() => DeleteParticipant(participant))" />
                                                </div>
                                            </div>
                                        </MudPaper>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Dense="true">
                                No participants defined. Click "Add Participant" to add participants to this blueprint.
                            </MudAlert>
                        }
                    </ChildContent>
                </MudExpansionPanel>

                <!-- Routing Condition Section -->
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.AccountTree" Class="mr-2" Size="Size.Small" />
                            <MudText>Routing Condition</MudText>
                            @if (editedAction.Condition != null)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" Class="ml-2" />
                            }
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                            Build routing conditions to determine the next action in the workflow
                        </MudText>

                        <div class="d-flex justify-end mb-3">
                            <MudButton StartIcon="@Icons.Material.Filled.Edit"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       Variant="Variant.Filled"
                                       OnClick="OpenConditionEditorDialog">
                                @(editedAction.Condition != null ? "Edit Condition" : "Add Condition")
                            </MudButton>
                        </div>

                        @if (editedAction.Condition != null)
                        {
                            <MudTextField Value="@editedAction.Condition.ToJsonString()"
                                          Label="Current Condition (JSON Logic)"
                                          Variant="Variant.Outlined"
                                          Lines="5"
                                          ReadOnly="true" />
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Dense="true">
                                No routing condition defined. Click "Add Condition" to create workflow routing logic.
                            </MudAlert>
                        }
                    </ChildContent>
                </MudExpansionPanel>

                <!-- Calculations Section -->
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Calculate" Class="mr-2" Size="Size.Small" />
                            <MudText>Calculations</MudText>
                            @if (editedAction.Calculations != null)
                            {
                                <MudChip T="string" Size="Size.Small" Class="ml-2">@editedAction.Calculations.Count</MudChip>
                            }
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                            Build calculated field expressions using a visual expression builder
                        </MudText>

                        <div class="d-flex justify-end mb-3">
                            <MudButton StartIcon="@Icons.Material.Filled.Add"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       Variant="Variant.Filled"
                                       OnClick="OpenAddCalculationDialog">
                                Add Calculation
                            </MudButton>
                        </div>

                        @if (editedAction.Calculations != null && editedAction.Calculations.Any())
                        {
                            @foreach (var calc in editedAction.Calculations)
                            {
                                var calcKey = calc.Key;
                                var calcValue = calc.Value;
                                <MudPaper Class="pa-3 mb-2" Outlined="true">
                                    <div class="d-flex align-center justify-space-between mb-2">
                                        <MudText Typo="Typo.subtitle2">@calcKey</MudText>
                                        <div class="d-flex align-center gap-1">
                                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                           Size="Size.Small"
                                                           Color="Color.Default"
                                                           OnClick="@(() => OpenEditCalculationDialog(calcKey, calcValue))" />
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                           Size="Size.Small"
                                                           Color="Color.Error"
                                                           OnClick="@(() => DeleteCalculation(calcKey))" />
                                        </div>
                                    </div>
                                    <MudTextField Value="@(calcValue?.ToJsonString() ?? "{}")"
                                                  Variant="Variant.Outlined"
                                                  Lines="2"
                                                  Margin="Margin.Dense"
                                                  ReadOnly="true"
                                                  Style="font-family: monospace;" />
                                </MudPaper>
                            }
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Dense="true">
                                No calculations defined. Click "Add Calculation" to create computed fields.
                            </MudAlert>
                        }
                    </ChildContent>
                </MudExpansionPanel>

                <!-- Data Schemas Section -->
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Schema" Class="mr-2" Size="Size.Small" />
                            <MudText>Data Schemas</MudText>
                            @if (editedAction.DataSchemas != null)
                            {
                                <MudChip T="string" Size="Size.Small" Class="ml-2">@editedAction.DataSchemas.Count()</MudChip>
                            }
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                            Reference data schemas from the blueprint's global schema list
                        </MudText>

                        @if (Blueprint != null && Blueprint.DataSchemas != null && Blueprint.DataSchemas.Any())
                        {
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Available Schemas (@Blueprint.DataSchemas.Count)</MudText>
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                                @Blueprint.DataSchemas.Count schema(s) defined in blueprint. Configure in Blueprint Properties -> Data Schemas tab.
                            </MudAlert>

                            <MudDivider Class="my-3" />

                            <MudText Typo="Typo.subtitle2" Class="mb-2">Action Data Schemas</MudText>
                            @if (editedAction.DataSchemas != null && editedAction.DataSchemas.Any())
                            {
                                <MudAlert Severity="Severity.Success" Dense="true">
                                    This action uses @editedAction.DataSchemas.Count() schema(s)
                                </MudAlert>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Dense="true">
                                    No data schemas assigned to this action
                                </MudAlert>
                            }
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Warning" Dense="true">
                                No data schemas defined in blueprint. Go to Blueprint Properties -> Data Schemas tab to add schemas.
                            </MudAlert>
                        }
                    </ChildContent>
                </MudExpansionPanel>

                <!-- Disclosures Section -->
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Visibility" Class="mr-2" Size="Size.Small" />
                            <MudText>Disclosures</MudText>
                            @if (editedAction.Disclosures != null)
                            {
                                <MudChip T="string" Size="Size.Small" Class="ml-2">@editedAction.Disclosures.Count()</MudChip>
                            }
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                            Define which data fields are disclosed to which participants
                        </MudText>
                        @if (editedAction.Disclosures != null && editedAction.Disclosures.Any())
                        {
                            @foreach (var disclosure in editedAction.Disclosures.Select((d, i) => new { Disclosure = d, Index = i }))
                            {
                                <MudPaper Class="pa-3 mb-2" Outlined="true">
                                    <MudTextField @bind-Value="@disclosure.Disclosure.ParticipantAddress"
                                                  Label="Participant Address"
                                                  Variant="Variant.Outlined"
                                                  Class="mb-2"
                                                  Margin="Margin.Dense" />
                                    <MudText Typo="Typo.caption" Class="mb-1">Data Pointers</MudText>
                                    @foreach (var pointer in disclosure.Disclosure.DataPointers)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="mb-1 mr-1">
                                            @pointer
                                        </MudChip>
                                    }
                                </MudPaper>
                            }
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Dense="true">No disclosures defined</MudAlert>
                        }
                    </ChildContent>
                </MudExpansionPanel>

                <!-- Advanced Settings -->
                <MudExpansionPanel>
                    <TitleContent>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" Size="Size.Small" />
                            <MudText>Advanced Settings</MudText>
                        </div>
                    </TitleContent>
                    <ChildContent>
                        <MudTextField @bind-Value="editedAction.BlueprintId"
                                      Label="Blueprint ID"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      ReadOnly="true"
                                      Class="mb-2" />

                        <MudDivider Class="my-2" />

                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Action ID: @editedAction.Id
                        </MudText>
                    </ChildContent>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }
        else
        {
            <!-- Blueprint Properties -->
            <MudTextField @bind-Value="editedBlueprint.Title"
                         Label="Title"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Class="mb-3" />

            <MudTextField @bind-Value="editedBlueprint.Description"
                         Label="Description"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Lines="3"
                         Class="mb-3" />

            <MudNumericField @bind-Value="editedBlueprint.Version"
                            Label="Version"
                            Variant="Variant.Outlined"
                            Margin="Margin.Dense"
                            Class="mb-3" />

            <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Metadata</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                ID: @editedBlueprint.Id
            </MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Created: @editedBlueprint.CreatedAt.ToString("yyyy-MM-dd HH:mm")
            </MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Updated: @editedBlueprint.UpdatedAt.ToString("yyyy-MM-dd HH:mm")
            </MudText>

            <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Statistics</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Participants: @editedBlueprint.Participants.Count
            </MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Actions: @editedBlueprint.Actions.Count
            </MudText>
        }
    </div>
</div>

<style>
    .properties-panel {
        width: 350px;
        height: 100%;
        background: white;
        border-left: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .properties-panel-header {
        padding: 16px;
        border-bottom: 1px solid #e0e0e0;
        background: #f5f5f5;
    }

    .properties-panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }
</style>

@code {
    [Inject]
    private IDialogService DialogService { get; set; } = null!;

    [Inject]
    private ISnackbar Snackbar { get; set; } = null!;

    [Parameter]
    public Blueprint Blueprint { get; set; } = new();

    [Parameter]
    public BlueprintNodeModel? SelectedNode { get; set; }

    [Parameter]
    public EventCallback<Blueprint> OnBlueprintSaved { get; set; }

    [Parameter]
    public EventCallback<BlueprintAction> OnActionSaved { get; set; }

    [Parameter]
    public EventCallback OnDiscardChanges { get; set; }

    private Blueprint editedBlueprint = new();
    private BlueprintAction editedAction = new();

    protected override void OnParametersSet()
    {
        // Create copies for editing
        if (SelectedNode != null && SelectedNode is ActionNodeModel actionNode)
        {
            // Deep copy the action
            editedAction = new BlueprintAction
            {
                Id = actionNode.Action.Id,
                Title = actionNode.Action.Title,
                Description = actionNode.Action.Description,
                Sender = actionNode.Action.Sender,
                Participants = actionNode.Action.Participants,
                DataSchemas = actionNode.Action.DataSchemas,
                Disclosures = actionNode.Action.Disclosures,
                Calculations = actionNode.Action.Calculations,
                Condition = actionNode.Action.Condition,
                RequiredActionData = actionNode.Action.RequiredActionData,
                BlueprintId = actionNode.Action.BlueprintId
            };
        }
        else
        {
            // Copy blueprint properties
            editedBlueprint = new Blueprint
            {
                Id = Blueprint.Id,
                Title = Blueprint.Title,
                Description = Blueprint.Description,
                Version = Blueprint.Version,
                CreatedAt = Blueprint.CreatedAt,
                UpdatedAt = Blueprint.UpdatedAt,
                Participants = Blueprint.Participants,
                Actions = Blueprint.Actions
            };
        }
    }

    private async Task SaveChanges()
    {
        if (SelectedNode != null && SelectedNode is ActionNodeModel)
        {
            await OnActionSaved.InvokeAsync(editedAction);
        }
        else
        {
            editedBlueprint.UpdatedAt = DateTimeOffset.UtcNow;
            await OnBlueprintSaved.InvokeAsync(editedBlueprint);
        }
    }

    private async Task DiscardChanges()
    {
        await OnDiscardChanges.InvokeAsync();
    }

    #region Participant Editor Integration

    private async Task OpenAddParticipantDialog()
    {
        var model = new ParticipantModel();
        var existingNames = Blueprint.Participants.Select(p => p.Name).ToList();

        var parameters = new DialogParameters<ParticipantEditor>
        {
            { x => x.Model, model },
            { x => x.IsEditing, false },
            { x => x.ExistingParticipantNames, existingNames! }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ParticipantEditor>("Add Participant", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is ParticipantModel savedModel)
        {
            var participant = savedModel.ToParticipant();
            Blueprint.Participants.Add(participant);
            editedBlueprint.Participants = Blueprint.Participants;
            Snackbar.Add($"Participant '{participant.Name}' added", Severity.Success);
            StateHasChanged();
        }
    }

    private async Task OpenEditParticipantDialog(Participant participant)
    {
        var model = ParticipantModel.FromParticipant(participant);
        var existingNames = Blueprint.Participants
            .Where(p => p.Id != participant.Id)
            .Select(p => p.Name)
            .ToList();

        var parameters = new DialogParameters<ParticipantEditor>
        {
            { x => x.Model, model },
            { x => x.IsEditing, true },
            { x => x.ExistingParticipantNames, existingNames! }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ParticipantEditor>("Edit Participant", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is ParticipantModel savedModel)
        {
            var updatedParticipant = savedModel.ToParticipant();
            var index = Blueprint.Participants.FindIndex(p => p.Id == participant.Id);
            if (index >= 0)
            {
                Blueprint.Participants[index] = updatedParticipant;
                editedBlueprint.Participants = Blueprint.Participants;
                Snackbar.Add($"Participant '{updatedParticipant.Name}' updated", Severity.Success);
                StateHasChanged();
            }
        }
    }

    private async Task DeleteParticipant(Participant participant)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Delete Participant",
            $"Are you sure you want to delete participant '{participant.Name}'? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirm == true)
        {
            Blueprint.Participants.Remove(participant);
            editedBlueprint.Participants = Blueprint.Participants;
            Snackbar.Add($"Participant '{participant.Name}' deleted", Severity.Warning);
            StateHasChanged();
        }
    }

    private Color GetParticipantRoleColor(Participant participant)
    {
        var role = ParseParticipantRole(participant.Organisation);
        return role switch
        {
            ParticipantRole.Initiator => Color.Primary,
            ParticipantRole.Approver => Color.Success,
            ParticipantRole.Observer => Color.Info,
            ParticipantRole.Administrator => Color.Warning,
            _ => Color.Default
        };
    }

    private string GetParticipantRoleIcon(Participant participant)
    {
        var role = ParseParticipantRole(participant.Organisation);
        return role switch
        {
            ParticipantRole.Initiator => Icons.Material.Filled.PlayArrow,
            ParticipantRole.Approver => Icons.Material.Filled.CheckCircle,
            ParticipantRole.Observer => Icons.Material.Filled.Visibility,
            ParticipantRole.Administrator => Icons.Material.Filled.AdminPanelSettings,
            _ => Icons.Material.Filled.Person
        };
    }

    private ParticipantRole ParseParticipantRole(string? organisation)
    {
        if (string.IsNullOrEmpty(organisation)) return ParticipantRole.Member;
        return Enum.TryParse<ParticipantRole>(organisation, ignoreCase: true, out var r) ? r : ParticipantRole.Member;
    }

    #endregion

    #region Condition Editor Integration

    private async Task OpenConditionEditorDialog()
    {
        var model = editedAction.Condition != null
            ? ConditionModel.FromJsonLogic(editedAction.Condition)
            : new ConditionModel();

        var availableFields = GetAvailableFieldsForCondition();

        var parameters = new DialogParameters<ConditionEditor>
        {
            { x => x.Model, model },
            { x => x.Participants, Blueprint.Participants },
            { x => x.AvailableFields, availableFields }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ConditionEditor>("Condition Editor", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is ConditionModel savedModel)
        {
            editedAction.Condition = savedModel.ToJsonLogic();
            Snackbar.Add("Routing condition updated", Severity.Success);
            StateHasChanged();
        }
    }

    private List<string> GetAvailableFieldsForCondition()
    {
        // Extract field names from data schemas if available
        var fields = new List<string>();

        // Add data schema count info (JsonDocument doesn't expose field names easily)
        if (Blueprint?.DataSchemas != null && Blueprint.DataSchemas.Any())
        {
            for (var i = 0; i < Blueprint.DataSchemas.Count; i++)
            {
                fields.Add($"data.schema{i}");
            }
        }

        // Add common fields as fallback
        if (!fields.Any())
        {
            fields.AddRange([
                "amount", "status", "approved", "quantity",
                "total", "balance", "percentage", "rating",
                "category", "type", "name", "id"
            ]);
        }

        return fields;
    }

    #endregion

    #region Calculation Editor Integration

    private async Task OpenAddCalculationDialog()
    {
        var model = new CalculationModel();
        var availableFields = GetAvailableFieldsForCalculation();

        var parameters = new DialogParameters<CalculationEditor>
        {
            { x => x.Model, model },
            { x => x.AvailableFields, availableFields }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<CalculationEditor>("Add Calculation", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is CalculationModel savedModel)
        {
            var jsonLogic = savedModel.ToJsonLogic();
            if (jsonLogic != null && !string.IsNullOrWhiteSpace(savedModel.TargetFieldPath))
            {
                editedAction.Calculations ??= [];
                editedAction.Calculations[savedModel.TargetFieldPath] = jsonLogic;
                Snackbar.Add($"Calculation '{savedModel.TargetFieldPath}' added", Severity.Success);
                StateHasChanged();
            }
        }
    }

    private async Task OpenEditCalculationDialog(string fieldName, JsonNode existingLogic)
    {
        var model = CalculationModel.FromJsonLogic(existingLogic);
        model.TargetFieldPath = fieldName;
        var availableFields = GetAvailableFieldsForCalculation();

        var parameters = new DialogParameters<CalculationEditor>
        {
            { x => x.Model, model },
            { x => x.AvailableFields, availableFields }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<CalculationEditor>("Edit Calculation", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is CalculationModel savedModel)
        {
            var jsonLogic = savedModel.ToJsonLogic();
            if (jsonLogic != null && !string.IsNullOrWhiteSpace(savedModel.TargetFieldPath))
            {
                // Remove old key if field name changed
                if (fieldName != savedModel.TargetFieldPath)
                {
                    editedAction.Calculations?.Remove(fieldName);
                }

                editedAction.Calculations ??= [];
                editedAction.Calculations[savedModel.TargetFieldPath] = jsonLogic;
                Snackbar.Add($"Calculation '{savedModel.TargetFieldPath}' updated", Severity.Success);
                StateHasChanged();
            }
        }
    }

    private async Task DeleteCalculation(string fieldName)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Delete Calculation",
            $"Are you sure you want to delete the calculation '{fieldName}'? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirm == true && editedAction.Calculations != null)
        {
            editedAction.Calculations.Remove(fieldName);
            Snackbar.Add($"Calculation '{fieldName}' deleted", Severity.Warning);
            StateHasChanged();
        }
    }

    private List<string> GetAvailableFieldsForCalculation()
    {
        var fields = new List<string>();

        // Add existing calculation field names as potential references
        if (editedAction.Calculations != null)
        {
            fields.AddRange(editedAction.Calculations.Keys.Select(k => $"calculations.{k}"));
        }

        // Add data schema count info (JsonDocument doesn't expose field names easily)
        if (Blueprint?.DataSchemas != null && Blueprint.DataSchemas.Any())
        {
            // Add placeholder for schema fields
            for (var i = 0; i < Blueprint.DataSchemas.Count; i++)
            {
                fields.Add($"data.schema{i}");
            }
        }

        // Add common numeric fields as fallback
        if (!fields.Any())
        {
            fields.AddRange([
                "amount", "quantity", "price", "total",
                "subtotal", "discount", "tax", "balance",
                "percentage", "rate", "count"
            ]);
        }

        return fields;
    }

    #endregion
}
