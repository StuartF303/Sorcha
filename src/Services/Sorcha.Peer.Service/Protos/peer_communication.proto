// SPDX-License-Identifier: MIT
// Copyright (c) 2025 Sorcha Contributors

syntax = "proto3";

package sorcha.peer.communication;

option csharp_namespace = "Sorcha.Peer.Service.Protos";

// Peer Communication Service
// Enables direct peer-to-peer communication
service PeerCommunication {
  // Send a message to a peer
  rpc SendMessage(PeerMessage) returns (MessageAck);

  // Establish a bidirectional streaming connection
  rpc Stream(stream PeerMessage) returns (stream PeerMessage);
}

// Message sent between peers
message PeerMessage {
  string sender_peer_id = 1;
  string recipient_peer_id = 2;
  MessageType message_type = 3;
  bytes payload = 4;
  int64 timestamp = 5;
}

// Message acknowledgment
message MessageAck {
  bool received = 1;
  int64 timestamp = 2;
}

// Type of message
enum MessageType {
  UNKNOWN = 0;
  TRANSACTION_NOTIFICATION = 1;
  TRANSACTION_REQUEST = 2;
  TRANSACTION_RESPONSE = 3;
  PEER_STATUS_UPDATE = 4;
  HEARTBEAT = 5;
  BLS_KEY_SHARE_DISTRIBUTION = 6;
  BLS_PARTIAL_SIGNATURE = 7;
}

// BLS threshold key share distribution request
message BLSKeyShareDistribution {
  string register_id = 1;
  string sender_validator_id = 2;
  string recipient_validator_id = 3;
  uint32 share_index = 4;
  bytes encrypted_secret_share = 5;  // Encrypted with recipient's public key
  bytes public_share = 6;            // G2 point (96 bytes)
  bytes group_public_key = 7;        // G2 point (96 bytes)
  uint32 threshold = 8;
  uint32 total_signers = 9;
}

// BLS partial signature exchange during docket signing
message BLSPartialSignatureExchange {
  string register_id = 1;
  string docket_hash = 2;
  string validator_id = 3;
  uint32 share_index = 4;
  bytes partial_signature = 5;       // G1 point (48 bytes)
}
