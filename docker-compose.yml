# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Sorcha Contributors

# OpenTelemetry configuration for sending traces/metrics to Aspire Dashboard
# The OTLP endpoint points to the aspire-dashboard container's gRPC port
x-otel-env: &otel-env
  OTEL_EXPORTER_OTLP_ENDPOINT: http://aspire-dashboard:18889
  OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-sorcha-service}
  OTEL_RESOURCE_ATTRIBUTES: deployment.environment=docker

services:
  # ===========================
  # Infrastructure Services
  # ===========================

  redis:
    image: redis:8-alpine
    container_name: sorcha-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - sorcha-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  postgres:
    image: postgres:17-alpine
    container_name: sorcha-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: sorcha
      POSTGRES_PASSWORD: sorcha_dev_password
      POSTGRES_DB: sorcha
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - sorcha-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sorcha"]
      interval: 10s
      timeout: 3s
      retries: 5

  mongodb:
    image: mongo:8
    container_name: sorcha-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: sorcha
      MONGO_INITDB_ROOT_PASSWORD: sorcha_dev_password
    volumes:
      - mongodb-data:/data/db
    networks:
      - sorcha-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ===========================
  # Observability Services
  # ===========================

  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:9.0
    container_name: sorcha-aspire-dashboard
    restart: unless-stopped
    ports:
      - "18888:18888"  # Dashboard UI
      - "4317:18889"   # OTLP gRPC endpoint (mapped to external 4317)
      - "4318:18890"   # OTLP HTTP endpoint
    environment:
      - DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true
      - DASHBOARD__OTLP__AUTHMODE=Unsecured
    networks:
      - sorcha-network

  # ===========================
  # Application Services
  # ===========================

  blueprint-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Blueprint.Service/Dockerfile
    image: sorcha/blueprint-service:latest
    container_name: sorcha-blueprint-service
    restart: unless-stopped
    ports:
      - "5000:8080"
    environment:
      <<: *otel-env
      OTEL_SERVICE_NAME: blueprint-service
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__Redis: redis:6379
    depends_on:
      redis:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - sorcha-network
    # Note: Chiseled images don't include shell tools, so we disable container-level health checks
    # Health monitoring is handled via the /health endpoint externally or via orchestrator probes

  wallet-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Wallet.Service/Dockerfile
    image: sorcha/wallet-service:latest
    container_name: sorcha-wallet-service
    restart: unless-stopped
    ports:
      - "5001:8080"
    environment:
      <<: *otel-env
      OTEL_SERVICE_NAME: wallet-service
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__Redis: redis:6379
      ConnectionStrings__wallet-db: Host=postgres;Database=sorcha;Username=sorcha;Password=sorcha_dev_password
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - sorcha-network

  register-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Register.Service/Dockerfile
    image: sorcha/register-service:latest
    container_name: sorcha-register-service
    restart: unless-stopped
    ports:
      - "5290:8080"
    environment:
      <<: *otel-env
      OTEL_SERVICE_NAME: register-service
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__Redis: redis:6379
      ConnectionStrings__MongoDB: mongodb://sorcha:sorcha_dev_password@mongodb:27017
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - sorcha-network

  tenant-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Tenant.Service/Dockerfile
    image: sorcha/tenant-service:latest
    container_name: sorcha-tenant-service
    restart: unless-stopped
    ports:
      - "5110:8080"
    environment:
      <<: *otel-env
      OTEL_SERVICE_NAME: tenant-service
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__TenantDatabase: Host=postgres;Database=sorcha_tenant;Username=sorcha;Password=sorcha_dev_password
      Redis__ConnectionString: redis:6379
      # JWT signing key for token generation (base64-encoded 256-bit key)
      JwtSettings__SigningKey: c29yY2hhLWRldi1qd3Qtc2lnbmluZy1rZXktMjAyNS1taW4tMjU2LWJpdHM=
      JwtSettings__Issuer: http://tenant-service:8080
      JwtSettings__Audience__0: http://api-gateway:8080
      JwtSettings__SigningKeySource: Configuration
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - sorcha-network

  peer-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Peer.Service/Dockerfile
    image: sorcha/peer-service:latest
    container_name: sorcha-peer-service
    restart: unless-stopped
    ports:
      - "5002:8080"
    environment:
      <<: *otel-env
      OTEL_SERVICE_NAME: peer-service
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ASPNETCORE_HTTP_PORTS: "8080"
      ConnectionStrings__Redis: redis:6379
    depends_on:
      redis:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - sorcha-network

  api-gateway:
    build:
      context: .
      dockerfile: src/Services/Sorcha.ApiGateway/Dockerfile
    image: sorcha/api-gateway:latest
    container_name: sorcha-api-gateway
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      <<: *otel-env
      OTEL_SERVICE_NAME: api-gateway
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      Services__Blueprint__Url: http://blueprint-service:8080
      Services__Wallet__Url: http://wallet-service:8080
      Services__Register__Url: http://register-service:8080
      Services__Tenant__Url: http://tenant-service:8080
      Services__Peer__Url: http://peer-service:8080
      ConnectionStrings__Redis: redis:6379
      Dashboard__AspireDashboardUrl: http://localhost:18888
    depends_on:
      - blueprint-service
      - wallet-service
      - register-service
      - tenant-service
      - peer-service
      - aspire-dashboard
    networks:
      - sorcha-network

networks:
  sorcha-network:
    driver: bridge

volumes:
  redis-data:
  postgres-data:
  mongodb-data:
