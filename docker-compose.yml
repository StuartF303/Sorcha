# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Sorcha Contributors

# OpenTelemetry configuration for sending traces/metrics to Aspire Dashboard
# The OTLP endpoint points to the aspire-dashboard container's gRPC port
x-otel-env: &otel-env
  OTEL_EXPORTER_OTLP_ENDPOINT: http://aspire-dashboard:18889
  OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-sorcha-service}
  OTEL_RESOURCE_ATTRIBUTES: deployment.environment=docker

# Shared JWT configuration for all services
# The signing key is loaded from .env file or generated automatically
# For production: Replace with Azure Key Vault or other secure key management
x-jwt-env: &jwt-env
  JwtSettings__SigningKey: ${JWT_SIGNING_KEY:-c29yY2hhLWRvY2tlci1kZXYta2V5LTIwMjUtbWluLTI1Ni1iaXRzLXNlY3VyZQ==}
  JwtSettings__Issuer: http://tenant-service:8080
  JwtSettings__Audience: http://api-gateway:8080

services:
  # ===========================
  # Infrastructure Services
  # ===========================

  redis:
    image: redis:8-alpine
    container_name: sorcha-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - sorcha-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  postgres:
    image: postgres:17-alpine
    container_name: sorcha-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: sorcha
      POSTGRES_PASSWORD: sorcha_dev_password
      POSTGRES_DB: sorcha
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres-init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - sorcha-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sorcha"]
      interval: 5s
      timeout: 3s
      retries: 60
      start_period: 30s

  mongodb:
    image: mongo:8
    container_name: sorcha-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: sorcha
      MONGO_INITDB_ROOT_PASSWORD: sorcha_dev_password
    volumes:
      - mongodb-data:/data/db
    networks:
      - sorcha-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ===========================
  # Observability Services
  # ===========================

  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:9.0
    container_name: sorcha-aspire-dashboard
    restart: unless-stopped
    ports:
      - "18888:18888"  # Dashboard UI
      - "4317:18889"   # OTLP gRPC endpoint (mapped to external 4317)
      - "4318:18890"   # OTLP HTTP endpoint
    environment:
      - DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true
      - DASHBOARD__OTLP__AUTHMODE=Unsecured
    networks:
      - sorcha-network

  # ===========================
  # Application Services
  # ===========================

  blueprint-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Blueprint.Service/Dockerfile
    image: sorcha/blueprint-service:latest
    container_name: sorcha-blueprint-service
    restart: unless-stopped
    ports:
      - "5000:8080"
    environment:
      <<: [*otel-env, *jwt-env]
      OTEL_SERVICE_NAME: blueprint-service
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__Redis: redis:6379
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
    depends_on:
      redis:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - sorcha-network
    # Note: Chiseled images don't include shell tools, so we disable container-level health checks
    # Health monitoring is handled via the /health endpoint externally or via orchestrator probes

  wallet-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Wallet.Service/Dockerfile
    image: sorcha/wallet-service:latest
    container_name: sorcha-wallet-service
    restart: unless-stopped
    # No ports published - accessible directly on LAN IP 192.168.51.212
    environment:
      <<: [*otel-env, *jwt-env]
      OTEL_SERVICE_NAME: wallet-service
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__Redis: redis:6379
      ConnectionStrings__wallet-db: Host=postgres;Database=sorcha_wallet;Username=sorcha;Password=sorcha_dev_password;Timeout=30;Command Timeout=30
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      sorcha-network: {}
      sorcha-lan:
        ipv4_address: 192.168.51.212
    # Note: Chiseled images don't include shell tools for container-level health checks
    # Health monitoring handled via /health endpoint externally or orchestrator probes
    # Startup resilience provided by restart policy + postgres health check dependency

  register-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Register.Service/Dockerfile
    image: sorcha/register-service:latest
    container_name: sorcha-register-service
    restart: unless-stopped
    # No ports published - accessible directly on LAN IP 192.168.51.213
    environment:
      <<: [*otel-env, *jwt-env]
      OTEL_SERVICE_NAME: register-service
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__Redis: redis:6379
      ConnectionStrings__MongoDB: mongodb://sorcha:sorcha_dev_password@mongodb:27017
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      sorcha-network: {}
      sorcha-lan:
        ipv4_address: 192.168.51.213

  tenant-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Tenant.Service/Dockerfile
    image: sorcha/tenant-service:latest
    container_name: sorcha-tenant-service
    restart: unless-stopped
    # No ports published - accessible directly on LAN IP 192.168.51.211
    environment:
      <<: [*otel-env, *jwt-env]
      OTEL_SERVICE_NAME: tenant-service
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__TenantDatabase: Host=postgres;Database=sorcha_tenant;Username=sorcha;Password=sorcha_dev_password
      Redis__ConnectionString: redis:6379
      # Override JWT settings for tenant service (it issues tokens)
      JwtSettings__Audience__0: http://api-gateway:8080
      JwtSettings__SigningKeySource: Configuration
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      sorcha-network: {}
      sorcha-lan:
        ipv4_address: 192.168.51.211

  # Local Hub Node (Central Node for local development)
  peer-hub-local:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Peer.Service/Dockerfile
    image: sorcha/peer-service:latest
    container_name: sorcha-peer-hub-local
    restart: unless-stopped
    # No ports published - accessible directly on LAN IP 192.168.51.200
    environment:
      <<: *otel-env
      OTEL_SERVICE_NAME: peer-hub-local
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ASPNETCORE_HTTP_PORTS: "8080"
      ConnectionStrings__Redis: redis:6379
      MongoDB__ConnectionString: mongodb://sorcha:sorcha_dev_password@mongodb:27017
      MongoDB__DatabaseName: sorcha_system_register
      # Hub Node configuration
      PeerService__NodeId: "hub-local.sorcha.dev"
      PeerService__PublicAddress: "192.168.51.200"  # LAN IP address
      PeerService__Port: "5000"
      PeerService__EnableTls: "false"
      PeerService__CentralNode__IsCentralNode: "true"
      PeerService__CentralNode__ValidateHostname: "false"
      PeerService__CentralNode__Priority: "0"
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      sorcha-network: {}
      sorcha-lan:
        ipv4_address: 192.168.51.200

  # Regular Peer Node (connects to local hub)
  peer-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Peer.Service/Dockerfile
    image: sorcha/peer-service:latest
    container_name: sorcha-peer-service
    restart: unless-stopped
    # No ports published - accessible directly on LAN IP 192.168.51.201
    environment:
      <<: *otel-env
      OTEL_SERVICE_NAME: peer-service
      ASPNETCORE_ENVIRONMENT: MacVlan  # Use MacVlan environment for local hub config
      ASPNETCORE_URLS: http://+:8080
      ASPNETCORE_HTTP_PORTS: "8080"
      ConnectionStrings__Redis: redis:6379
      MongoDB__ConnectionString: mongodb://sorcha:sorcha_dev_password@mongodb:27017
      MongoDB__DatabaseName: sorcha_system_register
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
      - ./docker/appsettings.MacVlan.json:/app/appsettings.MacVlan.json:ro
    dns:
      - 8.8.8.8
      - 8.8.4.4
    depends_on:
      peer-hub-local:
        condition: service_started
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      sorcha-network: {}
      sorcha-lan:
        ipv4_address: 192.168.51.201
    # Enable external network access for STUN servers
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1

  validator-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Validator.Service/Dockerfile
    image: sorcha/validator-service:latest
    container_name: sorcha-validator-service
    restart: unless-stopped
    ports:
      - "5100:8080"        # HTTP REST API and health checks
      - "5101:8081"        # gRPC endpoint
    environment:
      <<: [*otel-env, *jwt-env]
      OTEL_SERVICE_NAME: validator-service
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ASPNETCORE_HTTP_PORTS: "8080"
      ConnectionStrings__Redis: redis:6379
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
    depends_on:
      redis:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - sorcha-network

  api-gateway:
    build:
      context: .
      dockerfile: src/Services/Sorcha.ApiGateway/Dockerfile
    image: sorcha/api-gateway:latest
    container_name: sorcha-api-gateway
    restart: unless-stopped
    # No ports published - accessible directly on LAN IP 192.168.51.210
    environment:
      <<: *otel-env
      OTEL_SERVICE_NAME: api-gateway
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      Services__Blueprint__Url: http://blueprint-service:8080
      Services__Wallet__Url: http://wallet-service:8080
      Services__Register__Url: http://register-service:8080
      Services__Tenant__Url: http://tenant-service:8080
      Services__Peer__Url: http://192.168.51.201:8080  # Use peer-service LAN IP
      Services__Validator__Url: http://validator-service:8080
      ConnectionStrings__Redis: redis:6379
      Dashboard__AspireDashboardUrl: http://localhost:18888
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
    depends_on:
      - blueprint-service
      - wallet-service
      - register-service
      - tenant-service
      - peer-service
      - validator-service
      - aspire-dashboard
    networks:
      sorcha-network: {}
      sorcha-lan:
        ipv4_address: 192.168.51.210

networks:
  # Bridge network for internal services (redis, postgres, mongodb, aspire-dashboard)
  sorcha-network:
    driver: bridge

  # macvlan network for public-facing services with LAN IP addresses
  # This allows containers to have their own IPs on the local network (192.168.51.x)
  # Perfect for P2P networking, NAT traversal, and external accessibility
  # NOTE: Create this network manually before running docker-compose:
  #   docker network create --driver macvlan --subnet=192.168.51.0/24 --gateway=192.168.51.1 --ip-range=192.168.51.192/28 -o parent=eth0 sorcha_sorcha-lan
  sorcha-lan:
    external: true
    name: sorcha_sorcha-lan

volumes:
  redis-data:
  postgres-data:
  mongodb-data:
  dataprotection-keys:
