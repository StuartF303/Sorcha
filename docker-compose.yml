# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Sorcha Contributors

# OpenTelemetry configuration for sending traces/metrics to Aspire Dashboard
# The OTLP endpoint points to the aspire-dashboard container's gRPC port
x-otel-env: &otel-env
  OTEL_EXPORTER_OTLP_ENDPOINT: http://aspire-dashboard:18889
  OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-sorcha-service}
  OTEL_RESOURCE_ATTRIBUTES: deployment.environment=docker

# Shared JWT configuration for all services
# Installation name is used to derive issuer and audience automatically
# The tenant service is the JWT authority - it issues tokens with the installation name
# All other services validate tokens against this same installation name
# The signing key is loaded from .env file or generated automatically
# For production: Replace with Azure Key Vault or other secure key management
x-jwt-env: &jwt-env
  JwtSettings__InstallationName: ${INSTALLATION_NAME:-localhost}
  JwtSettings__SigningKey: ${JWT_SIGNING_KEY:-c29yY2hhLWRvY2tlci1kZXYta2V5LTIwMjUtbWluLTI1Ni1iaXRzLXNlY3VyZQ==}

services:
  # ===========================
  # Infrastructure Services
  # ===========================

  redis:
    image: redis:8-alpine
    container_name: sorcha-redis
    restart: unless-stopped
    ports:
      - "16379:6379"
    volumes:
      - redis-data:/data
    networks:
      - sorcha-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  postgres:
    image: postgres:17-alpine
    container_name: sorcha-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: sorcha
      POSTGRES_PASSWORD: sorcha_dev_password
      POSTGRES_DB: sorcha
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres-init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    networks:
      - sorcha-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sorcha"]
      interval: 5s
      timeout: 3s
      retries: 60
      start_period: 30s

  mongodb:
    image: mongo:8
    container_name: sorcha-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: sorcha
      MONGO_INITDB_ROOT_PASSWORD: sorcha_dev_password
    volumes:
      - mongodb-data:/data/db
    networks:
      - sorcha-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ===========================
  # Observability Services
  # ===========================

  aspire-dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:9.0
    container_name: sorcha-aspire-dashboard
    restart: unless-stopped
    ports:
      - "18888:18888"  # Dashboard UI
      - "4317:18889"   # OTLP gRPC endpoint (mapped to external 4317)
      - "4318:18890"   # OTLP HTTP endpoint
    environment:
      - DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true
      - DASHBOARD__OTLP__AUTHMODE=Unsecured
    networks:
      - sorcha-network

  # ===========================
  # Application Services
  # ===========================

  blueprint-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Blueprint.Service/Dockerfile
    image: sorcha/blueprint-service:latest
    container_name: sorcha-blueprint-service
    restart: unless-stopped
    ports:
      - "5000:8080"
    environment:
      <<: [*otel-env, *jwt-env]
      OTEL_SERVICE_NAME: blueprint-service
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__Redis: redis:6379
      # Service client configuration for inter-service communication
      ServiceClients__RegisterService__Address: http://register-service:8080
      ServiceClients__WalletService__Address: http://wallet-service:8080
      ServiceClients__ValidatorService__Address: http://validator-service:8080
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
    depends_on:
      redis:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - sorcha-network
    # Note: Chiseled images don't include shell tools, so we disable container-level health checks
    # Health monitoring is handled via the /health endpoint externally or via orchestrator probes

  wallet-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Wallet.Service/Dockerfile
    image: sorcha/wallet-service:latest
    container_name: sorcha-wallet-service
    restart: unless-stopped
    # No ports published - internal service only, accessed via API Gateway
    environment:
      <<: [*otel-env, *jwt-env]
      OTEL_SERVICE_NAME: wallet-service
      ASPNETCORE_ENVIRONMENT: Docker
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__Redis: redis:6379
      ConnectionStrings__wallet-db: Host=postgres;Database=sorcha_wallet;Username=sorcha;Password=sorcha_dev_password;Timeout=30;Command Timeout=30
      # Encryption Provider Configuration
      # LinuxSecretService with fallback to file-based key storage (Docker doesn't have D-Bus)
      EncryptionProvider__Type: LinuxSecretService
      EncryptionProvider__DefaultKeyId: wallet-master-key-2025
      EncryptionProvider__LinuxSecretService__ServiceName: sorcha-wallet-service
      EncryptionProvider__LinuxSecretService__FallbackKeyStorePath: /var/lib/sorcha/wallet-keys
      # Stable key material prevents KEK changes when /etc/machine-id is regenerated on container rebuild
      EncryptionProvider__LinuxSecretService__MachineKeyMaterial: sorcha-docker-wallet-stable-key-v1
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
      - wallet-encryption-keys:/var/lib/sorcha/wallet-keys
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - sorcha-network
    # Note: Chiseled images don't include shell tools for container-level health checks
    # Health monitoring handled via /health endpoint externally or orchestrator probes
    # Startup resilience provided by restart policy + postgres health check dependency

  register-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Register.Service/Dockerfile
    image: sorcha/register-service:latest
    container_name: sorcha-register-service
    restart: unless-stopped
    ports:
      - "5380:8080"  # Exposed for walkthrough testing (5290 is in Windows excluded range)
    environment:
      <<: [*otel-env, *jwt-env]
      OTEL_SERVICE_NAME: register-service
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__Redis: redis:6379
      ConnectionStrings__MongoDB: mongodb://sorcha:sorcha_dev_password@mongodb:27017
      # Configure MongoDB storage with per-register databases (production-ready persistence)
      RegisterStorage__Type: MongoDB
      RegisterStorage__MongoDB__ConnectionString: mongodb://sorcha:sorcha_dev_password@mongodb:27017
      RegisterStorage__MongoDB__DatabaseName: sorcha_register_registry
      RegisterStorage__MongoDB__DatabaseNamePrefix: sorcha_register_
      RegisterStorage__MongoDB__UseDatabasePerRegister: "true"
      RegisterStorage__MongoDB__RegisterCollectionName: registers
      RegisterStorage__MongoDB__TransactionCollectionName: transactions
      RegisterStorage__MongoDB__DocketCollectionName: dockets
      RegisterStorage__MongoDB__CreateIndexesOnStartup: "true"
      ServiceClients__WalletService__Address: http://sorcha-wallet-service:8080
      ServiceClients__WalletService__UseGrpc: "false"
      ServiceClients__ValidatorService__Address: http://sorcha-validator-service:8080
      ServiceClients__ValidatorService__UseGrpc: "false"
      # Service-to-service auth for Wallet Service calls
      ServiceAuth__ClientId: register-service
      ServiceAuth__ClientSecret: register-service-secret
      ServiceClients__TenantService__Address: http://tenant-service:8080
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - sorcha-network

  tenant-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Tenant.Service/Dockerfile
    image: sorcha/tenant-service:latest
    container_name: sorcha-tenant-service
    restart: unless-stopped
    ports:
      - "5450:8080"  # Exposed for direct access during development/bootstrap (5110 is in Windows excluded range)
    environment:
      <<: [*otel-env, *jwt-env]
      OTEL_SERVICE_NAME: tenant-service
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__TenantDatabase: Host=postgres;Database=sorcha_tenant;Username=sorcha;Password=sorcha_dev_password
      Redis__ConnectionString: redis:6379
      # Tenant service is the JWT authority - it issues tokens using the installation name
      JwtSettings__SigningKeySource: Configuration
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - sorcha-network

  # Local Hub Node (Hub for local development)
  peer-hub-local:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Peer.Service/Dockerfile
    image: sorcha/peer-service:latest
    container_name: sorcha-peer-hub-local
    restart: unless-stopped
    ports:
      - "50051:5000"  # gRPC for external P2P connections
    environment:
      <<: *otel-env
      OTEL_SERVICE_NAME: peer-hub-local
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ASPNETCORE_HTTP_PORTS: "8080"
      ConnectionStrings__Redis: redis:6379
      MongoDB__ConnectionString: mongodb://sorcha:sorcha_dev_password@mongodb:27017
      MongoDB__DatabaseName: sorcha_system_register
      # Hub Node configuration
      PeerService__NodeId: "hub-local.sorcha.dev"
      PeerService__PublicAddress: ""  # Auto-detect or set via env var
      PeerService__Port: "5000"
      PeerService__EnableTls: "false"
      PeerService__HubNode__IsHubNode: "true"
      PeerService__HubNode__ValidateHostname: "false"
      PeerService__HubNode__Priority: "0"
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - sorcha-network

  # Regular Peer Node (connects to local hub)
  peer-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Peer.Service/Dockerfile
    image: sorcha/peer-service:latest
    container_name: sorcha-peer-service
    restart: unless-stopped
    ports:
      - "50052:5000"  # gRPC for external P2P connections
    environment:
      <<: *otel-env
      OTEL_SERVICE_NAME: peer-service
      ASPNETCORE_ENVIRONMENT: Bridge  # Use Bridge environment for Docker DNS config
      ASPNETCORE_URLS: http://+:8080
      ASPNETCORE_HTTP_PORTS: "8080"
      ConnectionStrings__Redis: redis:6379
      MongoDB__ConnectionString: mongodb://sorcha:sorcha_dev_password@mongodb:27017
      MongoDB__DatabaseName: sorcha_system_register
      # Override hub configuration to use Docker DNS instead of IP/Azure
      PeerService__HubNode__HubNodes__0__NodeId: "hub-local.sorcha.dev"
      PeerService__HubNode__HubNodes__0__Hostname: "peer-hub-local"
      PeerService__HubNode__HubNodes__0__Port: "5000"
      PeerService__HubNode__HubNodes__0__Priority: "0"
      PeerService__HubNode__HubNodes__0__EnableTls: "false"
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
      - ./docker/appsettings.Bridge.json:/app/appsettings.Bridge.json:ro
    depends_on:
      peer-hub-local:
        condition: service_started
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - sorcha-network

  validator-service:
    build:
      context: .
      dockerfile: src/Services/Sorcha.Validator.Service/Dockerfile
    image: sorcha/validator-service:latest
    container_name: sorcha-validator-service
    restart: unless-stopped
    ports:
      - "5800:8080"        # HTTP REST API and health checks (5100/5460 in Windows excluded ranges)
      - "5801:8081"        # gRPC endpoint
    environment:
      <<: [*otel-env, *jwt-env]
      OTEL_SERVICE_NAME: validator-service
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ASPNETCORE_HTTP_PORTS: "8080"
      ConnectionStrings__Redis: redis:6379
      # Service-to-service auth for Wallet Service calls
      ServiceAuth__ClientId: validator-service
      ServiceAuth__ClientSecret: validator-service-secret
      # Validator configuration
      Validator__ValidatorId: docker-validator-1
      # SystemWalletAddress left empty - wallet created automatically on startup
      Validator__SystemWalletAddress: ""
      # Service client configuration for inter-service communication
      ServiceClients__WalletService__Address: http://wallet-service:8080
      ServiceClients__TenantService__Address: http://tenant-service:8080
      ServiceClients__RegisterService__Address: http://sorcha-register-service:8080
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
    depends_on:
      redis:
        condition: service_healthy
      aspire-dashboard:
        condition: service_started
    networks:
      - sorcha-network

  sorcha-ui-web:
    build:
      context: .
      dockerfile: src/Apps/Sorcha.UI/Sorcha.UI.Web/Dockerfile
    image: sorcha/ui-web:latest
    container_name: sorcha-ui-web
    restart: unless-stopped
    ports:
      - "5400:8080"  # HTTP - Map to localhost:5400 (5173 is in Windows excluded range)
      - "5401:8443"  # HTTPS - Map to localhost:5401
    environment:
      <<: [*otel-env, *jwt-env]
      OTEL_SERVICE_NAME: ui-web
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      # HTTPS disabled for Docker development - use HTTP only
      # ASPNETCORE_HTTPS_PORTS: 8443
      # ASPNETCORE_Kestrel__Certificates__Default__Password: SorchaDevCert2025!
      # ASPNETCORE_Kestrel__Certificates__Default__Path: /https/sorcha-ui-web.pfx
      # API Gateway configuration for backend API calls
      ApiGateway__BaseUrl: http://api-gateway:8080
      # Aspire service discovery (alternative)
      services__api-gateway__http__0: http://api-gateway:8080
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
      - ./docker/certs:/https:ro
    depends_on:
      - aspire-dashboard
    networks:
      - sorcha-network

  api-gateway:
    build:
      context: .
      dockerfile: src/Services/Sorcha.ApiGateway/Dockerfile
    image: sorcha/api-gateway:latest
    container_name: sorcha-api-gateway
    restart: unless-stopped
    ports:
      - "80:8080"      # HTTP ingress
      - "443:8443"     # HTTPS ingress (requires certificate)
    environment:
      <<: [*otel-env, *jwt-env]
      OTEL_SERVICE_NAME: api-gateway
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080;https://+:8443
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/aspnetapp.pfx
      ASPNETCORE_Kestrel__Certificates__Default__Password: SorchaDev2025
      Services__Blueprint__Url: http://blueprint-service:8080
      Services__Wallet__Url: http://wallet-service:8080
      Services__Register__Url: http://register-service:8080
      Services__Tenant__Url: http://tenant-service:8080
      Services__Peer__Url: http://peer-service:8080  # Use Docker DNS
      Services__Validator__Url: http://validator-service:8080
      Services__UI__Url: http://sorcha-ui-web:8080
      ConnectionStrings__Redis: redis:6379
      Dashboard__AspireDashboardUrl: http://localhost:18888
    volumes:
      - dataprotection-keys:/home/app/.aspnet/DataProtection-Keys
      - ./docker/certs:/https:ro
    depends_on:
      - blueprint-service
      - wallet-service
      - register-service
      - tenant-service
      - peer-service
      - validator-service
      - sorcha-ui-web
      - aspire-dashboard
    networks:
      - sorcha-network

  # ===========================
  # Developer Tools
  # ===========================

  mcp-server:
    build:
      context: .
      dockerfile: src/Apps/Sorcha.McpServer/Dockerfile
    image: sorcha/mcp-server:latest
    container_name: sorcha-mcp-server
    profiles:
      - tools  # Only starts with --profile tools or docker-compose run
    environment:
      <<: *otel-env
      OTEL_SERVICE_NAME: mcp-server
      DOTNET_ENVIRONMENT: Development
      # Service client configuration for backend communication
      ServiceClients__BlueprintService__Address: http://blueprint-service:8080
      ServiceClients__WalletService__Address: http://wallet-service:8080
      ServiceClients__RegisterService__Address: http://register-service:8080
      ServiceClients__TenantService__Address: http://tenant-service:8080
      ServiceClients__ValidatorService__Address: http://validator-service:8080
      # JWT token can be provided via SORCHA_JWT_TOKEN environment variable or --jwt-token argument
      # Example: docker-compose run mcp-server --jwt-token <your-token>
    depends_on:
      - api-gateway
      - aspire-dashboard
    networks:
      - sorcha-network
    stdin_open: true  # Enable interactive stdin for MCP stdio transport
    tty: true         # Allocate a pseudo-TTY

networks:
  # Bridge network for all services
  # All containers communicate via Docker DNS (e.g., http://wallet-service:8080)
  # External access controlled via published ports on host
  sorcha-network:
    driver: bridge

volumes:
  redis-data:
  postgres-data:
  mongodb-data:
  dataprotection-keys:
  # Wallet encryption keys volume - stores encrypted Data Encryption Keys (DEKs)
  # IMPORTANT: On fresh installations, this volume is created with root ownership.
  # The wallet service runs as non-root (UID 1654) and will fail to write keys.
  # To fix permissions, run one of:
  #   - ./scripts/fix-wallet-encryption-permissions.ps1 (Windows)
  #   - ./scripts/fix-wallet-encryption-permissions.sh (Linux/macOS)
  #   - docker run --rm -v sorcha_wallet-encryption-keys:/data alpine chown -R 1654:1654 /data
  wallet-encryption-keys:
