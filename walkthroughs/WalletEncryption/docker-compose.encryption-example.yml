# Docker Compose configuration example for Wallet Service with encryption providers
# This file demonstrates how to configure persistent volumes for encryption key storage

version: '3.8'

services:
  # Wallet Service - Windows DPAPI Provider (Windows Containers)
  wallet-service-windows:
    image: sorcha-wallet-service:latest
    environment:
      - EncryptionProvider__Type=WindowsDpapi
      - EncryptionProvider__DefaultKeyId=wallet-key-2025
      - EncryptionProvider__WindowsDpapi__KeyStorePath=C:\\app\\keys
      - EncryptionProvider__WindowsDpapi__Scope=LocalMachine
    volumes:
      # Persistent volume for encrypted DEKs (Windows path)
      - wallet-encryption-keys-windows:C:\\app\\keys
    networks:
      - sorcha-network

  # Wallet Service - Linux Secret Service Provider (Linux Containers)
  wallet-service-linux:
    image: sorcha-wallet-service:latest
    environment:
      - EncryptionProvider__Type=LinuxSecretService
      - EncryptionProvider__DefaultKeyId=wallet-key-2025
      - EncryptionProvider__LinuxSecretService__ServiceName=sorcha-wallet-service
      - EncryptionProvider__LinuxSecretService__FallbackKeyStorePath=/var/lib/sorcha/wallet-keys
    volumes:
      # Persistent volume for fallback encrypted DEKs (Linux path)
      - wallet-encryption-keys-linux:/var/lib/sorcha/wallet-keys
    networks:
      - sorcha-network

  # Wallet Service - Azure Key Vault Provider (Cloud)
  wallet-service-azure:
    image: sorcha-wallet-service:latest
    environment:
      - EncryptionProvider__Type=AzureKeyVault
      - EncryptionProvider__DefaultKeyId=wallet-key-2025
      - EncryptionProvider__AzureKeyVault__VaultUri=https://your-vault.vault.azure.net/
      - EncryptionProvider__AzureKeyVault__DefaultKeyName=wallet-encryption-key
      - EncryptionProvider__AzureKeyVault__UseManagedIdentity=true
      - EncryptionProvider__AzureKeyVault__EnableDekCache=true
      - EncryptionProvider__AzureKeyVault__DekCacheTtlMinutes=60
      - EncryptionProvider__AzureKeyVault__AllowStaleDeksOnOutage=true
      # Azure Managed Identity configuration (automatically configured in Azure Container Instances/App Service)
      - AZURE_CLIENT_ID=<user-assigned-managed-identity-client-id>  # Optional: for UAMI
    networks:
      - sorcha-network

# Named volumes for persistent encryption key storage
volumes:
  # Windows DPAPI encrypted keys
  wallet-encryption-keys-windows:
    driver: local

  # Linux Secret Service fallback encrypted keys
  wallet-encryption-keys-linux:
    driver: local

networks:
  sorcha-network:
    driver: bridge

# Notes:
#
# 1. WINDOWS DPAPI PROVIDER
#    - Requires Windows container host
#    - Keys encrypted with Windows DPAPI (LocalMachine scope)
#    - Volume: C:\app\keys (Windows path)
#    - Survives container restarts, but tied to Windows machine identity
#
# 2. LINUX SECRET SERVICE PROVIDER
#    - Requires Linux container host
#    - Prefers Secret Service (GNOME Keyring, KWallet) if available
#    - Falls back to file-based encryption with machine-derived keys
#    - Volume: /var/lib/sorcha/wallet-keys (Linux path)
#    - Survives container restarts, tied to machine-id in fallback mode
#
# 3. AZURE KEY VAULT PROVIDER
#    - Works on any platform (Windows, Linux, macOS)
#    - No persistent volume needed (keys stored in Azure Key Vault)
#    - Requires Azure Managed Identity or Azure CLI authentication
#    - Best for production cloud deployments
#
# 4. KEY ROTATION
#    - Update DefaultKeyId to rotate keys: wallet-key-2026, wallet-key-2027, etc.
#    - Old keys remain accessible for decryption (never delete old keys)
#    - New wallets automatically use new key
#
# 5. BACKUP RECOMMENDATIONS
#    - Windows DPAPI: Backup C:\app\keys volume + Windows machine certificate
#    - Linux: Backup /var/lib/sorcha/wallet-keys volume + /etc/machine-id
#    - Azure Key Vault: Enable Azure Key Vault soft-delete and purge protection
